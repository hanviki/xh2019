
--创建存储过程

create or replace procedure SP_bgt_apply_budget_adjust(p_adjustid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、从BGT_B_DEPT_MON_ADJUST/BGT_B_DEPT_MON_ADJUST_D更新到BGT_B_DEPT_MON_EXE/BGT_B_DEPT_MON_EXE_D
   2、从BGT_B_DEPT_YEAR_ADJUST/BGT_B_DEPT_YEAR_ADJUST_D更新到BGT_B_DEPT_YEAR_EXE/BGT_B_DEPT_YEAR_EXE_D
   3、修改BGT_B_DEPT_MON_ADJUST/BGT_B_DEPT_YEAR_ADJUST/BGT_B_BUDGET_ADJUST状态为归档
*/
begin
      --从BGT_B_DEPT_MON_ADJUST/BGT_B_DEPT_MON_ADJUST_D更新到BGT_B_DEPT_MON_EXE/BGT_B_DEPT_MON_EXE_D
      for config in(
                    select
                    t2.id,
                    t2.item_id,
                    t2.m_1_value  ,
                    t2.m_2_value  ,
                    t2.m_3_value  ,
                    t2.m_4_value  ,
                    t2.m_5_value  ,
                    t2.m_6_value  ,
                    t2.m_7_value  ,
                    t2.m_8_value  ,
                    t2.m_9_value  ,
                    t2.m_10_value ,
                    t2.m_11_value ,
                    t2.m_12_value, 
                    t.BUDGET_DEPT_ID,
                    t.BUDGET_CONTENTS_ID                                 
                    from  BGT_B_DEPT_MON_ADJUST t,BGT_B_BUDGET_ADJUST t1,BGT_B_DEPT_MON_ADJUST_D t2
                    where t.adjust_id = t1.id
                    and t2.base_id = t.id
                    and t1.id = p_adjustid
                  )
       loop  
                  /*dbms_output.put_line('update BGT_B_DEPT_MON_EXE_D t
                  set  t.m_1_value = '||config.m_1_value||'  ,
                  t.m_2_value = '||config.m_2_value||'  ,
                  t.m_3_value = '||config.m_3_value||'  ,
                  t.m_4_value = '||config.m_4_value||'  ,
                  t.m_5_value = '||config.m_5_value||'  ,
                  t.m_6_value = '||config.m_6_value||'  ,
                  t.m_7_value = '||config.m_7_value||'  ,
                  t.m_8_value = '||config.m_8_value||'  ,
                  t.m_9_value = '||config.m_9_value||'  ,
                  t.m_10_value = '||config.m_10_value||'  ,
                  t.m_11_value ='||config.m_11_value||'  ,
                  t.m_12_value ='||config.m_12_value||'  
                  where t.id = '''||config.id||'''
                  and t.item_id = '''||config.item_id||'''
                  ');*/
                  execute immediate 'update BGT_B_DEPT_MON_EXE_D t
                  set  t.m_1_value = '||config.m_1_value||'  ,
                  t.m_2_value = '||config.m_2_value||'  ,
                  t.m_3_value = '||config.m_3_value||'  ,
                  t.m_4_value = '||config.m_4_value||'  ,
                  t.m_5_value = '||config.m_5_value||'  ,
                  t.m_6_value = '||config.m_6_value||'  ,
                  t.m_7_value = '||config.m_7_value||'  ,
                  t.m_8_value = '||config.m_8_value||'  ,
                  t.m_9_value = '||config.m_9_value||'  ,
                  t.m_10_value = '||config.m_10_value||'  ,
                  t.m_11_value ='||config.m_11_value||'  ,
                  t.m_12_value ='||config.m_12_value||'  
                  where t.id = '''||config.id||'''
                  and t.item_id = '''||config.item_id||'''
                  ';
       end loop;   
      --从BGT_B_DEPT_YEAR_ADJUST/BGT_B_DEPT_YEAR_ADJUST_D更新到BGT_B_DEPT_YEAR_EXE/BGT_B_DEPT_YEAR_EXE_D
      for config in(
                    select
                    t2.id,
                    t2.item_id,
                    t2.item_value,
                    t.BUDGET_DEPT_ID,
                    t.BUDGET_CONTENTS_ID                                 
                    from  BGT_B_DEPT_YEAR_ADJUST t,BGT_B_BUDGET_ADJUST t1,
                    BGT_B_DEPT_YEAR_ADJUST_D t2
                    where t.adjust_id = t1.id
                    and t2.base_id = t.id
                    and t1.id = p_adjustid

                  )
       loop  
                   /*
                   dbms_output.put_line('update BGT_B_DEPT_YEAR_EXE_D t
                   set t.item_value ='||config.item_value||'                
                   where t.id = '''||config.id||'''
                   and t.item_id = '''||config.item_id||'''');*/
                   execute immediate 'update BGT_B_DEPT_YEAR_EXE_D t
                   set t.item_value ='||config.item_value||'                
                   where t.id = '''||config.id||'''
                   and t.item_id = '''||config.item_id||'''
                  ';
                  
       end loop; 
       --修改BGT_B_DEPT_MON_ADJUST/BGT_B_DEPT_YEAR_ADJUST/BGT_B_BUDGET_ADJUST状态为归档
       execute immediate 'update BGT_B_BUDGET_ADJUST set state = 4 where id = '''||p_adjustid||'''';
       execute immediate 'update BGT_B_DEPT_MON_ADJUST set state = 4 where adjust_id = '''||p_adjustid||'''';
       execute immediate 'update BGT_B_DEPT_YEAR_ADJUST set state = 4 where adjust_id = '''||p_adjustid||'''';
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_apply_budget_adjust;


create or replace procedure SP_bgt_Archive_ProjAdjustData(p_adjustid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
      1、将项目预算调整明细中修改的条目,更新对应的项目预算明细(变更类型,调整金额,重算可用金额)
      2、更新预算项目的属性(ADJUST_MONEY进行累加操作,重新计算AVAILABLE_MONEY)
      3、更新年度结转的属性(ADJUST_MONEY)
      4、更新年度结转明细的属性(ADJUST_MONEY)
      5、修改BGT_B_BUDGET_PROJ_ADJUST状态为归档
*/
begin
      --1、将项目预算调整明细中修改的条目,更新对应的项目预算明细(变更类型,调整金额,重算可用金额)
      for config in
         (
          select id,base_id,item_id,item_base_value,item_value,adjust_value
          from BGT_B_BUDGET_PROJ_ADJUST_D 
          where BASE_ID = p_adjustid
          
         )
       loop  
           execute immediate 'update BGT_B_BUDGET_PROJ_D t set t.ADJUST_TYPE_ID=''00310002'',
           t.ADJUST_MONEY = '||config.adjust_value||'
           where t.id ='''||config.item_id||'''';
           execute immediate 'update BGT_B_BUDGET_PROJ_D t set
           t.AVAILABLE_MONEY = t.REPLY_MONEY + t.ADJUST_MONEY - t.EXECUTED_MONEY
           where t.id ='''||config.item_id||'''';
       end loop;        
       --2、更新预算项目的属性(ADJUST_MONEY进行累加操作,重新计算AVAILABLE_MONEY)
       execute immediate 'update bgt_b_budget_proj  t
       set t.ADJUST_MONEY = (select sum(ADJUST_MONEY) from bgt_b_budget_proj_d where base_id = t.id)
       where t.id = (select PROJECT_ID from BGT_B_BUDGET_PROJ_ADJUST where id = '''||p_adjustid||''')';
       execute immediate 'update bgt_b_budget_proj  t
       set t.AVAILABLE_MONEY =t.REPLY_MONEY + t.ADJUST_MONEY - t.EXECUTED_MONEY
       where t.id = (select PROJECT_ID from BGT_B_BUDGET_PROJ_ADJUST where id = '''||p_adjustid||''')';
       --3、更新年度结转的属性(ADJUST_MONEY)
       execute immediate 'select id from BGT_B_BUDGET_PROJ_CO
       where PROJECT_ID =(select PROJECT_ID from BGT_B_BUDGET_PROJ_ADJUST where id = '''||p_adjustid||''')
       and IS_RECENTLY = ''1''' into V_NEW_GUID;--查询对应的年度结转
       execute immediate 'update BGT_B_BUDGET_PROJ_CO
       set ADJUST_MONEY =nvl(ADJUST_MONEY,0) + (select sum(adjust_value) from BGT_B_BUDGET_PROJ_ADJUST_D where BASE_ID ='''||p_adjustid||''')
       where id='''||V_NEW_GUID||'''';
       --4、更新年度结转明细的属性(ADJUST_MONEY)
        for config in
         (
          select id,base_id,item_id,item_base_value,item_value,adjust_value
          from BGT_B_BUDGET_PROJ_ADJUST_D 
          where BASE_ID = p_adjustid          
         )
       loop  
           execute immediate 'update BGT_B_BUDGET_PROJ_CO_D t
           set t.ADJUST_MONEY =  nvl(t.ADJUST_MONEY,0) + '||config.adjust_value||'
           where t.item_id ='''||config.item_id||'''
           and t.base_id ='''||V_NEW_GUID||'''';          
       end loop;              
       --5、修改BGT_B_BUDGET_PROJ_ADJUST状态为归档
       execute immediate 'update BGT_B_BUDGET_PROJ_ADJUST set state = 4 where id = '''||p_adjustid||'''';
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Archive_ProjAdjustData;


create or replace procedure SP_bgt_Archive_ProjCOData(p_coid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_BUDGET_YEAR char(36);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、创建新的项目年度结转记录,预算年度为下一年度,项目为当前项目,是否最新为是,
      年初预算(BUDGET_MONEY),等于当前项目的可用金额(AVAILABLE_MONEY) 
   2、更新当前记录的状态为归档,是否最新为否
*/  
begin   
       --获取当前记录中预算年的下一个预算年
       execute immediate 'select id from bgt_d_budget_year where 
       budget_year =(select to_char(TO_NUMBER(budget_year) +1) from bgt_d_budget_year
        where id = (select budget_year from BGT_B_BUDGET_PROJ_CO where id = '''||p_coid||''')
        )' into V_BUDGET_YEAR;
       --创建新的项目年度结转记录
       execute immediate 'insert into BGT_B_BUDGET_PROJ_CO(id,project_id,budget_year,budget_money,executed_money,state,IS_RECENTLY)
       select sys_guid(),t2.id,'''||V_BUDGET_YEAR||''',t2.AVAILABLE_MONEY,0,3,1 from
       BGT_B_BUDGET_PROJ_CO t, BGT_B_BUDGET_PROJ t2 
       where t.PROJECT_ID = t2.id
       and t.id = '''||p_coid||'''';
       --更新当前记录的状态为归档,是否最新为否
       execute immediate 'update BGT_B_BUDGET_PROJ_CO set state = 4,IS_RECENTLY =2 where id = '''||p_coid||'''';
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Archive_ProjCOData;

create or replace procedure SP_bgt_Archive_ProjExecuteData(p_executeid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、更新对应项目的发生数据
   2、更新对应项目年度结转的发生数据
   3、修改BGT_B_BUDGET_PROJ_EXE状态为归档
*/
begin
      
       --更新对应项目的发生数据
         --项目预算编制-已申领、已执行
       execute immediate 'update BGT_B_BUDGET_PROJ
       set APPLIED_MONEY = APPLIED_MONEY + (select APPLY_MONEY from BGT_B_BUDGET_PROJ_EXE where id = '''||p_executeid||'''),
       EXECUTED_MONEY =EXECUTED_MONEY + (select EXECUTE_MONEY from BGT_B_BUDGET_PROJ_EXE where id = '''||p_executeid||''')
       where id = (select PROJECT_ID from BGT_B_BUDGET_PROJ_EXE where id = '''||p_executeid||''')';
         --项目预算编制-可用
       execute immediate 'update BGT_B_BUDGET_PROJ
       set AVAILABLE_MONEY=REPLY_MONEY+ADJUST_MONEY-EXECUTED_MONEY
       where id = (select PROJECT_ID from BGT_B_BUDGET_PROJ_EXE where id = '''||p_executeid||''')';
       --更新对应项目年度结转的发生数据
          --项目预算年度结转
       execute immediate 'update BGT_B_BUDGET_PROJ_CO
       set EXECUTED_MONEY =EXECUTED_MONEY + (select EXECUTE_MONEY from BGT_B_BUDGET_PROJ_EXE where id = '''||p_executeid||''')
       where PROJECT_ID = (select PROJECT_ID from BGT_B_BUDGET_PROJ_EXE where id = '''||p_executeid||''')
       and IS_RECENTLY = ''1''';
         --从表 
       for config in
         (
          select id,BASE_ID,ITEM_ID,APPLY_MONEY,EXECUTE_MONEY 
          from BGT_B_BUDGET_PROJ_EXE_D 
          where BASE_ID = p_executeid
         )
       loop  
           --项目预算编制明细表-已申领、已执行 
           execute immediate 'update BGT_B_BUDGET_PROJ_D
           set APPLIED_MONEY = APPLIED_MONEY + '||config.APPLY_MONEY||',
           EXECUTED_MONEY =EXECUTED_MONEY + '||config.EXECUTE_MONEY||'
           where base_id = (select PROJECT_ID from BGT_B_BUDGET_PROJ_EXE where id = '''||p_executeid||''')
           and id = '''||config.item_id||''''; 
           --项目预算编制明细表-可用
           execute immediate 'update BGT_B_BUDGET_PROJ_D
           set AVAILABLE_MONEY=REPLY_MONEY-EXECUTED_MONEY           
           where base_id = (select PROJECT_ID from BGT_B_BUDGET_PROJ_EXE where id = '''||p_executeid||''')
           and id = '''||config.item_id||'''';
           --项目预算年度结转从表-本年发生
           execute immediate 'update BGT_B_BUDGET_PROJ_CO_D
           set EXECUTED_MONEY = EXECUTED_MONEY + '||config.execute_money||'
           where base_id = (select id from BGT_B_BUDGET_PROJ_CO where PROJECT_ID = (select PROJECT_ID from BGT_B_BUDGET_PROJ_EXE where id = '''||p_executeid||''')
                 and IS_RECENTLY = ''1'')
           and ITEM_ID = '''||config.item_id||'''';
       end loop;        
       --修改BGT_B_BUDGET_PROJ_EXE状态为归档
       execute immediate 'update BGT_B_BUDGET_PROJ_EXE set state = 4 where id = '''||p_executeid||'''';
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Archive_ProjExecuteData;


create or replace procedure SP_bgt_Cal_cpn_plan_year(p_planid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_YEAR char(36);
V_BUDGET_CPN_ID char(36);
V_BUDGET_TEMPLET_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
v_PATTERN char(36);
V_LEVEL char(36);
/*
1、自下而上模式，单位年度计划由科室年度计划汇总而来（需要区分指标的数据类型）
2、自上而下模式，单位年度计划是编制的起点
*/
begin
    
    --变量初始化
    execute immediate '
    select BUDGET_YEAR,TEMPLET_ID,BUDGET_CPN_ID from BGT_B_CPN_PLAN_YEAR where id ='''||p_planid||''''
    into V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID,V_BUDGET_CPN_ID;
    --获取编制模式,编制层次    
    execute immediate 'select INCOME_PATTERN_ID,INCOME_LEVEL_ID from BGT_D_BUDGET_PATTERN
    where BUDGET_YEAR = '''||V_BUDGET_YEAR||'''' into v_PATTERN,V_LEVEL;    
    --删除子项
    V_DYNA_SQL:= 'delete from BGT_B_cpn_PLAN_YEAR_D where BASE_ID =''' || p_planid||'''';
    dbms_output.put_line(V_DYNA_SQL);
    execute immediate V_DYNA_SQL;
    --从模板复制子项
    V_DYNA_SQL:= 'insert into BGT_B_cpn_PLAN_YEAR_D(id,BASE_ID,ITEM_ID,TEMPLET_ITEM_ID)
    select sys_guid(), '''||p_planid||''',t.ITEM_ID,t.ID from BGT_D_BUDGET_T_D t
    where t.BASE_ID = ''' || V_BUDGET_TEMPLET_ID||'''';
    dbms_output.put_line(V_DYNA_SQL);
    execute immediate V_DYNA_SQL;
    --获取历史预算年
    execute immediate 'select t.id from BGT_D_BUDGET_YEAR t, BGT_D_BUDGET_YEAR t1
    where t1.ID = ''' || V_BUDGET_YEAR||'''
    and t.BUDGET_YEAR = t1.BUDGET_YEAR - 1 ' into V_PRE_BUDGET_YEAR;
    --遍历子项,对子项进行逐项计算
    for config in(
                    select
                    t.id,
                    t.base_id,
                    t.item_id,
                    t.calculate_index,
                    t.prepare_method_id,
                    t.calculate_method_id,
                    t.calculate_formula,
                    t.consult,
                    t1.id as planitemid,
                    t2.DATA_TYPE_ID as planitemtype
                    from  BGT_D_BUDGET_T_D t,
                    BGT_B_cpn_PLAN_YEAR_D t1,
                    bgt_d_plan_item t2
                    where t.id = t1.templet_item_id
                    and t.item_id = t2.id
                    and  t1.base_id = p_planid
                  )
          loop
             if v_PATTERN = '00170001' then --自上而下
                begin
                        --公式计算'00110002'
                        if config.calculate_method_id = '00110002'  then
                          begin
                            execute immediate '';
                          end;
                        --历史数据*比例系数'00110003'
                        elsif  config.calculate_method_id = '00110003'  then
                          begin
                            
                            V_DYNA_SQL:= 'update BGT_B_cpn_PLAN_YEAR_D set
                                  ITEM_VALUE = (
                                                 select sum(m_1_value)
                                                    + sum(m_2_value)
                                                    + sum(m_3_value)
                                                    + sum(m_4_value)
                                                    + sum(m_5_value)
                                                    + sum(m_6_value)
                                                    + sum(m_7_value)
                                                    + sum(m_8_value)
                                                    + sum(m_9_value)
                                                    + sum(m_10_value)
                                                    + sum(m_11_value)
                                                    + sum(m_12_value) from BGT_B_CPN_HIS_DATA_D
                                                 where ITEM_ID = '''||config.item_id||'''
                                                 and BASE_ID in
                                                 (
                                                   select id
                                                   from
                                                   BGT_B_CPN_HIS_DATA
                                                   where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||'''
                                                   and BUDGET_CONTENTS_ID = ''00120001''
                                                 )
                                                 group by ITEM_ID
                                             ) * (select nvl(t1.INCREASE_SCALE,1 )
                                                  from BGT_D_BUDGET_T_CPN_I t,BGT_D_BUDGET_T_CPN_I_D t1
                                                  where t.BASE_ID = '''||V_BUDGET_TEMPLET_ID||'''
                                                  and t.id = t1.base_id
                                                  and t1.ITEM_ID = '''||config.item_id||''')
                                  where id =''' || config.planitemid ||'''';
                            dbms_output.put_line(V_DYNA_SQL);
                            execute immediate V_DYNA_SQL;
                          end;
                         --历史数据 '00110004'
                        elsif config.calculate_method_id = '00110004' then
                          begin
                             V_DYNA_SQL:='update BGT_B_cpn_PLAN_YEAR_D set
                                    ITEM_VALUE = (
                                                   select sum(m_1_value)
                                                    + sum(m_2_value)
                                                    + sum(m_3_value)
                                                    + sum(m_4_value)
                                                    + sum(m_5_value)
                                                    + sum(m_6_value)
                                                    + sum(m_7_value)
                                                    + sum(m_8_value)
                                                    + sum(m_9_value)
                                                    + sum(m_10_value)
                                                    + sum(m_11_value)
                                                    + sum(m_12_value) from BGT_B_CPN_HIS_DATA_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_CPN_HIS_DATA
                                                     where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||'''
                                                     and BUDGET_CONTENTS_ID = ''00120001''
                                                   )
                                                   group by ITEM_ID
                                               )
                                    where id =''' || config.planitemid ||'''';
                            dbms_output.put_line(V_DYNA_SQL);
                            execute immediate V_DYNA_SQL;
                          end;
                         --历史数据分解上级科目'00110005'
                        elsif config.calculate_method_id = '00110005'  then
                          begin
                            execute immediate 'select sys_guid() from dual';
                          end;
                         --手工输入'00110001'
                        else
                          begin
                            execute immediate 'select sys_guid() from dual';
                          end;
                        end if;      
                end;
             elsif v_PATTERN = '00170002' then --自下而上
                begin                            
                            if config.planitemtype = '00210001' then --可累加
                             begin
                                   V_DYNA_SQL:='update BGT_B_cpn_PLAN_YEAR_D set
                                   ITEM_VALUE = (
                                                   select sum(item_value) from BGT_B_DEPT_PLAN_YEAR_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_YEAR
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               )
                                    where id =''' || config.planitemid ||'''';
                                   end;
                             else --状态值
                                begin
                                   V_DYNA_SQL:='update BGT_B_cpn_PLAN_YEAR_D set
                                   ITEM_VALUE = (
                                                   select avg(item_value) from BGT_B_DEPT_PLAN_YEAR_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_YEAR
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               )
                                    where id =''' || config.planitemid ||'''';
                                end;
                              end if;
                            dbms_output.put_line(V_DYNA_SQL);
                            execute immediate V_DYNA_SQL;              
                end;
             end if;              
          end loop;
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Cal_cpn_plan_year;

create or replace procedure SP_bgt_Cal_cpn_plan_month(p_yearid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_NEW_GUID varchar2(36);
V_NEW_M_GUID varchar2(36);
V_TEMP_NUM_1 number(22,4);
V_TEMP_NUM_2 number(22,4);
V_TEMP_NUM_3 number(22,4);
V_TEMP_NUM_4 number(22,4);
V_TEMP_NUM_5 number(22,4);
V_TEMP_NUM_6 number(22,4);
V_TEMP_NUM_7 number(22,4);
V_TEMP_NUM_8 number(22,4);
V_TEMP_NUM_9 number(22,4);
V_TEMP_NUM_10 number(22,4);
V_TEMP_NUM_11 number(22,4);
V_TEMP_NUM_12 number(22,4);
V_BUDGET_YEAR_PLAN_ID char(36);
V_BUDGET_YEAR char(36);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_TEMPLET_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
v_PATTERN char(36);
V_LEVEL char(36);
/*
1、自下而上模式，单位月计划由科室月计划汇总而来（需要区分指标的数据类型）
2、自上而下模式，单位月计划由单位年计划分解而来
*/
begin
    --变量初始化
    execute immediate 'select id,BUDGET_YEAR,TEMPLET_ID from BGT_B_cpn_PLAN_YEAR where BUDGET_YEAR='''||p_yearid||''''
    into V_BUDGET_YEAR_PLAN_ID,V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID;
    --获取编制模式,编制层次
    execute immediate 'select INCOME_PATTERN_ID,INCOME_LEVEL_ID from BGT_D_BUDGET_PATTERN
    where BUDGET_YEAR = '''||V_BUDGET_YEAR||'''' into v_PATTERN,V_LEVEL;
    

    
     --查询月份记录
    execute immediate 'select id from BGT_B_cpn_PLAN_MON where BUDGET_YEAR='''||p_yearid||''''
    into V_NEW_GUID;
    --删除明细记录
    execute immediate 'delete  from BGT_B_cpn_PLAN_MON_D where base_id='''||V_NEW_GUID||'''';
    
    
     --获取历史预算年
    execute immediate 'select t.id from BGT_D_BUDGET_YEAR t, BGT_D_BUDGET_YEAR t1
    where t1.ID = ''' || V_BUDGET_YEAR||'''
    and t.BUDGET_YEAR = t1.BUDGET_YEAR - 1 ' into V_PRE_BUDGET_YEAR;

          --插入从表
          --遍历【年计划】中的计划指标,逐个指标进行分解
          for config in(
              select
              p.item_id,
              nvl(p.item_value,0) item_value ,
              p.templet_item_id,
              ri.resolve_method_id,
              t2.DATA_TYPE_ID as planitemtype
              from  Bgt_b_cpn_Plan_Year_d p,
              BGT_D_BUDGET_cpn_YEAR_R r,
              BGT_D_BUDGET_cpn_YEAR_R_i ri,
              bgt_d_plan_item t2
              where p.base_id = V_BUDGET_YEAR_PLAN_ID
              and r.id = ri.base_id
              and ri.item_id = p.item_id
              and r.budget_year = p_yearid
              and p.item_id = t2.id
              and r.budget_contents_id = '00120001' --事业计划
            )
            loop
                  if v_PATTERN = '00170001' then --自上而下
                      begin
                            --00230001  比例系数
                            if config.resolve_method_id = '00230001'  then
                              begin
                                execute immediate 'insert into BGT_B_cpn_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                      m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round(d.m_1_value * '||config.item_value||',2),
                                  round(d.m_2_value * '||config.item_value||',2),
                                  round(d.m_3_value * '||config.item_value||',2),
                                  round(d.m_4_value * '||config.item_value||',2),
                                  round(d.m_5_value * '||config.item_value||',2),
                                  round(d.m_6_value * '||config.item_value||',2),
                                  round(d.m_7_value * '||config.item_value||',2),
                                  round(d.m_8_value * '||config.item_value||',2),
                                  round(d.m_9_value * '||config.item_value||',2),
                                  round(d.m_10_value * '||config.item_value||',2),
                                  round(d.m_11_value * '||config.item_value||',2),
                                  round(d.m_12_value * '||config.item_value||',2)
                                  from bgt_d_budget_cpn_year_r_i d                                  
                                  where d.item_id = '''||config.item_id||'''
                                  and d.base_id = (select id from bgt_d_budget_cpn_year_r r
                                  where r.budget_year = '''||V_BUDGET_YEAR||'''
                                  and r.budget_contents_id = ''00120001'')                                  
                                  ';

                              end;
                            end if;
                            --00230002  历史数据
                            if config.resolve_method_id = '00230002'  then
                              begin
                                execute immediate 'insert into BGT_B_cpn_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                      t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value
                                  from BGT_B_cpn_HIS_DATA_D t
                                  where
                                  t.base_id = (select t.id from BGT_B_cpn_HIS_DATA t
                                  where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                  and t.budget_contents_id = ''00120001'')
                                  and t.item_id = '''||config.item_id||'''
                                  ';
                              end;
                            end if;
                            --00230003  历史数据*比例系数
                            if config.resolve_method_id = '00230003'  then
                              begin
                                --取比例系数
                                execute immediate 'select
                                  d.m_1_value,
                                  d.m_2_value,
                                  d.m_3_value,
                                  d.m_4_value,
                                  d.m_5_value,
                                  d.m_6_value,
                                  d.m_7_value,
                                  d.m_8_value,
                                  d.m_9_value,
                                  d.m_10_value,
                                  d.m_11_value,
                                  d.m_12_value
                                  from bgt_d_budget_cpn_year_r_i d
                                 
                                  where d.item_id = '''||config.item_id||'''
                                  and d.base_id = (select id from bgt_d_budget_cpn_year_r r
                                  where r.budget_year = '''||V_BUDGET_YEAR||'''
                                  and r.budget_contents_id = ''00120001'')
                                  ' into V_TEMP_NUM_1,V_TEMP_NUM_2,V_TEMP_NUM_3,
                                  V_TEMP_NUM_4,V_TEMP_NUM_5,
                                  V_TEMP_NUM_6,V_TEMP_NUM_7,
                                  V_TEMP_NUM_8,V_TEMP_NUM_9,
                                  V_TEMP_NUM_10,V_TEMP_NUM_11,V_TEMP_NUM_12;
                                execute immediate 'insert into BGT_B_cpn_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                    m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round(t.m_1_value * '||V_TEMP_NUM_1||',2)
                                  round(t.m_2_value * '||V_TEMP_NUM_2||',2)
                                  round(t.m_3_value * '||V_TEMP_NUM_3||',2)
                                  round(t.m_4_value * '||V_TEMP_NUM_4||',2)
                                  round(t.m_5_value * '||V_TEMP_NUM_5||',2)
                                  round(t.m_6_value * '||V_TEMP_NUM_6||',2)
                                  round(t.m_7_value * '||V_TEMP_NUM_7||',2)
                                  round(t.m_8_value * '||V_TEMP_NUM_8||',2)
                                  round(t.m_9_value * '||V_TEMP_NUM_9||',2)
                                  round(t.m_10_value * '||V_TEMP_NUM_10||',2)
                                  round(t.m_11_value * '||V_TEMP_NUM_11||',2)
                                  round(t.m_12_value * '||V_TEMP_NUM_12||',2)
                                  from BGT_B_cpn_HIS_DATA_D t
                                  where
                                  t.base_id = (select t.id from BGT_B_cpn_HIS_DATA t
                                  where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                  and t.budget_contents_id = ''00120001'')
                                  and t.item_id = '''||config.item_id||'''
                                  ';
                              end;
                            end if;
                            --00230004  全面贯彻：复制年计划值
                            if config.resolve_method_id = '00230004'  then
                              begin
                                execute immediate 'insert into BGT_B_cpn_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                    m_1_value,
                                    m_2_value,
                                    m_3_value,
                                    m_4_value,
                                    m_5_value,
                                    m_6_value,
                                    m_7_value,
                                    m_8_value,
                                    m_9_value,
                                    m_10_value,
                                    m_11_value,
                                    m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||'
                                  from dual
                                  ';
                              end;
                            end if;
                            --00230005  均摊：年计划值除以12
                            if config.resolve_method_id = '00230005'  then
                              begin
                                 execute immediate 'insert into BGT_B_cpn_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                    m_1_value,
                                    m_2_value,
                                    m_3_value,
                                    m_4_value,
                                    m_5_value,
                                    m_6_value,
                                    m_7_value,
                                    m_8_value,
                                    m_9_value,
                                    m_10_value,
                                    m_11_value,
                                    m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2)
                                  from dual
                                  ';
                              end;
                            end if;
                       end;
                 elsif v_PATTERN = '00170002' then --自下而上
                       begin

                            if config.planitemtype = '00210001' then --可累加
                             begin
                                   V_DYNA_SQL:= 'insert into BGT_B_cpn_PLAN_MON_D
                                                (
                                                  id ,
                                                  base_id ,
                                                  item_id,
                                                  templet_item_id,
                                                   m_1_value,
                                                  m_2_value,
                                                  m_3_value,
                                                  m_4_value,
                                                  m_5_value,
                                                  m_6_value,
                                                  m_7_value,
                                                  m_8_value,
                                                  m_9_value,
                                                  m_10_value,
                                                  m_11_value,
                                                  m_12_value
                                                )
                                                select sys_guid(),
                                                '''||V_NEW_GUID||''',
                                                '''||config.item_id||''',
                                                '''||config.templet_item_id||''',
                                                (
                                                   select sum(m_1_value)
                                                   from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select sum(m_2_value)
                                                   from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select sum(m_3_value)
                                                   from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select sum(m_4_value)
                                                   from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select sum(m_5_value)
                                                   from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select sum(m_6_value)
                                                   from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select sum(m_7_value)
                                                   from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select sum(m_8_value)
                                                   from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select sum(m_9_value)
                                                   from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select sum(m_10_value)
                                                   from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select sum(m_11_value)
                                                   from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select sum(m_12_value)
                                                   from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               )
                                               from dual';
                                   end;
                             else --状态值
                                begin
                                   V_DYNA_SQL:='insert into BGT_B_cpn_PLAN_MON_D
                                                (
                                                  id ,
                                                  base_id ,
                                                  item_id,
                                                  templet_item_id,
                                                   m_1_value,
                                                  m_2_value,
                                                  m_3_value,
                                                  m_4_value,
                                                  m_5_value,
                                                  m_6_value,
                                                  m_7_value,
                                                  m_8_value,
                                                  m_9_value,
                                                  m_10_value,
                                                  m_11_value,
                                                  m_12_value
                                                )
                                                select sys_guid(),
                                                '''||V_NEW_GUID||''',
                                                '''||config.item_id||''',
                                                '''||config.templet_item_id||''',
                                                (
                                                   select avg(m_1_value) from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                                                 )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select avg(m_2_value) from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                          )
                                                   group by ITEM_ID
                                               ),                                               
                                               (
                                                   select avg(m_3_value) from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select avg(m_4_value) from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select avg(m_5_value) from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select avg(m_6_value) from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select avg(m_7_value) from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select avg(m_8_value) from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select avg(m_9_value) from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select avg(m_10_value) from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select avg(m_11_value) from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               ),
                                               (
                                                   select avg(m_12_value) from BGT_B_DEPT_PLAN_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_PLAN_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               )
                                               from dual';
                                end;
                              end if;
                            --dbms_output.put_line(V_DYNA_SQL);
                            execute immediate V_DYNA_SQL;

                       end;
                 end if;

            end loop;
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Cal_cpn_plan_month;


create or replace procedure SP_bgt_Cal_cpn_inc_year(p_planid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_YEAR char(36);
V_BUDGET_CPN_ID char(36);
V_BUDGET_TEMPLET_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
v_PATTERN char(36);
V_LEVEL char(36);
/*
1、自下而上模式，单位年度收入由科室年度收入汇总而来（需要区分指标的数据类型）
2、自上而下模式，单位年度收入是编制的起点
*/
begin

    --变量初始化
    execute immediate '
    select BUDGET_YEAR,TEMPLET_ID,BUDGET_CPN_ID from BGT_B_CPN_inc_YEAR where id ='''||p_planid||''''
    into V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID,V_BUDGET_CPN_ID;
    --获取编制模式,编制层次
    execute immediate 'select INCOME_PATTERN_ID,INCOME_LEVEL_ID from BGT_D_BUDGET_PATTERN
    where BUDGET_YEAR = '''||V_BUDGET_YEAR||'''' into v_PATTERN,V_LEVEL;
    --删除子项
    V_DYNA_SQL:= 'delete from BGT_B_cpn_inc_YEAR_D where BASE_ID =''' || p_planid||'''';
    dbms_output.put_line(V_DYNA_SQL);
    execute immediate V_DYNA_SQL;
    --从模板复制子项
    V_DYNA_SQL:= 'insert into BGT_B_cpn_inc_YEAR_D(id,BASE_ID,ITEM_ID,TEMPLET_ITEM_ID)
    select sys_guid(), '''||p_planid||''',t.ITEM_ID,t.ID from BGT_D_BUDGET_T_D t
    where t.BASE_ID = ''' || V_BUDGET_TEMPLET_ID||'''';
    dbms_output.put_line(V_DYNA_SQL);
    execute immediate V_DYNA_SQL;
    --获取历史预算年
    execute immediate 'select t.id from BGT_D_BUDGET_YEAR t, BGT_D_BUDGET_YEAR t1
    where t1.ID = ''' || V_BUDGET_YEAR||'''
    and t.BUDGET_YEAR = t1.BUDGET_YEAR - 1 ' into V_PRE_BUDGET_YEAR;
    --遍历子项,对子项进行逐项计算
    for config in(
                    select
                    t.id,
                    t.base_id,
                    t.item_id,
                    t.calculate_index,
                    t.prepare_method_id,
                    t.calculate_method_id,
                    t.calculate_formula,
                    t.consult,
                    t1.id as planitemid,
                    t2.DATA_TYPE_ID as planitemtype
                    from  BGT_D_BUDGET_T_D t,
                    BGT_B_cpn_inc_YEAR_D t1,
                    bgt_d_budget_item t2
                    where t.id = t1.templet_item_id
                    and t.item_id = t2.id
                    and  t1.base_id = p_planid
                  )
          loop
             if v_PATTERN = '00170001' then --自上而下
                begin
                        --公式计算'00110002'
                        if config.calculate_method_id = '00110002'  then
                          begin
                            execute immediate '';
                          end;
                        --历史数据*比例系数'00110003'
                        elsif  config.calculate_method_id = '00110003'  then
                          begin

                            V_DYNA_SQL:= 'update BGT_B_cpn_inc_YEAR_D set
                                  ITEM_VALUE = (
                                                 select sum(m_1_value)
                                                    + sum(m_2_value)
                                                    + sum(m_3_value)
                                                    + sum(m_4_value)
                                                    + sum(m_5_value)
                                                    + sum(m_6_value)
                                                    + sum(m_7_value)
                                                    + sum(m_8_value)
                                                    + sum(m_9_value)
                                                    + sum(m_10_value)
                                                    + sum(m_11_value)
                                                    + sum(m_12_value) from BGT_B_CPN_HIS_DATA_D
                                                 where ITEM_ID = '''||config.item_id||'''
                                                 and BASE_ID in
                                                 (
                                                   select id
                                                   from
                                                   BGT_B_CPN_HIS_DATA
                                                   where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||'''
                                                   and BUDGET_CONTENTS_ID = ''00120002''
                                                 )
                                                 group by ITEM_ID
                                             ) * (select nvl(t1.INCREASE_SCALE,1 )
                                                  from BGT_D_BUDGET_T_CPN_I t,BGT_D_BUDGET_T_CPN_I_D t1
                                                  where t.BASE_ID = '''||V_BUDGET_TEMPLET_ID||'''
                                                  and t.id = t1.base_id
                                                  and t1.ITEM_ID = '''||config.item_id||''')
                                  where id =''' || config.planitemid ||'''';
                            dbms_output.put_line(V_DYNA_SQL);
                            execute immediate V_DYNA_SQL;
                          end;
                         --历史数据 '00110004'
                        elsif config.calculate_method_id = '00110004' then
                          begin
                             V_DYNA_SQL:='update BGT_B_cpn_inc_YEAR_D set
                                    ITEM_VALUE = (
                                                   select sum(m_1_value)
                                                    + sum(m_2_value)
                                                    + sum(m_3_value)
                                                    + sum(m_4_value)
                                                    + sum(m_5_value)
                                                    + sum(m_6_value)
                                                    + sum(m_7_value)
                                                    + sum(m_8_value)
                                                    + sum(m_9_value)
                                                    + sum(m_10_value)
                                                    + sum(m_11_value)
                                                    + sum(m_12_value) from BGT_B_CPN_HIS_DATA_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_CPN_HIS_DATA
                                                     where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||'''
                                                     and BUDGET_CONTENTS_ID = ''00120002''
                                                   )
                                                   group by ITEM_ID
                                               )
                                    where id =''' || config.planitemid ||'''';
                            dbms_output.put_line(V_DYNA_SQL);
                            execute immediate V_DYNA_SQL;
                          end;
                         --历史数据分解上级科目'00110005'
                        elsif config.calculate_method_id = '00110005'  then
                          begin
                            execute immediate 'select sys_guid() from dual';
                          end;
                         --手工输入'00110001'
                        else
                          begin
                            execute immediate 'select sys_guid() from dual';
                          end;
                        end if;
                end;
             elsif v_PATTERN = '00170002' then --自下而上
                begin
                            if config.planitemtype = '00210001' then --可累加
                             begin
                                   V_DYNA_SQL:='update BGT_B_cpn_inc_YEAR_D set
                                   ITEM_VALUE = (
                                                   select sum(item_value) from BGT_B_DEPT_inc_YEAR_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_inc_YEAR
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               )
                                    where id =''' || config.planitemid ||'''';
                                   end;
                             else --状态值
                                begin
                                   V_DYNA_SQL:='update BGT_B_cpn_inc_YEAR_D set
                                   ITEM_VALUE = (
                                                   select avg(item_value) from BGT_B_DEPT_inc_YEAR_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_inc_YEAR
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID
                                               )
                                    where id =''' || config.planitemid ||'''';
                                end;
                              end if;
                            dbms_output.put_line(V_DYNA_SQL);
                            execute immediate V_DYNA_SQL;
                end;
             end if;
          end loop;
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Cal_cpn_inc_year;


create or replace procedure SP_bgt_Cal_cpn_inc_month(p_yearid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_NEW_GUID varchar2(36);
V_NEW_M_GUID varchar2(36);
V_TEMP_NUM_1 number(22,4);
V_TEMP_NUM_2 number(22,4);
V_TEMP_NUM_3 number(22,4);
V_TEMP_NUM_4 number(22,4);
V_TEMP_NUM_5 number(22,4);
V_TEMP_NUM_6 number(22,4);
V_TEMP_NUM_7 number(22,4);
V_TEMP_NUM_8 number(22,4);
V_TEMP_NUM_9 number(22,4);
V_TEMP_NUM_10 number(22,4);
V_TEMP_NUM_11 number(22,4);
V_TEMP_NUM_12 number(22,4);
V_BUDGET_YEAR_PLAN_ID char(36);
V_BUDGET_YEAR char(36);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_TEMPLET_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
v_PATTERN char(36);
V_LEVEL char(36);
/*
1、自下而上模式，单位月收入由科室月收入汇总而来（需要区分指标的数据类型）
2、自上而下模式，单位月收入由单位年分解而来
*/
begin
    --变量初始化
    execute immediate 'select id,BUDGET_YEAR,TEMPLET_ID from BGT_B_cpn_inc_YEAR where BUDGET_YEAR='''||p_yearid||''''
    into V_BUDGET_YEAR_PLAN_ID,V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID;
    --获取编制模式,编制层次
    execute immediate 'select INCOME_PATTERN_ID,INCOME_LEVEL_ID from BGT_D_BUDGET_PATTERN
    where BUDGET_YEAR = '''||V_BUDGET_YEAR||'''' into v_PATTERN,V_LEVEL;
  
    
     --查询月份记录
    execute immediate 'select id from BGT_B_cpn_inc_MON where BUDGET_YEAR='''||p_yearid||''''
    into V_NEW_GUID;
    --删除明细记录
    execute immediate 'delete  from BGT_B_cpn_inc_MON_D where base_id='''||V_NEW_GUID||'''';
    
     --获取历史预算年
    execute immediate 'select t.id from BGT_D_BUDGET_YEAR t, BGT_D_BUDGET_YEAR t1
    where t1.ID = ''' || V_BUDGET_YEAR||'''
    and t.BUDGET_YEAR = t1.BUDGET_YEAR - 1 ' into V_PRE_BUDGET_YEAR;
       
          --插入从表
           --遍历【年预算】中的预算指标,逐个指标进行分解
          for config in(
              select
              p.item_id,
              nvl(p.item_value,0) item_value ,
              p.templet_item_id,
              ri.resolve_method_id,
              t2.DATA_TYPE_ID as planitemtype
              from  Bgt_b_cpn_inc_Year_d p,
              BGT_D_BUDGET_cpn_YEAR_R r,
              BGT_D_BUDGET_cpn_YEAR_R_i ri,
              bgt_d_budget_item t2
              where p.base_id = V_BUDGET_YEAR_PLAN_ID
              and r.id = ri.base_id
              and ri.item_id = p.item_id
              and r.budget_year = p_yearid
              and p.item_id = t2.id
              and r.budget_contents_id = '00120002' --收入预算
            )
            loop
                  if v_PATTERN = '00170001' then --自上而下
                      begin
                            --00230001  比例系数
                            if config.resolve_method_id = '00230001'  then
                              begin
                                execute immediate 'insert into BGT_B_cpn_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round(d.m_1_value * '||config.item_value||',2),
                                  round(d.m_2_value * '||config.item_value||',2),
                                  round(d.m_3_value * '||config.item_value||',2),
                                  round(d.m_4_value * '||config.item_value||',2),
                                  round(d.m_5_value * '||config.item_value||',2),
                                  round(d.m_6_value * '||config.item_value||',2),
                                  round(d.m_7_value * '||config.item_value||',2),
                                  round(d.m_8_value * '||config.item_value||',2),
                                  round(d.m_9_value * '||config.item_value||',2),
                                  round(d.m_10_value * '||config.item_value||',2),
                                  round(d.m_11_value * '||config.item_value||',2),
                                  round(d.m_12_value * '||config.item_value||',2)
                                  from bgt_d_budget_cpn_year_r_i d                                  
                                  where d.item_id = '''||config.item_id||'''
                                  and d.base_id = (select id from bgt_d_budget_cpn_year_r r
                                  where r.budget_year = '''||V_BUDGET_YEAR||'''
                                  and r.budget_contents_id = ''00120002'')
                                  
                                  ';
                              end;
                            end if;
                            --00230002  历史数据
                            if config.resolve_method_id = '00230002'  then
                              begin
                                execute immediate 'insert into BGT_B_cpn_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                   t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value
                                  from BGT_B_cpn_HIS_DATA_D t
                                  where
                                  t.base_id = (select t.id from BGT_B_cpn_HIS_DATA t
                                  where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                  and t.budget_contents_id = ''00120002'')
                                  and t.item_id = '''||config.item_id||'''
                                  ';
                              end;
                            end if;
                            --00230003  历史数据*比例系数
                            if config.resolve_method_id = '00230003'  then
                              begin
                                --取比例系数
                                execute immediate 'select 
                                d.m_1_value,
                                      d.m_2_value,
                                      d.m_3_value,
                                      d.m_4_value,
                                      d.m_5_value,
                                      d.m_6_value,
                                      d.m_7_value,
                                      d.m_8_value,
                                      d.m_9_value,
                                      d.m_10_value,
                                      d.m_11_value,
                                      d.m_12_value
                                  from bgt_d_budget_cpn_year_r_i d
                                  where d.item_id = '''||config.item_id||'''
                                  and d.base_id = (select id from bgt_d_budget_cpn_year_r r
                                  where r.budget_year = '''||V_BUDGET_YEAR||'''
                                  and r.budget_contents_id = ''00120002'')
                                  ' into V_TEMP_NUM_1,V_TEMP_NUM_2,V_TEMP_NUM_3,V_TEMP_NUM_4,
                                  V_TEMP_NUM_5,V_TEMP_NUM_6,V_TEMP_NUM_7,V_TEMP_NUM_8,V_TEMP_NUM_9,
                                  V_TEMP_NUM_10,V_TEMP_NUM_11,V_TEMP_NUM_12;
                                execute immediate 'insert into BGT_B_cpn_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round(t.m_1_value * '||V_TEMP_NUM_1||',2),
                                  round(t.m_2_value * '||V_TEMP_NUM_2||',2),
                                  round(t.m_3_value * '||V_TEMP_NUM_3||',2),
                                  round(t.m_4_value * '||V_TEMP_NUM_4||',2),
                                  round(t.m_5_value * '||V_TEMP_NUM_5||',2),
                                  round(t.m_6_value * '||V_TEMP_NUM_6||',2),
                                  round(t.m_7_value * '||V_TEMP_NUM_7||',2),
                                  round(t.m_8_value * '||V_TEMP_NUM_8||',2),
                                  round(t.m_9_value * '||V_TEMP_NUM_9||',2),
                                  round(t.m_10_value * '||V_TEMP_NUM_10||',2),
                                  round(t.m_11_value * '||V_TEMP_NUM_11||',2),
                                  round(t.m_12_value * '||V_TEMP_NUM_12||',2)
                                  from BGT_B_cpn_HIS_DATA_D t
                                  where
                                  t.base_id = (select t.id from BGT_B_cpn_HIS_DATA t
                                  where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                  and t.budget_contents_id = ''00120002'')
                                  and t.item_id = '''||config.item_id||'''
                                  ';
                              end;
                            end if;
                            --00230004  全面贯彻：复制年计划值
                            if config.resolve_method_id = '00230004'  then
                              begin
                                execute immediate 'insert into BGT_B_cpn_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||'
                                  from dual
                                  ';
                              end;
                            end if;
                            --00230005  均摊：年计划值除以12
                            if config.resolve_method_id = '00230005'  then
                              begin
                                 execute immediate 'insert into BGT_B_cpn_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2)
                                  from dual
                                  ';
                              end;
                            end if;
                       end;
                 elsif v_PATTERN = '00170002' then --自下而上 --待修改
                       begin

                            if config.planitemtype = '00210001' then --可累加
                             begin
                                   V_DYNA_SQL:= 'insert into BGT_B_cpn_inc_MON_D
                                                (
                                                  id ,
                                                  base_id ,
                                                  item_id,
                                                  templet_item_id,
                                                  m_1_value,
                                                  m_2_value,
                                                  m_3_value,
                                                  m_4_value,
                                                  m_5_value,
                                                  m_6_value,
                                                  m_7_value,
                                                  m_8_value,
                                                  m_9_value,
                                                  m_10_value,
                                                  m_11_value,
                                                  m_12_value
                                                )
                                                select sys_guid(),
                                                '''||V_NEW_GUID||''',
                                                '''||config.item_id||''',
                                                '''||config.templet_item_id||''',
                                                   sum(m_1_value),
                                                   sum(m_2_value),
                                                   sum(m_3_value),
                                                   sum(m_4_value),
                                                   sum(m_5_value),
                                                   sum(m_6_value),
                                                   sum(m_7_value),
                                                   sum(m_8_value),
                                                   sum(m_9_value),
                                                   sum(m_10_value),
                                                   sum(m_11_value),
                                                   sum(m_12_value)
                                                    from BGT_B_DEPT_inc_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_inc_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                    )
                                                   group by ITEM_ID';
                                   end;
                             else --状态值
                                begin
                                   V_DYNA_SQL:='insert into BGT_B_cpn_inc_MON_D
                                                (
                                                  id ,
                                                  base_id ,
                                                  item_id,
                                                  templet_item_id,
                                                   m_1_value,
                                                  m_2_value,
                                                  m_3_value,
                                                  m_4_value,
                                                  m_5_value,
                                                  m_6_value,
                                                  m_7_value,
                                                  m_8_value,
                                                  m_9_value,
                                                  m_10_value,
                                                  m_11_value,
                                                  m_12_value
                                                )
                                                select sys_guid(),
                                                '''||V_NEW_GUID||''',
                                                '''||config.item_id||''',
                                                '''||config.templet_item_id||''',
                                                   avg(m_1_value) ,
                                                   avg(m_2_value) ,
                                                   avg(m_3_value) ,
                                                   avg(m_4_value) ,
                                                   avg(m_5_value) ,
                                                   avg(m_6_value) ,
                                                   avg(m_7_value) ,
                                                   avg(m_8_value) ,
                                                   avg(m_9_value) ,
                                                   avg(m_10_value) ,
                                                   avg(m_11_value) ,
                                                   avg(m_12_value) 
                                                   from BGT_B_DEPT_inc_mon_D
                                                   where ITEM_ID = '''||config.item_id||'''
                                                   and BASE_ID in
                                                   (
                                                     select id
                                                     from
                                                     BGT_B_DEPT_inc_mon
                                                     where BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                                   )
                                                   group by ITEM_ID';
                                end;
                              end if;
                            --dbms_output.put_line(V_DYNA_SQL);
                            execute immediate V_DYNA_SQL;

                       end;
                 end if;

            end loop;
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Cal_cpn_inc_month;


create or replace procedure SP_bgt_Cal_cpn_pay_year(p_planid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_YEAR char(36);
V_BUDGET_CPN_ID char(36);
V_BUDGET_TEMPLET_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
v_PATTERN char(36);
V_LEVEL char(36);
/*
1、自下而上模式，单位年度支出由职能科室年度计划汇总而来（需要区分指标的数据类型）
2、自上而下模式，单位年度支出是编制的起点
*/
begin

    --变量初始化
    execute immediate '
    select BUDGET_YEAR,TEMPLET_ID,BUDGET_CPN_ID from BGT_B_CPN_pay_YEAR where id ='''||p_planid||''''
    into V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID,V_BUDGET_CPN_ID;
    --获取编制模式,编制层次
    execute immediate 'select INCOME_PATTERN_ID,INCOME_LEVEL_ID from BGT_D_BUDGET_PATTERN
    where BUDGET_YEAR = '''||V_BUDGET_YEAR||'''' into v_PATTERN,V_LEVEL;
    --删除子项
    V_DYNA_SQL:= 'delete from BGT_B_cpn_pay_YEAR_D where BASE_ID =''' || p_planid||'''';
    dbms_output.put_line(V_DYNA_SQL);
    execute immediate V_DYNA_SQL;
    --从模板复制子项
    V_DYNA_SQL:= 'insert into BGT_B_cpn_pay_YEAR_D(id,BASE_ID,ITEM_ID,TEMPLET_ITEM_ID)
    select sys_guid(), '''||p_planid||''',t.ITEM_ID,t.ID from BGT_D_BUDGET_T_D t
    where t.BASE_ID = ''' || V_BUDGET_TEMPLET_ID||'''';
    dbms_output.put_line(V_DYNA_SQL);
    execute immediate V_DYNA_SQL;
    --获取历史预算年
    execute immediate 'select t.id from BGT_D_BUDGET_YEAR t, BGT_D_BUDGET_YEAR t1
    where t1.ID = ''' || V_BUDGET_YEAR||'''
    and t.BUDGET_YEAR = t1.BUDGET_YEAR - 1 ' into V_PRE_BUDGET_YEAR;
    if v_PATTERN = '00170001' then --自上而下
      begin
                         --遍历子项,对子项进行逐项计算
            for config in(
                            select
                            t.id,
                            t.base_id,
                            t.item_id,
                            t.calculate_index,
                            t.prepare_method_id,
                            t.calculate_method_id,
                            t.calculate_formula,
                            t.consult,
                            t1.id as planitemid,
                            t2.DATA_TYPE_ID as planitemtype
                            from  BGT_D_BUDGET_T_D t,
                            BGT_B_cpn_pay_YEAR_D t1,
                            bgt_d_budget_item t2
                            where t.id = t1.templet_item_id
                            and t.item_id = t2.id
                            and  t1.base_id = p_planid
                          )
                  loop
                      --公式计算'00110002'
                      if config.calculate_method_id = '00110002'  then
                        begin
                          execute immediate '';
                        end;
                      --历史数据*比例系数'00110003'
                      elsif  config.calculate_method_id = '00110003'  then
                        begin

                          V_DYNA_SQL:= 'update BGT_B_cpn_pay_YEAR_D set
                                ITEM_VALUE = (
                                               select sum(m_1_value)
                                                  + sum(m_2_value)
                                                  + sum(m_3_value)
                                                  + sum(m_4_value)
                                                  + sum(m_5_value)
                                                  + sum(m_6_value)
                                                  + sum(m_7_value)
                                                  + sum(m_8_value)
                                                  + sum(m_9_value)
                                                  + sum(m_10_value)
                                                  + sum(m_11_value)
                                                  + sum(m_12_value) from BGT_B_CPN_HIS_DATA_D
                                               where ITEM_ID = '''||config.item_id||'''
                                               and BASE_ID in
                                               (
                                                 select id
                                                 from
                                                 BGT_B_CPN_HIS_DATA
                                                 where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||'''
                                                 and BUDGET_CONTENTS_ID = ''00120003''
                                               )
                                               group by ITEM_ID
                                           ) * (select nvl(t1.INCREASE_SCALE,1 )
                                                from BGT_D_BUDGET_T_CPN_I t,BGT_D_BUDGET_T_CPN_I_D t1
                                                where t.BASE_ID = '''||V_BUDGET_TEMPLET_ID||'''
                                                and t.id = t1.base_id
                                                and t1.ITEM_ID = '''||config.item_id||''')
                                where id =''' || config.planitemid ||'''';
                          dbms_output.put_line(V_DYNA_SQL);
                          execute immediate V_DYNA_SQL;
                        end;
                       --历史数据 '00110004'
                      elsif config.calculate_method_id = '00110004' then
                        begin
                           V_DYNA_SQL:='update BGT_B_cpn_pay_YEAR_D set
                                  ITEM_VALUE = (
                                                 select sum(m_1_value)
                                                  + sum(m_2_value)
                                                  + sum(m_3_value)
                                                  + sum(m_4_value)
                                                  + sum(m_5_value)
                                                  + sum(m_6_value)
                                                  + sum(m_7_value)
                                                  + sum(m_8_value)
                                                  + sum(m_9_value)
                                                  + sum(m_10_value)
                                                  + sum(m_11_value)
                                                  + sum(m_12_value) from BGT_B_CPN_HIS_DATA_D
                                                 where ITEM_ID = '''||config.item_id||'''
                                                 and BASE_ID in
                                                 (
                                                   select id
                                                   from
                                                   BGT_B_CPN_HIS_DATA
                                                   where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||'''
                                                   and BUDGET_CONTENTS_ID = ''00120003''
                                                 )
                                                 group by ITEM_ID
                                             )
                                  where id =''' || config.planitemid ||'''';
                          dbms_output.put_line(V_DYNA_SQL);
                          execute immediate V_DYNA_SQL;
                        end;
                       --历史数据分解上级科目'00110005'
                      elsif config.calculate_method_id = '00110005'  then
                        begin
                          execute immediate 'select sys_guid() from dual';
                        end;
                       --手工输入'00110001'
                      else
                        begin
                          execute immediate 'select sys_guid() from dual';
                        end;
                      end if;
                  end loop;
      end;
    elsif v_PATTERN = '00170002' then --自下而上
      begin
         --遍历子项,对子项进行逐项计算
            for config in(
                            select
                            t.id,
                            t.base_id,
                            t.item_id,
                            t.calculate_index,
                            t.prepare_method_id,
                            t.calculate_method_id,
                            t.calculate_formula,
                            t.consult,
                            t1.id as planitemid,
                            t2.DATA_TYPE_ID as planitemtype
                            from  BGT_D_BUDGET_T_D t,
                            BGT_B_cpn_pay_YEAR_D t1,
                            bgt_d_budget_item t2
                            where t.id = t1.templet_item_id
                            and t.item_id = t2.id
                            and  t1.base_id = p_planid
                          )
                  loop
                      if config.planitemtype = '00210001' then --可累加
                          begin
                             V_DYNA_SQL:='update BGT_B_cpn_pay_YEAR_D set
                             ITEM_VALUE = (
                                             select sum(item_value) from BGT_B_DEPT_pay_YEAR_D
                                             where ITEM_ID = '''||config.item_id||'''
                                             and BASE_ID in
                                             (
                                               select t.id
                                               from
                                               BGT_B_DEPT_PAY_YEAR t,bgt_d_budget_dept t1
                                               where t.BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                               and t1.is_function = 1
                                               and t1.id = t.BUDGET_DEPT_ID
                                             )
                                             group by ITEM_ID
                                         )
                              where id =''' || config.planitemid ||'''';
                        end;
                      else --状态值
                          begin
                             V_DYNA_SQL:='update BGT_B_cpn_pay_YEAR_D set
                             ITEM_VALUE = (
                                             select avg(item_value) from BGT_B_DEPT_PAY_YEAR_D
                                             where ITEM_ID = '''||config.item_id||'''
                                             and BASE_ID in
                                             (
                                               select t.id
                                               from
                                               BGT_B_DEPT_PAY_YEAR t,bgt_d_budget_dept t1
                                               where t.BUDGET_YEAR ='''||V_BUDGET_YEAR||'''
                                               and t1.is_function = 1
                                               and t1.id = t.BUDGET_DEPT_ID
                                             )
                                             group by ITEM_ID
                                         )
                              where id =''' || config.planitemid ||'''';
                          end;
                      end if;
                      dbms_output.put_line(V_DYNA_SQL);
                      execute immediate V_DYNA_SQL;
                  end loop;
      end;
    end if;
    p_msg:= '';
    p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Cal_cpn_pay_year;

create or replace procedure SP_bgt_Cal_cpn_pay_month(p_yearid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_NEW_GUID varchar2(36);
V_NEW_M_GUID varchar2(36);
V_TEMP_NUM_1 number(22,4);
V_TEMP_NUM_2 number(22,4);
V_TEMP_NUM_3 number(22,4);
V_TEMP_NUM_4 number(22,4);
V_TEMP_NUM_5 number(22,4);
V_TEMP_NUM_6 number(22,4);
V_TEMP_NUM_7 number(22,4);
V_TEMP_NUM_8 number(22,4);
V_TEMP_NUM_9 number(22,4);
V_TEMP_NUM_10 number(22,4);
V_TEMP_NUM_11 number(22,4);
V_TEMP_NUM_12 number(22,4);
V_BUDGET_YEAR_PLAN_ID char(36);
V_BUDGET_YEAR char(36);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_TEMPLET_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
v_PATTERN char(36);
V_LEVEL char(36);
/*
1、自下而上模式，单位月支出由职能科室月支出汇总而来（需要区分指标的数据类型）
2、自上而下模式，单位月支出由单位年支出分解而来
*/
begin
    --获取编制模式,编制层次
    execute immediate 'select INCOME_PATTERN_ID,INCOME_LEVEL_ID from BGT_D_BUDGET_PATTERN
    where BUDGET_YEAR = '''||p_yearid||'''' into v_PATTERN,V_LEVEL;
     --查询月份记录
    execute immediate 'select id from BGT_B_cpn_pay_mon where BUDGET_YEAR='''||p_yearid||''''
    into V_NEW_GUID;
    --删除明细记录
    execute immediate 'delete  from BGT_B_cpn_pay_mon_D where base_id='''||V_NEW_GUID||'''';
    
     --获取历史预算年
    execute immediate 'select t.id from BGT_D_BUDGET_YEAR t, BGT_D_BUDGET_YEAR t1
    where t1.ID = ''' || p_yearid||'''
    and t.BUDGET_YEAR = t1.BUDGET_YEAR - 1 ' into V_PRE_BUDGET_YEAR;
    --变量初始化
    if v_PATTERN = '00170001' then --自上而下
          begin
            execute immediate 'select id,BUDGET_YEAR,TEMPLET_ID from BGT_B_cpn_pay_YEAR where BUDGET_YEAR='''||p_yearid||''''
into V_BUDGET_YEAR_PLAN_ID,V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID;
            
          --遍历预算月份记录,逐月进行分解
          --插入从表
          --遍历【年预算】中的预算指标,逐个指标进行分解
          for config in(
              select
              p.item_id,
              nvl(p.item_value,0) item_value ,
              p.templet_item_id,
              ri.resolve_method_id,
              t2.DATA_TYPE_ID as planitemtype
              from  Bgt_b_cpn_pay_Year_d p,
              BGT_D_BUDGET_cpn_YEAR_R r,
              BGT_D_BUDGET_cpn_YEAR_R_i ri,
              bgt_d_budget_item t2
              where p.base_id = V_BUDGET_YEAR_PLAN_ID
              and r.id = ri.base_id
              and ri.item_id = p.item_id
              and r.budget_year = p_yearid
              and p.item_id = t2.id
              and r.budget_contents_id = '00120003' --支出预算
            )
            loop
                  --00230001  比例系数
                  if config.resolve_method_id = '00230001'  then
                    begin
                      execute immediate 'insert into BGT_B_cpn_pay_MON_D
                        (
                          id ,
                          base_id ,
                          item_id,
                          templet_item_id,
                           m_1_value,
                            m_2_value,
                            m_3_value,
                            m_4_value,
                            m_5_value,
                            m_6_value,
                            m_7_value,
                            m_8_value,
                            m_9_value,
                            m_10_value,
                            m_11_value,
                            m_12_value
                        )
                        select sys_guid(),
                        '''||V_NEW_GUID||''',
                        '''||config.item_id||''',
                        '''||config.templet_item_id||''',
                        round(d.m_1_value * '||config.item_value||',2),
                        round(d.m_2_value * '||config.item_value||',2),
                        round(d.m_3_value * '||config.item_value||',2),
                        round(d.m_4_value * '||config.item_value||',2),
                        round(d.m_5_value * '||config.item_value||',2),
                        round(d.m_6_value * '||config.item_value||',2),
                        round(d.m_7_value * '||config.item_value||',2),
                        round(d.m_8_value * '||config.item_value||',2),
                        round(d.m_9_value * '||config.item_value||',2),
                        round(d.m_10_value * '||config.item_value||',2),
                        round(d.m_11_value * '||config.item_value||',2),
                        round(d.m_12_value * '||config.item_value||',2)
                        from bgt_d_budget_cpn_year_r_i d                                 
                        where d.item_id = '''||config.item_id||'''
                        and d.base_id = (select id from bgt_d_budget_cpn_year_r r
                        where r.budget_year = '''||V_BUDGET_YEAR||'''
                        and r.budget_contents_id = ''00120003'')
                      
                        ';
                    end;
                  end if;
                  --00230002  历史数据
                  if config.resolve_method_id = '00230002'  then
                    begin
                      execute immediate 'insert into BGT_B_cpn_pay_MON_D
                        (
                          id ,
                          base_id ,
                          item_id,
                          templet_item_id,
                          m_1_value,
                            m_2_value,
                            m_3_value,
                            m_4_value,
                            m_5_value,
                            m_6_value,
                            m_7_value,
                            m_8_value,
                            m_9_value,
                            m_10_value,
                            m_11_value,
                            m_12_value
                        )
                        select sys_guid(),
                        '''||V_NEW_GUID||''',
                        '''||config.item_id||''',
                        '''||config.templet_item_id||''',
                        t.m_1_value,
                            t.m_2_value,
                            t.m_3_value,
                            t.m_4_value,
                            t.m_5_value,
                            t.m_6_value,
                            t.m_7_value,
                            t.m_8_value,
                            t.m_9_value,
                            t.m_10_value,
                            t.m_11_value,
                            t.m_12_value
                        from BGT_B_cpn_HIS_DATA_D t
                        where
                        t.base_id = (select t.id from BGT_B_cpn_HIS_DATA t
                        where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                        and t.budget_contents_id = ''00120003'')
                        and t.item_id = '''||config.item_id||'''
                        ';
                    end;
                  end if;
                  --00230003  历史数据*比例系数
                  if config.resolve_method_id = '00230003'  then
                    begin
                      --取比例系数
                      execute immediate 'select d.m_1_value,
                            d.m_2_value,
                            d.m_3_value,
                            d.m_4_value,
                            d.m_5_value,
                            d.m_6_value,
                            d.m_7_value,
                            d.m_8_value,
                            d.m_9_value,
                            d.m_10_value,
                            d.m_11_value,
                            d.m_12_value
                        from bgt_d_budget_cpn_year_r_i d
                                 
                        where d.item_id = '''||config.item_id||'''
                        and d.base_id = (select id from bgt_d_budget_cpn_year_r r
                        where r.budget_year = '''||V_BUDGET_YEAR||'''
                        and r.budget_contents_id = ''00120003'')
                        ' into V_TEMP_NUM_1,V_TEMP_NUM_2,V_TEMP_NUM_3,V_TEMP_NUM_4,
                        V_TEMP_NUM_5,V_TEMP_NUM_6,V_TEMP_NUM_7,V_TEMP_NUM_8,
                        V_TEMP_NUM_9,V_TEMP_NUM_10,V_TEMP_NUM_11,V_TEMP_NUM_12;
                      execute immediate 'insert into BGT_B_cpn_pay_MON_D
                        (
                          id ,
                          base_id ,
                          item_id,
                          templet_item_id,
                           m_1_value,
                            m_2_value,
                            m_3_value,
                            m_4_value,
                            m_5_value,
                            m_6_value,
                            m_7_value,
                            m_8_value,
                            m_9_value,
                            m_10_value,
                            m_11_value,
                            m_12_value
                        )
                        select sys_guid(),
                        '''||V_NEW_GUID||''',
                        '''||config.item_id||''',
                        '''||config.templet_item_id||''',
                        round(t.m_1_value * '||V_TEMP_NUM_1||',2),
                        round(t.m_2_value * '||V_TEMP_NUM_2||',2),
                        round(t.m_3_value * '||V_TEMP_NUM_3||',2),
                        round(t.m_4_value * '||V_TEMP_NUM_4||',2),
                        round(t.m_5_value * '||V_TEMP_NUM_5||',2),
                        round(t.m_6_value * '||V_TEMP_NUM_6||',2),
                        round(t.m_7_value * '||V_TEMP_NUM_7||',2),
                        round(t.m_8_value * '||V_TEMP_NUM_8||',2),
                        round(t.m_9_value * '||V_TEMP_NUM_9||',2),
                        round(t.m_10_value * '||V_TEMP_NUM_10||',2),
                        round(t.m_11_value * '||V_TEMP_NUM_11||',2),
                        round(t.m_12_value * '||V_TEMP_NUM_12||',2)
                        from BGT_B_cpn_HIS_DATA_D t
                        where
                        t.base_id = (select t.id from BGT_B_cpn_HIS_DATA t
                        where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                        and t.budget_contents_id = ''00120002'')
                        and t.item_id = '''||config.item_id||'''
                        ';
                    end;
                  end if;
                  --00230004  全面贯彻：复制年计划值
                  if config.resolve_method_id = '00230004'  then
                    begin
                      execute immediate 'insert into BGT_B_cpn_pay_MON_D
                        (
                          id ,
                          base_id ,
                          item_id,
                          templet_item_id,
                           m_1_value,
                            m_2_value,
                            m_3_value,
                            m_4_value,
                            m_5_value,
                            m_6_value,
                            m_7_value,
                            m_8_value,
                            m_9_value,
                            m_10_value,
                            m_11_value,
                            m_12_value
                        )
                        select sys_guid(),
                        '''||V_NEW_GUID||''',
                        '''||config.item_id||''',
                        '''||config.templet_item_id||''',
                        '||config.item_value||',
                        '||config.item_value||',
                        '||config.item_value||',
                        '||config.item_value||',
                        '||config.item_value||',
                        '||config.item_value||',
                        '||config.item_value||',
                        '||config.item_value||',
                        '||config.item_value||',
                        '||config.item_value||',
                        '||config.item_value||',
                        '||config.item_value||'
                        from dual
                        ';
                    end;
                  end if;
                  --00230005  均摊：年计划值除以12
                  if config.resolve_method_id = '00230005'  then
                    begin
                       execute immediate 'insert into BGT_B_cpn_pay_MON_D
                        (
                          id ,
                          base_id ,
                          item_id,
                          templet_item_id,
                           m_1_value,
                            m_2_value,
                            m_3_value,
                            m_4_value,
                            m_5_value,
                            m_6_value,
                            m_7_value,
                            m_8_value,
                            m_9_value,
                            m_10_value,
                            m_11_value,
                            m_12_value
                        )
                        select sys_guid(),
                        '''||V_NEW_GUID||''',
                        '''||config.item_id||''',
                        '''||config.templet_item_id||''',
                        round('||config.item_value||'/12,2),
                        round('||config.item_value||'/12,2),
                        round('||config.item_value||'/12,2),
                        round('||config.item_value||'/12,2),
                        round('||config.item_value||'/12,2),
                        round('||config.item_value||'/12,2),
                        round('||config.item_value||'/12,2),
                        round('||config.item_value||'/12,2),
                        round('||config.item_value||'/12,2),
                        round('||config.item_value||'/12,2),
                        round('||config.item_value||'/12,2),
                        round('||config.item_value||'/12,2)
                        from dual
                        ';
                    end;
                  end if;
            end loop;
          end;
    elsif v_PATTERN = '00170002' then --自下而上
           begin
              
             
              --遍历预算月份记录,逐月进行分解
              --插入从表
              --遍历【年预算】中的预算指标,逐个指标进行分解
              for config in(
                  select
                  p.item_id,
                  p.templet_item_id,
                  ri.resolve_method_id,
                  t2.DATA_TYPE_ID as planitemtype
                  from  Bgt_b_dept_pay_mon_d p,
                  bgt_b_dept_pay_mon pb,
                  BGT_D_BUDGET_cpn_YEAR_R r,
                  BGT_D_BUDGET_cpn_YEAR_R_i ri,
                  bgt_d_budget_item t2
                  where p.base_id = pb.id
                  and pb.budget_year = p_yearid
                  and pb.is_function = 1 --职能科室
                  and r.id = ri.base_id
                  and ri.item_id = p.item_id
                  and r.budget_year = p_yearid
                  and p.item_id = t2.id
                  and r.budget_contents_id = '00120003' --支出预算
                )
                loop
                    if config.planitemtype = '00210001' then --可累加
                       begin
                           V_DYNA_SQL:= 'insert into BGT_B_cpn_pay_MON_D
                                        (
                                          id ,
                                          base_id ,
                                          item_id,
                                          templet_item_id,
                                           m_1_value,
                                            m_2_value,
                                            m_3_value,
                                            m_4_value,
                                            m_5_value,
                                            m_6_value,
                                            m_7_value,
                                            m_8_value,
                                            m_9_value,
                                            m_10_value,
                                            m_11_value,
                                            m_12_value
                                        )
                                        select sys_guid(),
                                        '''||V_NEW_GUID||''',
                                        '''||config.item_id||''',
                                        '''||config.templet_item_id||''',
                                        sum(m_1_value) ,
                                           sum(m_2_value),
                                           sum(m_3_value),
                                           sum(m_4_value),
                                           sum(m_5_value),
                                           sum(m_6_value),
                                           sum(m_7_value),
                                           sum(m_8_value),
                                           sum(m_9_value),
                                           sum(m_10_value),
                                           sum(m_11_value),
                                           sum(m_12_value)
                                           from BGT_B_DEPT_pay_mon_D
                                           where ITEM_ID = '''||config.item_id||'''
                                           and BASE_ID in
                                           (
                                             select t.id
                                             from
                                             BGT_B_DEPT_pay_mon t,bgt_d_budget_dept t1
                                             where t.BUDGET_YEAR ='''||p_yearid||'''
                                             and t1.is_function = 1
                                             and t1.id = t.BUDGET_DEPT_ID
                                           )
                                           group by ITEM_ID';
                           end;
                    else --状态值
                       begin
                           V_DYNA_SQL:='insert into BGT_B_cpn_pay_MON_D
                                        (
                                          id ,
                                          base_id ,
                                          item_id,
                                          templet_item_id,
                                          m_1_value,
                                            m_2_value,
                                            m_3_value,
                                            m_4_value,
                                            m_5_value,
                                            m_6_value,
                                            m_7_value,
                                            m_8_value,
                                            m_9_value,
                                            m_10_value,
                                            m_11_value,
                                            m_12_value
                                        )
                                        select sys_guid(),
                                        '''||V_NEW_GUID||''',
                                        '''||config.item_id||''',
                                        '''||config.templet_item_id||''',
                                           avg(m_1_value) ,
                                           avg(m_2_value) ,
                                           avg(m_3_value) ,
                                           avg(m_4_value) ,
                                           avg(m_5_value) ,
                                           avg(m_6_value) ,
                                           avg(m_7_value) ,
                                           avg(m_8_value) ,
                                           avg(m_9_value) ,
                                           avg(m_10_value) ,
                                           avg(m_11_value) ,
                                           avg(m_12_value) 
                                           from BGT_B_DEPT_pay_mon_D
                                           where ITEM_ID = '''||config.item_id||'''
                                           and BASE_ID in
                                           (
                                             select t.id
                                             from
                                             BGT_B_DEPT_pay_mon t,bgt_d_budget_dept t1
                                             where t.BUDGET_YEAR ='''||p_yearid||'''
                                             and t1.is_function = 1
                                             and t1.id = t.BUDGET_DEPT_ID
                                           )
                                           group by ITEM_ID';
                        end;
                    end if;
                    --dbms_output.put_line(V_DYNA_SQL);
                    execute immediate V_DYNA_SQL;
                end loop;
          end;
     end if;
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Cal_cpn_pay_month;


create or replace procedure SP_bgt_Cal_dept_plan_year(p_planid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_YEAR char(36);
V_BUDGET_DEPT_ID char(36);
V_BUDGET_TEMPLET_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
v_PATTERN char(36);
V_LEVEL char(36);
/*
1、自下而上模式，科室年度计划是编制的起点
2、自上而下模式，科室年度计划(仅业务科室)由单位年度计划分解而来
*/
begin
    --变量初始化
    execute immediate ' 
    select BUDGET_YEAR,TEMPLET_ID,BUDGET_DEPT_ID from BGT_B_DEPT_PLAN_YEAR where id ='''||p_planid||''''
    into V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID,V_BUDGET_DEPT_ID;  
    --获取编制模式,编制层次    
    execute immediate 'select INCOME_PATTERN_ID,INCOME_LEVEL_ID from BGT_D_BUDGET_PATTERN
    where BUDGET_YEAR = '''||V_BUDGET_YEAR||'''' into v_PATTERN,V_LEVEL;   
    --删除子项
    V_DYNA_SQL:= 'delete from BGT_B_DEPT_PLAN_YEAR_D where BASE_ID =''' || p_planid||'''';
    dbms_output.put_line(V_DYNA_SQL);
    execute immediate V_DYNA_SQL;
    --从模板复制子项
    V_DYNA_SQL:= 'insert into BGT_B_DEPT_PLAN_YEAR_D(id,BASE_ID,ITEM_ID,TEMPLET_ITEM_ID)
    select sys_guid(), '''||p_planid||''',t.ITEM_ID,t.ID from BGT_D_BUDGET_T_D t 
    where t.BASE_ID = ''' || V_BUDGET_TEMPLET_ID||'''';
    dbms_output.put_line(V_DYNA_SQL);
    execute immediate V_DYNA_SQL;
    --获取历史预算年
    execute immediate 'select t.id from BGT_D_BUDGET_YEAR t, BGT_D_BUDGET_YEAR t1
    where t1.ID = ''' || V_BUDGET_YEAR||'''
    and t.BUDGET_YEAR = t1.BUDGET_YEAR - 1 ' into V_PRE_BUDGET_YEAR;
    --遍历子项,对子项进行逐项计算
    for config in(
                    select 
                    t.id,
                    t.base_id,
                    t.item_id,
                    t.calculate_index,
                    t.prepare_method_id,
                    t.calculate_method_id,
                    t.calculate_formula,
                    t.consult,
                    t1.id as planitemid,
                    t2.DATA_TYPE_ID as planitemtype
                    from  BGT_D_BUDGET_T_D t,
                    BGT_B_dept_PLAN_YEAR_D t1,
                    bgt_d_plan_item t2
                    where t.id = t1.templet_item_id
                    and t.item_id = t2.id
                    and  t1.base_id = p_planid          
                    
                  )
          loop  
             if v_PATTERN = '00170001' then --自上而下
                begin
                                     V_DYNA_SQL:='update BGT_B_DEPT_PLAN_YEAR_D set
                                        ITEM_VALUE = (
                                                         select decode(pyd.item_value,0,0,pyd.item_value/count(bd.id))
                                                         from bgt_d_budget_dept bd,
                                                         BGT_B_CPN_PLAN_YEAR py,
                                                         BGT_B_CPN_PLAN_YEAR_D pyd
                                                         where bd.is_function = 2                                                        
                                                         and bd.budget_year = '''||V_BUDGET_YEAR||'''
                                                         and pyd.item_id = '''||config.item_id||'''
                                                         and py.budget_year = bd.budget_year                                                        
                                                         group by pyd.item_value
                                                   )                                          
                                        where id =''' || config.planitemid ||'''';                                    
                                    dbms_output.put_line(V_DYNA_SQL);
                                    execute immediate V_DYNA_SQL;               
                               end;
             elsif v_PATTERN = '00170002' then --自下而上
               begin
                    --公式计算'00110002'
                    if config.calculate_method_id = '00110002'  then
                      begin
                        execute immediate 'select sys_guid() from dual';
                      end;             
                    --历史数据*比例系数'00110003'
                    elsif  config.calculate_method_id = '00110003'  then 
                      begin     
                        if config.planitemtype = '00210001' then --可累加
                           begin                  
                                V_DYNA_SQL:= 'update BGT_B_DEPT_PLAN_YEAR_D set
                                          item_value = (
                                                         select sum(m_1_value)
                                                            + sum(m_2_value)
                                                            + sum(m_3_value)
                                                            + sum(m_4_value)
                                                            + sum(m_5_value)
                                                            + sum(m_6_value)
                                                            + sum(m_7_value)
                                                            + sum(m_8_value)
                                                            + sum(m_9_value)
                                                            + sum(m_10_value)
                                                            + sum(m_11_value)
                                                            + sum(m_12_value) from BGT_B_DEPT_HIS_DATA_D
                                                         where ITEM_ID = '''||config.item_id||'''
                                                         and BASE_ID in 
                                                         (
                                                           select id 
                                                           from
                                                           BGT_B_DEPT_HIS_DATA
                                                           where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||''' 
                                                           and BUDGET_DEPT_ID ='''||V_BUDGET_DEPT_ID||''' 
                                                           and BUDGET_CONTENTS_ID = ''00120001'' 
                                                         )
                                                         group by ITEM_ID
                                                     ) * (select nvl(t1.INCREASE_SCALE,1 )
                                                          from BGT_D_BUDGET_T_DEPT_I t,BGT_D_BUDGET_T_DEPT_I_D t1
                                                          where t.BASE_ID = '''||V_BUDGET_TEMPLET_ID||'''
                                                          and t.id = t1.base_id
                                                          and  t.BUDGET_DEPT_ID =  '''||V_BUDGET_DEPT_ID||'''
                                                          and t1.ITEM_ID = '''||config.item_id||''')                                   
                                          where id =''' || config.planitemid ||'''';
                                  end;
                              else --状态值
                                  begin
                                      V_DYNA_SQL:= 'update BGT_B_DEPT_PLAN_YEAR_D set
                                          item_value = (
                                                         select 
                                                         
                                                         avg(
                                                         m_1_value + m_2_value+ m_3_value+m_4_value+m_5_value
                                                         +m_6_value+m_7_value+m_8_value+m_9_value+m_10_value
                                                         +m_11_value+m_12_value
                                                         )/12 from BGT_B_DEPT_HIS_DATA_D
                                                         where ITEM_ID = '''||config.item_id||'''
                                                         and BASE_ID in 
                                                         (
                                                           select id 
                                                           from
                                                           BGT_B_DEPT_HIS_DATA
                                                           where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||''' 
                                                           and BUDGET_DEPT_ID ='''||V_BUDGET_DEPT_ID||''' 
                                                           and BUDGET_CONTENTS_ID = ''00120001'' 
                                                         )
                                                         group by ITEM_ID
                                                     ) * (select nvl(t1.INCREASE_SCALE,1 )
                                                          from BGT_D_BUDGET_T_DEPT_I t,BGT_D_BUDGET_T_DEPT_I_D t1 
                                                          where t.BASE_ID = '''||V_BUDGET_TEMPLET_ID||'''
                                                          and t.id = t1.base_id
                                                          and  t.BUDGET_DEPT_ID =  '''||V_BUDGET_DEPT_ID||'''
                                                          and t1.ITEM_ID = '''||config.item_id||''')                                   
                                          where id =''' || config.planitemid ||'''';
                                  end;
                              end if;
                        --dbms_output.put_line(V_DYNA_SQL);
                        execute immediate V_DYNA_SQL;
                      end;             
                     --历史数据 '00110004'
                    elsif config.calculate_method_id = '00110004' then
                      begin
                           if config.planitemtype = '00210001' then --可累加
                              begin    
                                V_DYNA_SQL:='update BGT_B_DEPT_PLAN_YEAR_D set
                                      item_value = (
                                                     select sum(m_1_value)
                                                            + sum(m_2_value)
                                                            + sum(m_3_value)
                                                            + sum(m_4_value)
                                                            + sum(m_5_value)
                                                            + sum(m_6_value)
                                                            + sum(m_7_value)
                                                            + sum(m_8_value)
                                                            + sum(m_9_value)
                                                            + sum(m_10_value)
                                                            + sum(m_11_value)
                                                            + sum(m_12_value) from BGT_B_DEPT_HIS_DATA_D
                                                     where ITEM_ID = '''||config.item_id||'''
                                                     and BASE_ID in 
                                                     (
                                                       select id 
                                                       from
                                                       BGT_B_DEPT_HIS_DATA
                                                       where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||''' 
                                                       and BUDGET_DEPT_ID ='''||V_BUDGET_DEPT_ID||'''  
                                                       and BUDGET_CONTENTS_ID = ''00120001''
                                                     )
                                                     group by ITEM_ID
                                                 )
                                      
                                      where id =''' || config.planitemid ||'''';
                                  end;
                              else --状态值
                                  begin
                                     V_DYNA_SQL:='update BGT_B_DEPT_PLAN_YEAR_D set
                                      item_value = (
                                                     select avg(  m_1_value + m_2_value+ m_3_value+m_4_value+m_5_value
                                                         +m_6_value+m_7_value+m_8_value+m_9_value+m_10_value
                                                         +m_11_value+m_12_value)/12 from BGT_B_DEPT_HIS_DATA_D
                                                     where ITEM_ID = '''||config.item_id||'''
                                                     and BASE_ID in 
                                                     (
                                                       select id 
                                                       from
                                                       BGT_B_DEPT_HIS_DATA
                                                       where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||''' 
                                                       and BUDGET_DEPT_ID ='''||V_BUDGET_DEPT_ID||'''  
                                                       and BUDGET_CONTENTS_ID = ''00120001''
                                                     )
                                                     group by ITEM_ID
                                                 )
                                      
                                      where id =''' || config.planitemid ||'''';
                                  end;
                              end if;                                  
                        --dbms_output.put_line(V_DYNA_SQL);
                        execute immediate V_DYNA_SQL;
                      end;             
                     --历史数据分解上级科目'00110005'
                    elsif config.calculate_method_id = '00110005'  then
                      begin
                        execute immediate 'select sys_guid() from dual';
                      end;             
                     --手工输入'00110001'
                    else
                      begin
                        execute immediate 'select sys_guid() from dual';
                      end;
                    end if;         
               end;
             end if;
          end loop;    
      p_msg:= '';
      p_succeed := 1;--返回成功   
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Cal_dept_plan_year;


create or replace procedure SP_bgt_Cal_dept_plan_month(p_yearid in char,p_deptid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_NEW_GUID varchar2(36);
V_NEW_M_GUID varchar2(36);
V_TEMP_NUM_1 number(22,4);
V_TEMP_NUM_2 number(22,4);
V_TEMP_NUM_3 number(22,4);
V_TEMP_NUM_4 number(22,4);
V_TEMP_NUM_5 number(22,4);
V_TEMP_NUM_6 number(22,4);
V_TEMP_NUM_7 number(22,4);
V_TEMP_NUM_8 number(22,4);
V_TEMP_NUM_9 number(22,4);
V_TEMP_NUM_10 number(22,4);
V_TEMP_NUM_11 number(22,4);
V_TEMP_NUM_12 number(22,4);
V_BUDGET_YEAR_PLAN_ID char(36);
V_BUDGET_YEAR char(36);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_DEPT_ID char(36);
V_BUDGET_TEMPLET_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
v_PATTERN char(36);
V_LEVEL char(36);
/*
1、自下而上模式，科室月份计划由科室年度计划分解计算而来（需要区分指标的数据类型）
2、自上而下模式，同上
*/
begin
    --变量初始化
    execute immediate 'select id,BUDGET_YEAR,TEMPLET_ID,BUDGET_DEPT_ID from BGT_B_DEPT_PLAN_YEAR where BUDGET_YEAR='''||p_yearid||''' and BUDGET_DEPT_ID ='''||p_deptid||''' and rownum = 1'
    into V_BUDGET_YEAR_PLAN_ID,V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID,V_BUDGET_DEPT_ID;
    --获取编制模式,编制层次    
    execute immediate 'select INCOME_PATTERN_ID,INCOME_LEVEL_ID from BGT_D_BUDGET_PATTERN
    where BUDGET_YEAR = '''||V_BUDGET_YEAR||'''' into v_PATTERN,V_LEVEL;   
    --查询月份记录
    execute immediate 'select id from BGT_B_DEPT_plan_MON where BUDGET_YEAR='''||p_yearid||''' and BUDGET_DEPT_ID ='''||p_deptid||''''
    into V_NEW_GUID;
    --删除明细记录
    execute immediate 'delete  from BGT_B_DEPT_plan_MON_D where base_id='''||V_NEW_GUID||'''';
     --获取历史预算年
    execute immediate 'select t.id from BGT_D_BUDGET_YEAR t, BGT_D_BUDGET_YEAR t1
    where t1.ID = ''' || V_BUDGET_YEAR||'''
    and t.BUDGET_YEAR = t1.BUDGET_YEAR - 1 ' into V_PRE_BUDGET_YEAR;
          --插入从表
          --遍历【年计划】中的计划指标,逐个指标进行分解
          for config in(
              select
              p.item_id,
              nvl(p.item_value,0) item_value ,
              p.templet_item_id,
              ri.resolve_method_id
              from  Bgt_b_Dept_Plan_Year_d p,
              BGT_D_BUDGET_DEPT_YEAR_R r,
              BGT_D_BUDGET_DEPT_YEAR_R_i ri
              where p.base_id = V_BUDGET_YEAR_PLAN_ID
              and r.id = ri.base_id
              and ri.item_id = p.item_id
              and r.budget_year = p_yearid
              and r.budget_dept_id = p_deptid
              and r.budget_contents_id = '00120001' --事业计划
            )
            loop
                  if v_PATTERN = '00170001' then --自上而下
                      begin
                            --00230001  比例系数
                            if config.resolve_method_id = '00230001'  then
                              begin
                                execute immediate 'insert into BGT_B_DEPT_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                      m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round(d.m_1_value * '||config.item_value||',2),
                                  round(d.m_2_value * '||config.item_value||',2),
                                  round(d.m_3_value * '||config.item_value||',2),
                                  round(d.m_4_value * '||config.item_value||',2),
                                  round(d.m_5_value * '||config.item_value||',2),
                                  round(d.m_6_value * '||config.item_value||',2),
                                  round(d.m_7_value * '||config.item_value||',2),
                                  round(d.m_8_value * '||config.item_value||',2),
                                  round(d.m_9_value * '||config.item_value||',2),
                                  round(d.m_10_value * '||config.item_value||',2),
                                  round(d.m_11_value * '||config.item_value||',2),
                                  round(d.m_12_value * '||config.item_value||',2)
                                  from bgt_d_budget_dept_year_r_i d
                                 
                                  where d.item_id = '''||config.item_id||'''
                                  and d.base_id = (select id from bgt_d_budget_dept_year_r r
                                  where r.budget_year = '''||V_BUDGET_YEAR||'''
                                  and r.budget_dept_id = '''||p_deptid||'''
                                  and r.budget_contents_id = ''00120001'')
                                  
                                  ';
                              end;
                            end if;
                            --00230002  历史数据
                            if config.resolve_method_id = '00230002'  then
                              begin
                                execute immediate 'insert into BGT_B_DEPT_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                   t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value
                                  from BGT_B_DEPT_HIS_DATA_D t
                                  where 
                                  t.base_id = (select t.id from BGT_B_DEPT_HIS_DATA t
                                  where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                  and t.budget_dept_id = '''||p_deptid||'''
                                  and t.budget_contents_id = ''00120001'')
                                  and t.item_id = '''||config.item_id||'''
                                  ';
                              end;
                            end if;
                            --00230003  历史数据*比例系数
                            if config.resolve_method_id = '00230003'  then
                              begin
                                --取比例系数
                                execute immediate 'select 
                                      d.m_1_value,
                                      d.m_2_value,
                                      d.m_3_value,
                                      d.m_4_value,
                                      d.m_5_value,
                                      d.m_6_value,
                                      d.m_7_value,
                                      d.m_8_value,
                                      d.m_9_value,
                                      d.m_10_value,
                                      d.m_11_value,
                                      d.m_12_value
                                  from bgt_d_budget_dept_year_r_i d
                                 
                                  where d.item_id = '''||config.item_id||'''
                                  and d.base_id = (select id from bgt_d_budget_dept_year_r r
                                  where r.budget_year = '''||V_BUDGET_YEAR||'''
                                  and r.budget_dept_id = '''||p_deptid||'''
                                  and r.budget_contents_id = ''00120001'')
                                  ' into V_TEMP_NUM_1,V_TEMP_NUM_2,V_TEMP_NUM_3,V_TEMP_NUM_4,V_TEMP_NUM_5,
                                  V_TEMP_NUM_6,V_TEMP_NUM_7,V_TEMP_NUM_8,V_TEMP_NUM_9,V_TEMP_NUM_10,
                                  V_TEMP_NUM_11,V_TEMP_NUM_12;
                                execute immediate 'insert into BGT_B_DEPT_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round(t.m_1_value * '||V_TEMP_NUM_1||',2),
                                  round(t.m_2_value * '||V_TEMP_NUM_2||',2),
                                  round(t.m_3_value * '||V_TEMP_NUM_3||',2),
                                  round(t.m_4_value * '||V_TEMP_NUM_4||',2),
                                  round(t.m_5_value * '||V_TEMP_NUM_5||',2),
                                  round(t.m_6_value * '||V_TEMP_NUM_6||',2),
                                  round(t.m_7_value * '||V_TEMP_NUM_7||',2),
                                  round(t.m_8_value * '||V_TEMP_NUM_8||',2),
                                  round(t.m_9_value * '||V_TEMP_NUM_9||',2),
                                  round(t.m_10_value * '||V_TEMP_NUM_10||',2),
                                  round(t.m_11_value * '||V_TEMP_NUM_11||',2),
                                  round(t.m_12_value * '||V_TEMP_NUM_12||',2)
                                  from BGT_B_DEPT_HIS_DATA_D t
                                  where 
                                  t.base_id = (select t.id from BGT_B_DEPT_HIS_DATA t
                                  where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                  and t.budget_dept_id = '''||p_deptid||'''
                                  and t.budget_contents_id = ''00120001'')
                                  and t.item_id = '''||config.item_id||'''
                                  ';
                              end;
                            end if;
                            --00230004  全面贯彻：复制年计划值
                            if config.resolve_method_id = '00230004'  then
                              begin
                                execute immediate 'insert into BGT_B_DEPT_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||'
                                  from dual
                                  ';
                              end;
                            end if;
                            --00230005	均摊：年计划值除以12
                            if config.resolve_method_id = '00230005'  then
                              begin
                                 execute immediate 'insert into BGT_B_DEPT_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                      m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2)
                                  from dual
                                  ';
                              end;
                            end if;
                       end;
                 elsif v_PATTERN = '00170002' then --自下而上
                       begin
                            --00230001  比例系数
                            if config.resolve_method_id = '00230001'  then
                              begin
                                execute immediate 'insert into BGT_B_DEPT_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                      m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round(d.m_1_value * '||config.item_value||',2),
                                  round(d.m_2_value * '||config.item_value||',2),
                                  round(d.m_3_value * '||config.item_value||',2),
                                  round(d.m_4_value * '||config.item_value||',2),
                                  round(d.m_5_value * '||config.item_value||',2),
                                  round(d.m_6_value * '||config.item_value||',2),
                                  round(d.m_7_value * '||config.item_value||',2),
                                  round(d.m_8_value * '||config.item_value||',2),
                                  round(d.m_9_value * '||config.item_value||',2),
                                  round(d.m_10_value * '||config.item_value||',2),
                                  round(d.m_11_value * '||config.item_value||',2),
                                  round(d.m_12_value * '||config.item_value||',2)
                                  from bgt_d_budget_dept_year_r_i d
                                 
                                  where d.item_id = '''||config.item_id||'''
                                  and d.base_id = (select id from bgt_d_budget_dept_year_r r
                                  where r.budget_year = '''||V_BUDGET_YEAR||'''
                                  and r.budget_dept_id = '''||p_deptid||'''
                                  and r.budget_contents_id = ''00120001'')
                                  
                                  ';
                              end;
                            end if;
                            --00230002  历史数据
                            if config.resolve_method_id = '00230002'  then
                              begin
                                execute immediate 'insert into BGT_B_DEPT_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                   t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value
                                  from BGT_B_DEPT_HIS_DATA_D t
                                  where 
                                  t.base_id = (select t.id from BGT_B_DEPT_HIS_DATA t
                                  where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                  and t.budget_dept_id = '''||p_deptid||'''
                                  and t.budget_contents_id = ''00120001'')
                                  and t.item_id = '''||config.item_id||'''
                                  ';
                              end;
                            end if;
                            --00230003  历史数据*比例系数
                            if config.resolve_method_id = '00230003'  then
                              begin
                                --取比例系数
                                execute immediate 'select 
                                      d.m_1_value,
                                      d.m_2_value,
                                      d.m_3_value,
                                      d.m_4_value,
                                      d.m_5_value,
                                      d.m_6_value,
                                      d.m_7_value,
                                      d.m_8_value,
                                      d.m_9_value,
                                      d.m_10_value,
                                      d.m_11_value,
                                      d.m_12_value
                                  from bgt_d_budget_dept_year_r_i d
                                 
                                  where d.item_id = '''||config.item_id||'''
                                  and d.base_id = (select id from bgt_d_budget_dept_year_r r
                                  where r.budget_year = '''||V_BUDGET_YEAR||'''
                                  and r.budget_dept_id = '''||p_deptid||'''
                                  and r.budget_contents_id = ''00120001'')
                                  ' into V_TEMP_NUM_1,V_TEMP_NUM_2,V_TEMP_NUM_3,V_TEMP_NUM_4,V_TEMP_NUM_5,
                                  V_TEMP_NUM_6,V_TEMP_NUM_7,V_TEMP_NUM_8,V_TEMP_NUM_9,V_TEMP_NUM_10,
                                  V_TEMP_NUM_11,V_TEMP_NUM_12;
                                execute immediate 'insert into BGT_B_DEPT_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round(t.m_1_value * '||V_TEMP_NUM_1||',2),
                                  round(t.m_2_value * '||V_TEMP_NUM_2||',2),
                                  round(t.m_3_value * '||V_TEMP_NUM_3||',2),
                                  round(t.m_4_value * '||V_TEMP_NUM_4||',2),
                                  round(t.m_5_value * '||V_TEMP_NUM_5||',2),
                                  round(t.m_6_value * '||V_TEMP_NUM_6||',2),
                                  round(t.m_7_value * '||V_TEMP_NUM_7||',2),
                                  round(t.m_8_value * '||V_TEMP_NUM_8||',2),
                                  round(t.m_9_value * '||V_TEMP_NUM_9||',2),
                                  round(t.m_10_value * '||V_TEMP_NUM_10||',2),
                                  round(t.m_11_value * '||V_TEMP_NUM_11||',2),
                                  round(t.m_12_value * '||V_TEMP_NUM_12||',2)
                                  from BGT_B_DEPT_HIS_DATA_D t
                                  where 
                                  t.base_id = (select t.id from BGT_B_DEPT_HIS_DATA t
                                  where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                  and t.budget_dept_id = '''||p_deptid||'''
                                  and t.budget_contents_id = ''00120001'')
                                  and t.item_id = '''||config.item_id||'''
                                  ';
                              end;
                            end if;
                            --00230004	全面贯彻：复制年计划值
                            if config.resolve_method_id = '00230004'  then
                              begin
                                execute immediate 'insert into BGT_B_DEPT_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||'
                                  from dual
                                  ';
                              end;
                            end if;
                            --00230005	均摊：年计划值除以12
                            if config.resolve_method_id = '00230005'  then
                              begin
                                 execute immediate 'insert into BGT_B_DEPT_PLAN_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                      m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2)
                                  from dual
                                  ';
                              end;
                            end if;
                       end;
                 end if;
                  
            end loop;
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Cal_dept_plan_month;


create or replace procedure SP_bgt_Cal_dept_inc_year(p_planid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_YEAR char(36);
V_BUDGET_DEPT_ID char(36);
V_BUDGET_TEMPLET_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
v_PATTERN char(36);
V_LEVEL char(36);
/*
1、自下而上模式，科室年度收入是编制的起点，编制起点时，无需判断指标数据类型是否【可累加】或者【状态值】
2、自上而下模式，科室年度收入(仅业务科室)由单位年度收入分解而来
*/
begin
    --变量初始化
    execute immediate '
    select BUDGET_YEAR,TEMPLET_ID,BUDGET_DEPT_ID from BGT_B_DEPT_INC_YEAR where id ='''||p_planid||''''
    into V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID,V_BUDGET_DEPT_ID;
    --获取编制模式,编制层次
    execute immediate 'select INCOME_PATTERN_ID,INCOME_LEVEL_ID from BGT_D_BUDGET_PATTERN
    where BUDGET_YEAR = '''||V_BUDGET_YEAR||'''' into v_PATTERN,V_LEVEL;
    --删除子项
    V_DYNA_SQL:= 'delete from BGT_B_DEPT_INC_YEAR_D where BASE_ID =''' || p_planid||'''';
    dbms_output.put_line(V_DYNA_SQL);
    execute immediate V_DYNA_SQL;
    --从模板复制子项
    V_DYNA_SQL:= 'insert into BGT_B_DEPT_INC_YEAR_D(id,BASE_ID,ITEM_ID,TEMPLET_ITEM_ID)
    select sys_guid(), '''||p_planid||''',t.ITEM_ID,t.ID from BGT_D_BUDGET_T_D t
    where t.BASE_ID = ''' || V_BUDGET_TEMPLET_ID||'''';
    dbms_output.put_line(V_DYNA_SQL);
    execute immediate V_DYNA_SQL;
    --获取历史预算年
    execute immediate 'select t.id from BGT_D_BUDGET_YEAR t, BGT_D_BUDGET_YEAR t1
    where t1.ID = ''' || V_BUDGET_YEAR||'''
    and t.BUDGET_YEAR = t1.BUDGET_YEAR - 1 ' into V_PRE_BUDGET_YEAR;
    --遍历子项,对子项进行逐项计算
    for config in(
                    select
                    t.id,
                    t.base_id,
                    t.item_id,
                    t.calculate_index,
                    t.prepare_method_id,
                    t.calculate_method_id,
                    t.calculate_formula,
                    t.consult,
                    t1.id as planitemid,
                    t2.DATA_TYPE_ID as planitemtype
                    from  BGT_D_BUDGET_T_D t,
                    BGT_B_dept_inc_YEAR_D t1,
                    bgt_d_budget_item t2
                    where t.id = t1.templet_item_id
                    and t.item_id = t2.id
                    and  t1.base_id = p_planid

                  )
          loop
             if v_PATTERN = '00170001' then --自上而下
                begin
                                     V_DYNA_SQL:='update BGT_B_DEPT_inc_YEAR_D set
                                        ITEM_VALUE = (
                                                         select decode(pyd.item_value,0,0,pyd.item_value/count(bd.id))
                                                         from bgt_d_budget_dept bd,
                                                         BGT_B_CPN_inc_YEAR py,
                                                         BGT_B_CPN_inc_YEAR_D pyd
                                                         where bd.is_function = 2                                                        
                                                         and bd.budget_year = '''||V_BUDGET_YEAR||'''
                                                         and pyd.item_id = '''||config.item_id||'''
                                                         and py.budget_year = bd.budget_year                                                        
                                                         group by pyd.item_value
                                                   )                                          
                                        where id =''' || config.planitemid ||'''';                                    
                                    dbms_output.put_line(V_DYNA_SQL);
                                    execute immediate V_DYNA_SQL;               
                               end;
             elsif v_PATTERN = '00170002' then --自下而上
               begin
                    --公式计算'00110002'
                    if config.calculate_method_id = '00110002'  then
                      begin
                        execute immediate 'select sys_guid() from dual';
                      end;
                    --历史数据*比例系数'00110003'
                    elsif  config.calculate_method_id = '00110003'  then
                      begin
                        V_DYNA_SQL:= 'update BGT_B_DEPT_inc_YEAR_D set
                                  ITEM_VALUE = (
                                                 select sum(m_1_value)
                                                    + sum(m_2_value)
                                                    + sum(m_3_value)
                                                    + sum(m_4_value)
                                                    + sum(m_5_value)
                                                    + sum(m_6_value)
                                                    + sum(m_7_value)
                                                    + sum(m_8_value)
                                                    + sum(m_9_value)
                                                    + sum(m_10_value)
                                                    + sum(m_11_value)
                                                    + sum(m_12_value) from BGT_B_DEPT_HIS_DATA_D
                                                 where ITEM_ID = '''||config.item_id||'''
                                                 and BASE_ID in
                                                 (
                                                   select id
                                                   from
                                                   BGT_B_DEPT_HIS_DATA
                                                   where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||'''
                                                   and BUDGET_DEPT_ID ='''||V_BUDGET_DEPT_ID||'''
                                                   and BUDGET_CONTENTS_ID = ''00120002''
                                                 )
                                                 group by ITEM_ID
                                             ) * (select nvl(t1.INCREASE_SCALE,1 )
                                                  from BGT_D_BUDGET_T_DEPT_I t,BGT_D_BUDGET_T_DEPT_I_D t1
                                                  where t.BASE_ID = '''||V_BUDGET_TEMPLET_ID||'''
                                                  and t.id = t1.base_id
                                                  and  t.BUDGET_DEPT_ID =  '''||V_BUDGET_DEPT_ID||'''
                                                  and t1.ITEM_ID = '''||config.item_id||''')
                                  where id =''' || config.planitemid ||'''';
                        dbms_output.put_line(V_DYNA_SQL);
                        execute immediate V_DYNA_SQL;
                      end;
                     --历史数据 '00110004'
                    elsif config.calculate_method_id = '00110004' then
                      begin
                        V_DYNA_SQL:='update BGT_B_DEPT_inc_YEAR_D set
                              ITEM_VALUE = (
                                             select sum(m_1_value)
                                                    + sum(m_2_value)
                                                    + sum(m_3_value)
                                                    + sum(m_4_value)
                                                    + sum(m_5_value)
                                                    + sum(m_6_value)
                                                    + sum(m_7_value)
                                                    + sum(m_8_value)
                                                    + sum(m_9_value)
                                                    + sum(m_10_value)
                                                    + sum(m_11_value)
                                                    + sum(m_12_value) from BGT_B_DEPT_HIS_DATA_D
                                             where ITEM_ID = '''||config.item_id||'''
                                             and BASE_ID in
                                             (
                                               select id
                                               from
                                               BGT_B_DEPT_HIS_DATA
                                               where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||'''
                                               and BUDGET_DEPT_ID ='''||V_BUDGET_DEPT_ID||'''
                                               and BUDGET_CONTENTS_ID = ''00120002''
                                             )
                                             group by ITEM_ID
                                         )
                              where id =''' || config.planitemid ||'''';
                        dbms_output.put_line(V_DYNA_SQL);
                        execute immediate V_DYNA_SQL;
                      end;
                     --历史数据分解上级科目'00110005'
                    elsif config.calculate_method_id = '00110005'  then
                      begin
                        execute immediate 'select sys_guid() from dual';
                      end;
                     --手工输入'00110001'
                    else
                      begin
                        execute immediate 'select sys_guid() from dual';
                      end;
                    end if;
               end;
             end if;
          end loop;
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Cal_dept_inc_year;


create or replace procedure SP_bgt_Cal_dept_inc_month(p_yearid in char,p_deptid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_NEW_GUID varchar2(36);
V_NEW_M_GUID varchar2(36);
V_TEMP_NUM_1 number(22,4);
V_TEMP_NUM_2 number(22,4);
V_TEMP_NUM_3 number(22,4);
V_TEMP_NUM_4 number(22,4);
V_TEMP_NUM_5 number(22,4);
V_TEMP_NUM_6 number(22,4);
V_TEMP_NUM_7 number(22,4);
V_TEMP_NUM_8 number(22,4);
V_TEMP_NUM_9 number(22,4);
V_TEMP_NUM_10 number(22,4);
V_TEMP_NUM_11 number(22,4);
V_TEMP_NUM_12 number(22,4);
V_BUDGET_YEAR_PLAN_ID char(36);
V_BUDGET_YEAR char(36);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_DEPT_ID char(36);
V_BUDGET_TEMPLET_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
v_PATTERN char(36);
V_LEVEL char(36);
/*
1、自下而上模式，科室月份收入由科室年度收入分解计算而来（需要区分指标的数据类型）
2、自上而下模式，同上
*/
begin
    --变量初始化
    execute immediate 'select id,BUDGET_YEAR,TEMPLET_ID,BUDGET_DEPT_ID from BGT_B_DEPT_inc_YEAR where BUDGET_YEAR='''||p_yearid||''' and BUDGET_DEPT_ID ='''||p_deptid||''' and rownum = 1'
    into V_BUDGET_YEAR_PLAN_ID,V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID,V_BUDGET_DEPT_ID;
    --获取编制模式,编制层次
    execute immediate 'select INCOME_PATTERN_ID,INCOME_LEVEL_ID from BGT_D_BUDGET_PATTERN
    where BUDGET_YEAR = '''||V_BUDGET_YEAR||'''' into v_PATTERN,V_LEVEL;
    --查询月份记录
    execute immediate 'select id from BGT_B_DEPT_inc_MON where BUDGET_YEAR='''||p_yearid||''' and BUDGET_DEPT_ID ='''||p_deptid||''''
    into V_NEW_GUID;
    --删除明细记录
    execute immediate 'delete  from BGT_B_DEPT_inc_MON_D where base_id='''||V_NEW_GUID||'''';
     --获取历史预算年
    execute immediate 'select t.id from BGT_D_BUDGET_YEAR t, BGT_D_BUDGET_YEAR t1
    where t1.ID = ''' || V_BUDGET_YEAR||'''
    and t.BUDGET_YEAR = t1.BUDGET_YEAR - 1 ' into V_PRE_BUDGET_YEAR;
    --遍历预算月份记录,逐月进行分解
        
          --插入从表
           --遍历【年预算】中的预算指标,逐个指标进行分解
          for config in(
              select
              p.item_id,
              nvl(p.item_value,0) item_value ,
              p.templet_item_id,
              ri.resolve_method_id
              from  Bgt_b_Dept_inc_Year_d p,
              BGT_D_BUDGET_DEPT_YEAR_R r,
              BGT_D_BUDGET_DEPT_YEAR_R_i ri
              where p.base_id = V_BUDGET_YEAR_PLAN_ID
              and r.id = ri.base_id
              and ri.item_id = p.item_id
              and r.budget_year = p_yearid
              and r.budget_dept_id = p_deptid
              and r.budget_contents_id = '00120002' --收入预算
            )
            loop
                  if v_PATTERN = '00170001' then --自上而下
                      begin
                            --00230001  比例系数
                            if config.resolve_method_id = '00230001'  then
                              begin
                                execute immediate 'insert into BGT_B_DEPT_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                      m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round(d.m_1_value * '||config.item_value||',2),
                                  round(d.m_2_value * '||config.item_value||',2),
                                  round(d.m_3_value * '||config.item_value||',2),
                                  round(d.m_4_value * '||config.item_value||',2),
                                  round(d.m_5_value * '||config.item_value||',2),
                                  round(d.m_6_value * '||config.item_value||',2),
                                  round(d.m_7_value * '||config.item_value||',2),
                                  round(d.m_8_value * '||config.item_value||',2),
                                  round(d.m_9_value * '||config.item_value||',2),
                                  round(d.m_10_value * '||config.item_value||',2),
                                  round(d.m_11_value * '||config.item_value||',2),
                                  round(d.m_12_value * '||config.item_value||',2)                              
                                  from bgt_d_budget_dept_year_r_i d
                                 
                                  where d.item_id = '''||config.item_id||'''
                                  and d.base_id = (select id from bgt_d_budget_dept_year_r r
                                  where r.budget_year = '''||V_BUDGET_YEAR||'''
                                  and r.budget_dept_id = '''||p_deptid||'''
                                  and r.budget_contents_id = ''00120002'')
                                  
                                  ';
                              end;
                            end if;
                            --00230002  历史数据
                            if config.resolve_method_id = '00230002'  then
                              begin
                                execute immediate 'insert into BGT_B_DEPT_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                   t.m_1_value,
                                   t.m_2_value,
                                   t.m_3_value,
                                   t.m_4_value,
                                   t.m_5_value,
                                   t.m_6_value,
                                   t.m_7_value,
                                   t.m_8_value,
                                   t.m_9_value,
                                   t.m_10_value,
                                   t.m_11_value,
                                   t.m_12_value
                                  from BGT_B_DEPT_HIS_DATA_D t
                                  where
                                  t.base_id = (select t.id from BGT_B_DEPT_HIS_DATA t
                                  where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                  and t.budget_dept_id = '''||p_deptid||'''
                                  and t.budget_contents_id = ''00120002'')
                                  and t.item_id = '''||config.item_id||'''
                                  ';
                              end;
                            end if;
                            --00230003  历史数据*比例系数
                            if config.resolve_method_id = '00230003'  then
                              begin
                                --取比例系数
                                execute immediate 'select d.m_1_value,
                                   d.m_2_value,
                                   d.m_3_value,
                                   d.m_4_value,
                                   d.m_5_value,
                                   d.m_6_value,
                                   d.m_7_value,
                                   d.m_8_value,
                                   d.m_9_value,
                                   d.m_10_value,
                                   d.m_11_value,
                                   d.m_12_value
                                  from bgt_d_budget_dept_year_r_i d
                                 
                                  where d.item_id = '''||config.item_id||'''
                                  and d.base_id = (select id from bgt_d_budget_dept_year_r r
                                  where r.budget_year = '''||V_BUDGET_YEAR||'''
                                  and r.budget_dept_id = '''||p_deptid||'''
                                  and r.budget_contents_id = ''00120002'')
                                  ' into V_TEMP_NUM_1,V_TEMP_NUM_2,V_TEMP_NUM_3,V_TEMP_NUM_4,V_TEMP_NUM_5,
                                  V_TEMP_NUM_6,V_TEMP_NUM_7,V_TEMP_NUM_8,V_TEMP_NUM_9,V_TEMP_NUM_10,
                                  V_TEMP_NUM_11,V_TEMP_NUM_12;
                                execute immediate 'insert into BGT_B_DEPT_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round(t.m_1_value * '||V_TEMP_NUM_1||',2),
                                  round(t.m_2_value * '||V_TEMP_NUM_2||',2),
                                  round(t.m_3_value * '||V_TEMP_NUM_3||',2),
                                  round(t.m_4_value * '||V_TEMP_NUM_4||',2),
                                  round(t.m_5_value * '||V_TEMP_NUM_5||',2),
                                  round(t.m_6_value * '||V_TEMP_NUM_6||',2),
                                  round(t.m_7_value * '||V_TEMP_NUM_7||',2),
                                  round(t.m_8_value * '||V_TEMP_NUM_8||',2),
                                  round(t.m_9_value * '||V_TEMP_NUM_9||',2),
                                  round(t.m_10_value * '||V_TEMP_NUM_10||',2),
                                  round(t.m_11_value * '||V_TEMP_NUM_11||',2),
                                  round(t.m_12_value * '||V_TEMP_NUM_12||',2)
                                  from BGT_B_DEPT_HIS_DATA_D t
                                  where
                                  t.base_id = (select t.id from BGT_B_DEPT_HIS_DATA t
                                  where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                  and t.budget_dept_id = '''||p_deptid||'''
                                  and t.budget_contents_id = ''00120002'')
                                  and t.item_id = '''||config.item_id||'''
                                  ';
                              end;
                            end if;
                            --00230004  全面贯彻：复制年计划值
                            if config.resolve_method_id = '00230004'  then
                              begin
                                execute immediate 'insert into BGT_B_DEPT_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||'
                                  from dual
                                  ';
                              end;
                            end if;
                            --00230005  均摊：年计划值除以12
                            if config.resolve_method_id = '00230005'  then
                              begin
                                 execute immediate 'insert into BGT_B_DEPT_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2)
                                  from dual
                                  ';
                              end;
                            end if;
                       end;
                 elsif v_PATTERN = '00170002' then --自下而上
                       begin
                            --00230001  比例系数
                            if config.resolve_method_id = '00230001'  then
                              begin
                                execute immediate 'insert into BGT_B_DEPT_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                      m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round(d.m_1_value * '||config.item_value||',2),
                                  round(d.m_2_value * '||config.item_value||',2),
                                  round(d.m_3_value * '||config.item_value||',2),
                                  round(d.m_4_value * '||config.item_value||',2),
                                  round(d.m_5_value * '||config.item_value||',2),
                                  round(d.m_6_value * '||config.item_value||',2),
                                  round(d.m_7_value * '||config.item_value||',2),
                                  round(d.m_8_value * '||config.item_value||',2),
                                  round(d.m_9_value * '||config.item_value||',2),
                                  round(d.m_10_value * '||config.item_value||',2),
                                  round(d.m_11_value * '||config.item_value||',2),
                                  round(d.m_12_value * '||config.item_value||',2)                              
                                  from bgt_d_budget_dept_year_r_i d
                                 
                                  where d.item_id = '''||config.item_id||'''
                                  and d.base_id = (select id from bgt_d_budget_dept_year_r r
                                  where r.budget_year = '''||V_BUDGET_YEAR||'''
                                  and r.budget_dept_id = '''||p_deptid||'''
                                  and r.budget_contents_id = ''00120002'')
                                  
                                  ';
                              end;
                            end if;
                            --00230002  历史数据
                            if config.resolve_method_id = '00230002'  then
                              begin
                                execute immediate 'insert into BGT_B_DEPT_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                   t.m_1_value,
                                   t.m_2_value,
                                   t.m_3_value,
                                   t.m_4_value,
                                   t.m_5_value,
                                   t.m_6_value,
                                   t.m_7_value,
                                   t.m_8_value,
                                   t.m_9_value,
                                   t.m_10_value,
                                   t.m_11_value,
                                   t.m_12_value
                                  from BGT_B_DEPT_HIS_DATA_D t
                                  where
                                  t.base_id = (select t.id from BGT_B_DEPT_HIS_DATA t
                                  where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                  and t.budget_dept_id = '''||p_deptid||'''
                                  and t.budget_contents_id = ''00120002'')
                                  and t.item_id = '''||config.item_id||'''
                                  ';
                              end;
                            end if;
                            --00230003  历史数据*比例系数
                            if config.resolve_method_id = '00230003'  then
                              begin
                                --取比例系数
                                execute immediate 'select d.m_1_value,
                                   d.m_2_value,
                                   d.m_3_value,
                                   d.m_4_value,
                                   d.m_5_value,
                                   d.m_6_value,
                                   d.m_7_value,
                                   d.m_8_value,
                                   d.m_9_value,
                                   d.m_10_value,
                                   d.m_11_value,
                                   d.m_12_value
                                  from bgt_d_budget_dept_year_r_i d
                                 
                                  where d.item_id = '''||config.item_id||'''
                                  and d.base_id = (select id from bgt_d_budget_dept_year_r r
                                  where r.budget_year = '''||V_BUDGET_YEAR||'''
                                  and r.budget_dept_id = '''||p_deptid||'''
                                  and r.budget_contents_id = ''00120002'')
                                  ' into V_TEMP_NUM_1,V_TEMP_NUM_2,V_TEMP_NUM_3,V_TEMP_NUM_4,V_TEMP_NUM_5,
                                  V_TEMP_NUM_6,V_TEMP_NUM_7,V_TEMP_NUM_8,V_TEMP_NUM_9,V_TEMP_NUM_10,
                                  V_TEMP_NUM_11,V_TEMP_NUM_12;
                                execute immediate 'insert into BGT_B_DEPT_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round(t.m_1_value * '||V_TEMP_NUM_1||',2),
                                  round(t.m_2_value * '||V_TEMP_NUM_2||',2),
                                  round(t.m_3_value * '||V_TEMP_NUM_3||',2),
                                  round(t.m_4_value * '||V_TEMP_NUM_4||',2),
                                  round(t.m_5_value * '||V_TEMP_NUM_5||',2),
                                  round(t.m_6_value * '||V_TEMP_NUM_6||',2),
                                  round(t.m_7_value * '||V_TEMP_NUM_7||',2),
                                  round(t.m_8_value * '||V_TEMP_NUM_8||',2),
                                  round(t.m_9_value * '||V_TEMP_NUM_9||',2),
                                  round(t.m_10_value * '||V_TEMP_NUM_10||',2),
                                  round(t.m_11_value * '||V_TEMP_NUM_11||',2),
                                  round(t.m_12_value * '||V_TEMP_NUM_12||',2)
                                  from BGT_B_DEPT_HIS_DATA_D t
                                  where
                                  t.base_id = (select t.id from BGT_B_DEPT_HIS_DATA t
                                  where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                  and t.budget_dept_id = '''||p_deptid||'''
                                  and t.budget_contents_id = ''00120002'')
                                  and t.item_id = '''||config.item_id||'''
                                  ';
                              end;
                            end if;
                            --00230004  全面贯彻：复制年计划值
                            if config.resolve_method_id = '00230004'  then
                              begin
                                execute immediate 'insert into BGT_B_DEPT_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||',
                                  '||config.item_value||'
                                  from dual
                                  ';
                              end;
                            end if;
                            --00230005  均摊：年计划值除以12
                            if config.resolve_method_id = '00230005'  then
                              begin
                                 execute immediate 'insert into BGT_B_DEPT_inc_MON_D
                                  (
                                    id ,
                                    base_id ,
                                    item_id,
                                    templet_item_id,
                                     m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                  )
                                  select sys_guid(),
                                  '''||V_NEW_GUID||''',
                                  '''||config.item_id||''',
                                  '''||config.templet_item_id||''',
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2),
                                  round('||config.item_value||'/12,2)
                                  from dual
                                  ';
                              end;
                            end if;
                       end;
                 end if;

            end loop;
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Cal_dept_inc_month;


create or replace procedure SP_bgt_Cal_dept_pay_year(p_planid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_YEAR char(36);
V_BUDGET_DEPT_ID char(36);
V_BUDGET_TEMPLET_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
v_PATTERN char(36);
V_LEVEL char(36);
V_PAY_PATTERN_ENTRY char(36);--自下而上模式支出预算编制入口:职能科室/业务科室
V_IS_FUNCTION number(3);--是否职能科室
/*
1、自下而上模式，科室年度支出是编制的起点，编制起点时，无需判断指标数据类型是否【可累加】或者【状态值】
                 职能科室入口：如果当前科室是职能科室，则按照常规逻辑计算
                               如果当前科室是业务科室，则按照职能科室设置中的科目分摊来计算业务科室预算
                 业务科室入口：如果当前科室是业务科室，则按照常规逻辑计算（未实现）
                               如果当前科室是职能科室，则按照职能科室设置中的科目分摊来计算职能科室预算（未实现）                
2、自上而下模式，如果当前科室是职能科室，职能科室年由单位年分解而来
                 如果当前科室是业务科室，业务科室年由职能科室年分解而来
*/
begin
    --变量初始化
    execute immediate '
    select t.BUDGET_YEAR,t.TEMPLET_ID,t.BUDGET_DEPT_ID,t1.IS_FUNCTION from BGT_B_DEPT_pay_YEAR t,BGT_D_BUDGET_DEPT t1 where t.id ='''||p_planid||'''
     and t1.id = t.BUDGET_DEPT_ID'
    into V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID,V_BUDGET_DEPT_ID,V_IS_FUNCTION;
    --获取编制模式,编制层次,自下而上模式支出预算编制入口
    execute immediate 'select INCOME_PATTERN_ID,INCOME_LEVEL_ID,PAY_PATTERN_ENTRY_ID from BGT_D_BUDGET_PATTERN
    where BUDGET_YEAR = '''||V_BUDGET_YEAR||'''' into v_PATTERN,V_LEVEL,V_PAY_PATTERN_ENTRY;
    --删除子项
    V_DYNA_SQL:= 'delete from BGT_B_DEPT_pay_YEAR_D where BASE_ID =''' || p_planid||'''';
    dbms_output.put_line(V_DYNA_SQL);
    execute immediate V_DYNA_SQL;
    --从模板复制子项
    V_DYNA_SQL:= 'insert into BGT_B_DEPT_pay_YEAR_D(id,BASE_ID,ITEM_ID,TEMPLET_ITEM_ID)
    select sys_guid(), '''||p_planid||''',t.ITEM_ID,t.ID from BGT_D_BUDGET_T_D t
    where t.BASE_ID = ''' || V_BUDGET_TEMPLET_ID||'''';
    dbms_output.put_line(V_DYNA_SQL);
    execute immediate V_DYNA_SQL;
    --获取历史预算年
    execute immediate 'select t.id from BGT_D_BUDGET_YEAR t, BGT_D_BUDGET_YEAR t1
    where t1.ID = ''' || V_BUDGET_YEAR||'''
    and t.BUDGET_YEAR = t1.BUDGET_YEAR - 1 ' into V_PRE_BUDGET_YEAR;
    --遍历子项,对子项进行逐项计算
    for config in(
                    select
                    t.id,
                    t.base_id,
                    t.item_id,
                    t.calculate_index,
                    t.prepare_method_id,
                    t.calculate_method_id,
                    t.calculate_formula,
                    t.consult,
                    t1.id as planitemid,
                    t2.DATA_TYPE_ID as planitemtype
                    from  BGT_D_BUDGET_T_D t,
                    BGT_B_dept_pay_YEAR_D t1,
                    bgt_d_budget_item t2
                    where t.id = t1.templet_item_id
                    and t.item_id = t2.id
                    and  t1.base_id = p_planid

                  )
          loop
             if v_PATTERN = '00170001' then --自上而下
               begin                     
                     if V_IS_FUNCTION = 1 then --当前科室是职能科室
                       begin
                              V_DYNA_SQL:='update BGT_B_DEPT_pay_YEAR_D set
                                        ITEM_VALUE = (
                                                         select decode(pyd.item_value,0,0,pyd.item_value/count(bd.id))
                                                         from bgt_d_budget_dept bd,
                                                         BGT_B_CPN_pay_YEAR py,
                                                         BGT_B_CPN_pay_YEAR_D pyd
                                                         where bd.is_function = 1                                                      
                                                         and bd.budget_year = '''||V_BUDGET_YEAR||'''
                                                         and pyd.item_id = '''||config.item_id||'''
                                                         and py.budget_year = bd.budget_year                                                        
                                                         group by pyd.item_value
                                                   )                                          
                                        where id =''' || config.planitemid ||'''';                                    
                                    dbms_output.put_line(V_DYNA_SQL);
                                    execute immediate V_DYNA_SQL;                               
                       end;
                     else  --当前科室是业务科室
                       begin
                                    V_DYNA_SQL:='update BGT_B_DEPT_pay_YEAR_D set
                                        ITEM_VALUE = (
                                                       select decode(pyd.item_value,0,0,pyd.item_value/count(imdp.id))
                                                         from bgt_d_mgr_dept_item im,
                                                         bgt_d_mgr_dept_item_d imd,
                                                         bgt_d_mgr_dept_item_d imdp,
                                                         bgt_b_dept_pay_year py,
                                                         bgt_b_dept_pay_year_d pyd
                                                         where imd.base_id = im.id
                                                         and imdp.base_id = im.id
                                                         and im.budget_year = '''||V_BUDGET_YEAR||'''
                                                         and im.item_id = '''||config.item_id||'''
                                                         and imd.biz_dept_id = '''||V_BUDGET_DEPT_ID||'''
                                                         and py.id = pyd.base_id
                                                         and py.budget_year =im.budget_year
                                                         and py.budget_dept_id = im.mgr_dept_id
                                                         and pyd.item_id  = im.item_id
                                                         group by im.mgr_dept_id,pyd.item_value
                                                   ),
                                        MGR_DEPT_ID =
                                        (
                                                    select im.mgr_dept_id
                                                         from bgt_d_mgr_dept_item im,
                                                         bgt_d_mgr_dept_item_d imd,
                                                         bgt_d_mgr_dept_item_d imdp,
                                                         bgt_b_dept_pay_year py,
                                                         bgt_b_dept_pay_year_d pyd
                                                         where imd.base_id = im.id
                                                         and imdp.base_id = im.id
                                                         and im.budget_year = '''||V_BUDGET_YEAR||'''
                                                         and im.item_id = '''||config.item_id||'''
                                                         and imd.biz_dept_id = '''||V_BUDGET_DEPT_ID||'''
                                                         and py.id = pyd.base_id
                                                         and py.budget_year =im.budget_year
                                                         and py.budget_dept_id = im.mgr_dept_id
                                                         and pyd.item_id  = im.item_id
                                                         group by im.mgr_dept_id
                                        )
                                          
                                        where id =''' || config.planitemid ||'''';
                                    dbms_output.put_line(V_DYNA_SQL);
                                    execute immediate V_DYNA_SQL;               
                               end;
                     end if;     
                 end;
             elsif v_PATTERN = '00170002' then --自下而上
               begin
                   if V_IS_FUNCTION = 1 then --当前科室是职能科室
                       begin
                             if V_PAY_PATTERN_ENTRY = '00260001' then --编制起点是职能科室
                               begin
                                      --公式计算'00110002'
                                      if config.calculate_method_id = '00110002'  then
                                        begin
                                          execute immediate 'select sys_guid() from dual';
                                        end;
                                      --历史数据*比例系数'00110003'
                                      elsif  config.calculate_method_id = '00110003'  then
                                        begin
                                          V_DYNA_SQL:= 'update BGT_B_DEPT_pay_YEAR_D set
                                                    ITEM_VALUE = (
                                                                   select sum(m_1_value)
                                                    + sum(m_2_value)
                                                    + sum(m_3_value)
                                                    + sum(m_4_value)
                                                    + sum(m_5_value)
                                                    + sum(m_6_value)
                                                    + sum(m_7_value)
                                                    + sum(m_8_value)
                                                    + sum(m_9_value)
                                                    + sum(m_10_value)
                                                    + sum(m_11_value)
                                                    + sum(m_12_value) from BGT_B_DEPT_HIS_DATA_D
                                                                   where ITEM_ID = '''||config.item_id||'''
                                                                   and BASE_ID in
                                                                   (
                                                                     select id
                                                                     from
                                                                     BGT_B_DEPT_HIS_DATA
                                                                     where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||'''
                                                                     and BUDGET_DEPT_ID ='''||V_BUDGET_DEPT_ID||'''
                                                                     and BUDGET_CONTENTS_ID = ''00120003''
                                                                   )
                                                                   group by ITEM_ID
                                                               ) * (select nvl(t1.INCREASE_SCALE,1 )
                                                                    from BGT_D_BUDGET_T_DEPT_I t,BGT_D_BUDGET_T_DEPT_I_D t1
                                                                    where t.BASE_ID = '''||V_BUDGET_TEMPLET_ID||'''
                                                                    and t.id = t1.base_id
                                                                    and  t.BUDGET_DEPT_ID =  '''||V_BUDGET_DEPT_ID||'''
                                                                    and t1.ITEM_ID = '''||config.item_id||''')
                                                    where id =''' || config.planitemid ||'''';
                                          dbms_output.put_line(V_DYNA_SQL);
                                          execute immediate V_DYNA_SQL;
                                        end;
                                       --历史数据 '00110004'
                                      elsif config.calculate_method_id = '00110004' then
                                        begin
                                          V_DYNA_SQL:='update BGT_B_DEPT_pay_YEAR_D set
                                                ITEM_VALUE = (
                                                               select sum(m_1_value)
                                                    + sum(m_2_value)
                                                    + sum(m_3_value)
                                                    + sum(m_4_value)
                                                    + sum(m_5_value)
                                                    + sum(m_6_value)
                                                    + sum(m_7_value)
                                                    + sum(m_8_value)
                                                    + sum(m_9_value)
                                                    + sum(m_10_value)
                                                    + sum(m_11_value)
                                                    + sum(m_12_value) from BGT_B_DEPT_HIS_DATA_D
                                                               where ITEM_ID = '''||config.item_id||'''
                                                               and BASE_ID in
                                                               (
                                                                 select id
                                                                 from
                                                                 BGT_B_DEPT_HIS_DATA
                                                                 where BUDGET_YEAR ='''||V_PRE_BUDGET_YEAR||'''
                                                                 and BUDGET_DEPT_ID ='''||V_BUDGET_DEPT_ID||'''
                                                                 and BUDGET_CONTENTS_ID = ''00120003''
                                                               )
                                                               group by ITEM_ID
                                                           )
                                                where id =''' || config.planitemid ||'''';
                                          dbms_output.put_line(V_DYNA_SQL);
                                          execute immediate V_DYNA_SQL;
                                        end;
                                       --历史数据分解上级科目'00110005'
                                      elsif config.calculate_method_id = '00110005'  then
                                        begin
                                          execute immediate 'select sys_guid() from dual';
                                        end;
                                       --手工输入'00110001'
                                      else
                                        begin
                                          execute immediate 'select sys_guid() from dual';
                                        end;
                                      end if;       
                               end;
                             else --编制起点是业务科室:待实现
                               begin
                                  execute immediate 'select sys_guid() from dual';
                               end;
                             end if;                               
                       end;
                     else  --当前科室是业务科室
                       begin
                           if V_PAY_PATTERN_ENTRY = '00260001' then --编制起点是职能科室
                               begin
                                    V_DYNA_SQL:='update BGT_B_DEPT_pay_YEAR_D set
                                        ITEM_VALUE = (
                                                       select decode(pyd.item_value,0,0,pyd.item_value/count(imdp.id))
                                                         from bgt_d_mgr_dept_item im,
                                                         bgt_d_mgr_dept_item_d imd,
                                                         bgt_d_mgr_dept_item_d imdp,
                                                         bgt_b_dept_pay_year py,
                                                         bgt_b_dept_pay_year_d pyd
                                                         where imd.base_id = im.id
                                                         and imdp.base_id = im.id
                                                         and im.budget_year = '''||V_BUDGET_YEAR||'''
                                                         and im.item_id = '''||config.item_id||'''
                                                         and imd.biz_dept_id = '''||V_BUDGET_DEPT_ID||'''
                                                         and py.id = pyd.base_id
                                                         and py.budget_year =im.budget_year
                                                         and py.budget_dept_id = im.mgr_dept_id
                                                         and pyd.item_id  = im.item_id
                                                         group by im.mgr_dept_id,pyd.item_value
                                                   ),
                                        MGR_DEPT_ID =
                                        (
                                                    select im.mgr_dept_id
                                                         from bgt_d_mgr_dept_item im,
                                                         bgt_d_mgr_dept_item_d imd,
                                                         bgt_d_mgr_dept_item_d imdp,
                                                         bgt_b_dept_pay_year py,
                                                         bgt_b_dept_pay_year_d pyd
                                                         where imd.base_id = im.id
                                                         and imdp.base_id = im.id
                                                         and im.budget_year = '''||V_BUDGET_YEAR||'''
                                                         and im.item_id = '''||config.item_id||'''
                                                         and imd.biz_dept_id = '''||V_BUDGET_DEPT_ID||'''
                                                         and py.id = pyd.base_id
                                                         and py.budget_year =im.budget_year
                                                         and py.budget_dept_id = im.mgr_dept_id
                                                         and pyd.item_id  = im.item_id
                                                         group by im.mgr_dept_id
                                        )
                                          
                                        where id =''' || config.planitemid ||'''';
                                    dbms_output.put_line(V_DYNA_SQL);
                                    execute immediate V_DYNA_SQL;               
                               end;
                             else --编制起点是业务科室:待实现
                               begin
                                 execute immediate 'select sys_guid() from dual';
                               end;
                             end if;                            
                       end;
                     end if;                  
               end;
             end if;
          end loop;
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Cal_dept_pay_year;

create or replace procedure SP_bgt_Cal_dept_pay_month(p_yearid in char,p_deptid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_NEW_GUID varchar2(36);
V_NEW_M_GUID varchar2(36);
V_TEMP_NUM_1 number(22,4);
V_TEMP_NUM_2 number(22,4);
V_TEMP_NUM_3 number(22,4);
V_TEMP_NUM_4 number(22,4);
V_TEMP_NUM_5 number(22,4);
V_TEMP_NUM_6 number(22,4);
V_TEMP_NUM_7 number(22,4);
V_TEMP_NUM_8 number(22,4);
V_TEMP_NUM_9 number(22,4);
V_TEMP_NUM_10 number(22,4);
V_TEMP_NUM_11 number(22,4);
V_TEMP_NUM_12 number(22,4);
V_BUDGET_YEAR_PLAN_ID char(36);
V_BUDGET_YEAR char(36);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_DEPT_ID char(36);
V_BUDGET_TEMPLET_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
v_PATTERN char(36);
V_LEVEL char(36);
V_PAY_PATTERN_ENTRY char(36);--自下而上模式支出预算编制入口:职能科室/业务科室
V_IS_FUNCTION number(3);--是否职能科室
/*
1、自下而上模式，科室月份收入由科室年度收入分解计算而来（需要区分指标的数据类型）
                 业务科室: 由业务科室年度收入分解而来
                 职能科室：由业务科室月份收入预算汇总
2、自上而下模式，科室月份收入由科室年度收入分解计算而来（需要区分指标的数据类型）
                 业务科室: 由科室年度收入分解而来
                 职能科室：由科室年度收入分解而来
*/
begin
    --变量初始化
    execute immediate '
    select t.id,t.BUDGET_YEAR,t.TEMPLET_ID,t.BUDGET_DEPT_ID,t1.IS_FUNCTION from BGT_B_DEPT_pay_YEAR t,BGT_D_BUDGET_DEPT t1
    where t.BUDGET_YEAR='''||p_yearid||''' and t.BUDGET_DEPT_ID ='''||p_deptid||'''
    and t1.id = t.BUDGET_DEPT_ID and rownum = 1'
    into V_BUDGET_YEAR_PLAN_ID,V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID,V_BUDGET_DEPT_ID,V_IS_FUNCTION;
    --获取编制模式,编制层次,自下而上模式支出预算编制入口
    execute immediate 'select INCOME_PATTERN_ID,INCOME_LEVEL_ID,PAY_PATTERN_ENTRY_ID from BGT_D_BUDGET_PATTERN
    where BUDGET_YEAR = '''||V_BUDGET_YEAR||'''' into v_PATTERN,V_LEVEL,V_PAY_PATTERN_ENTRY;
    --查询月份记录
    execute immediate 'select id from BGT_B_DEPT_pay_MON where BUDGET_YEAR='''||p_yearid||''' and BUDGET_DEPT_ID ='''||p_deptid||''''
    into V_NEW_GUID;
    --删除明细记录
    execute immediate 'delete  from BGT_B_DEPT_pay_MON_D where base_id='''||V_NEW_GUID||'''';
     --获取历史预算年
    execute immediate 'select t.id from BGT_D_BUDGET_YEAR t, BGT_D_BUDGET_YEAR t1
    where t1.ID = ''' || V_BUDGET_YEAR||'''
    and t.BUDGET_YEAR = t1.BUDGET_YEAR - 1 ' into V_PRE_BUDGET_YEAR;
    --遍历预算月份记录,逐月进行分解

          --插入从表
          --遍历【年预算】中的预算指标,逐个指标进行分解
          for config in(
              select
              p.item_id,
              nvl(p.item_value,0) item_value ,
              p.templet_item_id,
              ri.resolve_method_id
              from  Bgt_b_Dept_pay_Year_d p,
              BGT_D_BUDGET_DEPT_YEAR_R r,
              BGT_D_BUDGET_DEPT_YEAR_R_i ri
              where p.base_id = V_BUDGET_YEAR_PLAN_ID
              and r.id = ri.base_id
              and ri.item_id = p.item_id
              and r.budget_year = p_yearid
              and r.budget_dept_id = p_deptid
              and r.budget_contents_id = '00120003' --支出预算
            )
            loop
                  if v_PATTERN = '00170001' then --自上而下
                       begin
                                --职能科室和业务科室都是分解年计划得到月计划
                                --00230001  比例系数
                                if config.resolve_method_id = '00230001'  then
                                  begin
                                    execute immediate 'insert into BGT_B_DEPT_pay_MON_D
                                      (
                                        id ,
                                        base_id ,
                                        item_id,
                                        templet_item_id,
                                        m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                      )
                                      select sys_guid(),
                                      '''||V_NEW_GUID||''',
                                      '''||config.item_id||''',
                                      '''||config.templet_item_id||''',
                                      round(d.m_1_value * '||config.item_value||',2),
                                      round(d.m_2_value * '||config.item_value||',2),
                                      round(d.m_3_value * '||config.item_value||',2),
                                      round(d.m_4_value * '||config.item_value||',2),
                                      round(d.m_5_value * '||config.item_value||',2),
                                      round(d.m_6_value * '||config.item_value||',2),
                                      round(d.m_7_value * '||config.item_value||',2),
                                      round(d.m_8_value * '||config.item_value||',2),
                                      round(d.m_9_value * '||config.item_value||',2),
                                      round(d.m_10_value * '||config.item_value||',2),
                                      round(d.m_11_value * '||config.item_value||',2),
                                      round(d.m_12_value * '||config.item_value||',2)
                                      from bgt_d_budget_dept_year_r_i d

                                      where d.item_id = '''||config.item_id||'''
                                      and d.base_id = (select id from bgt_d_budget_dept_year_r r
                                      where r.budget_year = '''||V_BUDGET_YEAR||'''
                                      and r.budget_dept_id = '''||p_deptid||'''
                                      and r.budget_contents_id = ''00120003'')

                                      ';
                                  end;
                                end if;
                                --00230002  历史数据
                                if config.resolve_method_id = '00230002'  then
                                  begin
                                    execute immediate 'insert into BGT_B_DEPT_pay_MON_D
                                      (
                                        id ,
                                        base_id ,
                                        item_id,
                                        templet_item_id,
                                         m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                      )
                                      select sys_guid(),
                                      '''||V_NEW_GUID||''',
                                      '''||config.item_id||''',
                                      '''||config.templet_item_id||''',
                                      t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value
                                      from BGT_B_DEPT_HIS_DATA_D t
                                      where
                                      t.base_id = (select t.id from BGT_B_DEPT_HIS_DATA t
                                      where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                      and t.budget_dept_id = '''||p_deptid||'''
                                      and t.budget_contents_id = ''00120003'')
                                      and t.item_id = '''||config.item_id||'''
                                      ';
                                  end;
                                end if;
                                --00230003  历史数据*比例系数
                                if config.resolve_method_id = '00230003'  then
                                  begin
                                    --取比例系数
                                    execute immediate 'select d.m_1_value,
                                      d.m_2_value,
                                      d.m_3_value,
                                      d.m_4_value,
                                      d.m_5_value,
                                      d.m_6_value,
                                      d.m_7_value,
                                      d.m_8_value,
                                      d.m_9_value,
                                      d.m_10_value,
                                      d.m_11_value,
                                      d.m_12_value
                                      from bgt_d_budget_dept_year_r_i d
                                      where d.item_id = '''||config.item_id||'''
                                      and d.base_id = (select id from bgt_d_budget_dept_year_r r
                                      where r.budget_year = '''||V_BUDGET_YEAR||'''
                                      and r.budget_dept_id = '''||p_deptid||'''
                                      and r.budget_contents_id = ''00120003'')
                                      ' into V_TEMP_NUM_1,V_TEMP_NUM_2,V_TEMP_NUM_3,V_TEMP_NUM_4,V_TEMP_NUM_5,
                                      V_TEMP_NUM_6,V_TEMP_NUM_7,V_TEMP_NUM_8,V_TEMP_NUM_9,V_TEMP_NUM_10,
                                      V_TEMP_NUM_11,V_TEMP_NUM_12;
                                    execute immediate 'insert into BGT_B_DEPT_pay_MON_D
                                      (
                                        id ,
                                        base_id ,
                                        item_id,
                                        templet_item_id,
                                         m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                      )
                                      select sys_guid(),
                                      '''||V_NEW_GUID||''',
                                      '''||config.item_id||''',
                                      '''||config.templet_item_id||''',
                                      round(t.m_1_value * '||V_TEMP_NUM_1||',2),
                                       round(t.m_2_value * '||V_TEMP_NUM_2||',2),
                                       round(t.m_3_value * '||V_TEMP_NUM_3||',2),
                                       round(t.m_4_value * '||V_TEMP_NUM_4||',2),
                                       round(t.m_5_value * '||V_TEMP_NUM_5||',2),
                                       round(t.m_6_value * '||V_TEMP_NUM_6||',2),
                                       round(t.m_7_value * '||V_TEMP_NUM_7||',2),
                                       round(t.m_8_value * '||V_TEMP_NUM_8||',2),
                                       round(t.m_9_value * '||V_TEMP_NUM_9||',2),
                                       round(t.m_10_value * '||V_TEMP_NUM_10||',2),
                                       round(t.m_11_value * '||V_TEMP_NUM_11||',2),
                                       round(t.m_12_value * '||V_TEMP_NUM_12||',2),
                                      from BGT_B_DEPT_HIS_DATA_D t
                                      where
                                      t.base_id = (select t.id from BGT_B_DEPT_HIS_DATA t
                                      where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                      and t.budget_dept_id = '''||p_deptid||'''
                                      and t.budget_contents_id = ''00120003'')
                                      and t.item_id = '''||config.item_id||'''
                                      ';
                                  end;
                                end if;
                                --00230004  全面贯彻：复制年计划值
                                if config.resolve_method_id = '00230004'  then
                                  begin
                                    execute immediate 'insert into BGT_B_DEPT_pay_MON_D
                                      (
                                        id ,
                                        base_id ,
                                        item_id,
                                        templet_item_id,
                                         m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                      )
                                      select sys_guid(),
                                      '''||V_NEW_GUID||''',
                                      '''||config.item_id||''',
                                      '''||config.templet_item_id||''',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||'
                                      from dual
                                      ';
                                  end;
                                end if;
                                --00230005  均摊：年计划值除以12
                                if config.resolve_method_id = '00230005'  then
                                  begin

                                     execute immediate 'insert into BGT_B_DEPT_pay_MON_D
                                      (
                                        id ,
                                        base_id ,
                                        item_id,
                                        templet_item_id,
                                         m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                      )
                                      select sys_guid(),
                                      '''||V_NEW_GUID||''',
                                      '''||config.item_id||''',
                                      '''||config.templet_item_id||''',
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2)
                                      from dual
                                      ';
                                  end;
                                end if;
                            end;
                 elsif v_PATTERN = '00170002' then --自下而上
                       begin
                         if V_IS_FUNCTION = 1 then --当前科室是职能科室
                            begin
                               execute immediate 'insert into BGT_B_DEPT_pay_MON_D
                                      (
                                        id ,
                                        base_id ,
                                        item_id,
                                        templet_item_id,
                                         m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                      )
                                      select sys_guid(),
                                      '''||V_NEW_GUID||''',
                                      '''||config.item_id||''',
                                      '''||config.templet_item_id||''',
                                      sum(md.m_1_value),
                                      sum(md.m_2_value),
                                      sum(md.m_3_value),
                                      sum(md.m_4_value),
                                      sum(md.m_5_value),
                                      sum(md.m_6_value),
                                      sum(md.m_7_value),
                                      sum(md.m_8_value),
                                      sum(md.m_9_value),
                                      sum(md.m_10_value),
                                      sum(md.m_11_value),
                                      sum(md.m_12_value)
                                      from BGT_B_DEPT_PAY_MON_D md,BGT_B_DEPT_PAY_MON m
                                      where m.id = md.base_id
                                      and md.item_id = '''||config.item_id||'''
                                      and m.budget_year = '''||V_BUDGET_YEAR||'''
                                      and m.budget_dept_id in
                                      (
                                       select itemd.biz_dept_id
                                       from bgt_d_mgr_dept_item item,
                                       bgt_d_mgr_dept_item_d itemd
                                       where item.id = itemd.base_id
                                       and item.item_id = '''||config.item_id||'''
                                       and item.mgr_dept_id = '''||V_BUDGET_DEPT_ID||'''
                                       and item.budget_year = '''||V_BUDGET_YEAR||'''
                                      )
                                      group by md.item_id
                                    ';
                            end;
                          else --当前科室是业务科室
                            begin
                                --00230001  比例系数
                                if config.resolve_method_id = '00230001'  then
                                  begin
                                    execute immediate 'insert into BGT_B_DEPT_pay_MON_D
                                      (
                                        id ,
                                        base_id ,
                                        item_id,
                                        templet_item_id,
                                        m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                      )
                                      select sys_guid(),
                                      '''||V_NEW_GUID||''',
                                      '''||config.item_id||''',
                                      '''||config.templet_item_id||''',
                                      round(d.m_1_value * '||config.item_value||',2),
                                      round(d.m_2_value * '||config.item_value||',2),
                                      round(d.m_3_value * '||config.item_value||',2),
                                      round(d.m_4_value * '||config.item_value||',2),
                                      round(d.m_5_value * '||config.item_value||',2),
                                      round(d.m_6_value * '||config.item_value||',2),
                                      round(d.m_7_value * '||config.item_value||',2),
                                      round(d.m_8_value * '||config.item_value||',2),
                                      round(d.m_9_value * '||config.item_value||',2),
                                      round(d.m_10_value * '||config.item_value||',2),
                                      round(d.m_11_value * '||config.item_value||',2),
                                      round(d.m_12_value * '||config.item_value||',2)
                                      from bgt_d_budget_dept_year_r_i d

                                      where d.item_id = '''||config.item_id||'''
                                      and d.base_id = (select id from bgt_d_budget_dept_year_r r
                                      where r.budget_year = '''||V_BUDGET_YEAR||'''
                                      and r.budget_dept_id = '''||p_deptid||'''
                                      and r.budget_contents_id = ''00120003'')

                                      ';
                                  end;
                                end if;
                                --00230002  历史数据
                                if config.resolve_method_id = '00230002'  then
                                  begin
                                    execute immediate 'insert into BGT_B_DEPT_pay_MON_D
                                      (
                                        id ,
                                        base_id ,
                                        item_id,
                                        templet_item_id,
                                         m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                      )
                                      select sys_guid(),
                                      '''||V_NEW_GUID||''',
                                      '''||config.item_id||''',
                                      '''||config.templet_item_id||''',
                                      t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value
                                      from BGT_B_DEPT_HIS_DATA_D t
                                      where
                                      t.base_id = (select t.id from BGT_B_DEPT_HIS_DATA t
                                      where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                      and t.budget_dept_id = '''||p_deptid||'''
                                      and t.budget_contents_id = ''00120003'')
                                      and t.item_id = '''||config.item_id||'''
                                      ';
                                  end;
                                end if;
                                --00230003  历史数据*比例系数
                                if config.resolve_method_id = '00230003'  then
                                  begin
                                    --取比例系数
                                    execute immediate 'select d.m_1_value,
                                      d.m_2_value,
                                      d.m_3_value,
                                      d.m_4_value,
                                      d.m_5_value,
                                      d.m_6_value,
                                      d.m_7_value,
                                      d.m_8_value,
                                      d.m_9_value,
                                      d.m_10_value,
                                      d.m_11_value,
                                      d.m_12_value
                                      from bgt_d_budget_dept_year_r_i d
                                      where d.item_id = '''||config.item_id||'''
                                      and d.base_id = (select id from bgt_d_budget_dept_year_r r
                                      where r.budget_year = '''||V_BUDGET_YEAR||'''
                                      and r.budget_dept_id = '''||p_deptid||'''
                                      and r.budget_contents_id = ''00120003'')
                                      ' into V_TEMP_NUM_1,V_TEMP_NUM_2,V_TEMP_NUM_3,V_TEMP_NUM_4,V_TEMP_NUM_5,
                                      V_TEMP_NUM_6,V_TEMP_NUM_7,V_TEMP_NUM_8,V_TEMP_NUM_9,V_TEMP_NUM_10,
                                      V_TEMP_NUM_11,V_TEMP_NUM_12;
                                    execute immediate 'insert into BGT_B_DEPT_pay_MON_D
                                      (
                                        id ,
                                        base_id ,
                                        item_id,
                                        templet_item_id,
                                         m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                      )
                                      select sys_guid(),
                                      '''||V_NEW_GUID||''',
                                      '''||config.item_id||''',
                                      '''||config.templet_item_id||''',
                                      round(t.m_1_value * '||V_TEMP_NUM_1||',2),
                                       round(t.m_2_value * '||V_TEMP_NUM_2||',2),
                                       round(t.m_3_value * '||V_TEMP_NUM_3||',2),
                                       round(t.m_4_value * '||V_TEMP_NUM_4||',2),
                                       round(t.m_5_value * '||V_TEMP_NUM_5||',2),
                                       round(t.m_6_value * '||V_TEMP_NUM_6||',2),
                                       round(t.m_7_value * '||V_TEMP_NUM_7||',2),
                                       round(t.m_8_value * '||V_TEMP_NUM_8||',2),
                                       round(t.m_9_value * '||V_TEMP_NUM_9||',2),
                                       round(t.m_10_value * '||V_TEMP_NUM_10||',2),
                                       round(t.m_11_value * '||V_TEMP_NUM_11||',2),
                                       round(t.m_12_value * '||V_TEMP_NUM_12||',2),
                                      from BGT_B_DEPT_HIS_DATA_D t
                                      where
                                      t.base_id = (select t.id from BGT_B_DEPT_HIS_DATA t
                                      where t.budget_year = '''||V_PRE_BUDGET_YEAR||'''
                                      and t.budget_dept_id = '''||p_deptid||'''
                                      and t.budget_contents_id = ''00120003'')
                                      and t.item_id = '''||config.item_id||'''
                                      ';
                                  end;
                                end if;
                                --00230004  全面贯彻：复制年计划值
                                if config.resolve_method_id = '00230004'  then
                                  begin
                                    execute immediate 'insert into BGT_B_DEPT_pay_MON_D
                                      (
                                        id ,
                                        base_id ,
                                        item_id,
                                        templet_item_id,
                                         m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                      )
                                      select sys_guid(),
                                      '''||V_NEW_GUID||''',
                                      '''||config.item_id||''',
                                      '''||config.templet_item_id||''',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||',
                                      '||config.item_value||'
                                      from dual
                                      ';
                                  end;
                                end if;
                                --00230005  均摊：年计划值除以12
                                if config.resolve_method_id = '00230005'  then
                                  begin

                                     execute immediate 'insert into BGT_B_DEPT_pay_MON_D
                                      (
                                        id ,
                                        base_id ,
                                        item_id,
                                        templet_item_id,
                                         m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value
                                      )
                                      select sys_guid(),
                                      '''||V_NEW_GUID||''',
                                      '''||config.item_id||''',
                                      '''||config.templet_item_id||''',
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2),
                                      round('||config.item_value||'/12,2)
                                      from dual
                                      ';
                                  end;
                                end if;
                            end;
                          end if;
                       end;
                 end if;

            end loop;

      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Cal_dept_pay_month;





create or replace procedure SP_bgt_check_execute_data(p_bizid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_DYNCOLUMN varchar2(36);
V_NEW_GUID varchar2(36);
V_ROWCOUNT number(22);
V_BUDGET_YEAR varchar2(36);
V_BUDGET_ITEM varchar2(36);
V_BUDGET_EDITION varchar2(36);
V_BUDGET_AVAILABLE number(22,4);
V_FINANCE_CYCLE varchar2(50);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
begin
      --变量初始化
      V_BUDGET_AVAILABLE :=0;
      --1、从BGT_B_BUDGET_Control_D_EXE按业务id逐条遍历
      for config in(
                    select c.budget_year,
                    cd.item_id,
                    cd.type_id,
                    cd.edition_id,
                    cde.budget_dept_id,
                    cde.finance_cycle,
                    cde.money,
                    cde.id
                    from BGT_B_BUDGET_Control_D_EXE cde ,
                    BGT_B_BUDGET_Control c,
                    BGT_B_BUDGET_Control_D cd
                    where  cde.ref_tab_id = p_bizid
                    and cde.base_id = cd.id
                    and cd.base_id = c.id
                  )
       loop  
                  --查询可用支出预算
                  if trim(config.edition_id) = '02020001' then--科室年
                    begin
                        --检查记录是否存在
                        select COUNT(id) INTO V_ROWCOUNT from 
                                 BGT_B_DEPT_YEAR_EXE 
                                 where BUDGET_YEAR= config.budget_year
                                 and BUDGET_DEPT_ID= config.budget_dept_id 
                                 and Budget_Contents_ID='00120003';
                        if  V_ROWCOUNT > 0 then
                        begin     
                        select t.item_value - t.ITEM_FACT_VALUE into V_BUDGET_AVAILABLE
                        from BGT_B_DEPT_YEAR_EXE_D t 
                        where t.base_id in
                         (select id from 
                                 BGT_B_DEPT_YEAR_EXE 
                                 where BUDGET_YEAR= config.budget_year
                                 and BUDGET_DEPT_ID= config.budget_dept_id 
                                 and Budget_Contents_ID='00120003'
                         ) 
                         and t.ITEM_ID=config.item_id  ;  
                         end;
                         end if;                    
                    end;
                  elsif trim(config.edition_id) = '02020002' then--科室月
                    begin     
                        --检查记录是否存在
                        select COUNT(id) INTO V_ROWCOUNT from BGT_B_DEPT_MON_EXE 
                        where BUDGET_YEAR=config.budget_year 
                        and BUDGET_DEPT_ID= config.budget_dept_id
                        and Budget_Contents_ID='00120003' ;
                        if  V_ROWCOUNT > 0 then
                        begin            
                        select 
                           case when substr(config.finance_cycle,5,2) = '01' then
                              t.M_1_VALUE - t.M_1_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '02' then
                              t.M_2_VALUE - t.M_2_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '03' then
                              t.M_3_VALUE - t.M_3_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '04' then
                              t.M_4_VALUE- t.M_4_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '05' then
                              t.M_5_VALUE - t.M_5_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '06' then
                              t.M_6_VALUE - t.M_6_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '07' then
                              t.M_7_VALUE - t.M_7_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '08' then
                              t.M_8_VALUE - t.M_8_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '09' then
                              t.M_9_VALUE - t.M_9_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '10' then
                              t.M_10_VALUE -t.M_10_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '11' then
                              t.M_11_VALUE - t.M_11_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '12' then
                              t.M_12_VALUE - t.M_12_FACT_VALUE
                           else
                              0
                           end  into V_BUDGET_AVAILABLE
                        from
                        BGT_B_DEPT_MON_EXE_D t ,(select id from BGT_B_DEPT_MON_EXE 
                        where BUDGET_YEAR=config.budget_year 
                        and BUDGET_DEPT_ID= config.budget_dept_id
                        and Budget_Contents_ID='00120003') T2
                        where t.base_id = T2.ID                        
                        and t.ITEM_ID=config.item_id;
                        end;
                        end if;
                    end;
                    elsif trim(config.edition_id) = '02020003' then --单位年
                    begin
                        --检查记录是否存在
                        select COUNT(id) INTO V_ROWCOUNT from 
                                 BGT_B_CPN_YEAR_EXE 
                                 where BUDGET_YEAR= config.budget_year                                 
                                 and Budget_Contents_ID='00120003';
                        if  V_ROWCOUNT > 0 then
                        begin 
                        select t.item_value - t.ITEM_FACT_VALUE into V_BUDGET_AVAILABLE
                        from BGT_B_CPN_YEAR_EXE_D t 
                        where t.base_id in
                         (select id from 
                                 BGT_B_CPN_YEAR_EXE 
                                 where BUDGET_YEAR= config.budget_year                                 
                                 and Budget_Contents_ID='00120003'
                         ) 
                         and t.ITEM_ID=config.item_id; 
                         end;
                         end if;
                    end;
                    elsif trim(config.edition_id) = '02020004' then --单位月
                    begin
                         --检查记录是否存在
                         select COUNT(id) INTO V_ROWCOUNT from BGT_B_CPN_MON_EXE 
                        where BUDGET_YEAR=config.budget_year 
                        and Budget_Contents_ID='00120003';
                        if  V_ROWCOUNT > 0 then
                        begin 
                       select 
                           case when substr(config.finance_cycle,5,2) = '01' then
                              t.M_1_VALUE - t.M_1_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '02' then
                              t.M_2_VALUE - t.M_2_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '03' then
                              t.M_3_VALUE - t.M_3_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '04' then
                              t.M_4_VALUE - t.M_4_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '05' then
                              t.M_5_VALUE - t.M_5_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '06' then
                              t.M_6_VALUE - t.M_6_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '07' then
                              t.M_7_VALUE - t.M_7_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '08' then
                              t.M_8_VALUE - t.M_8_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '09' then
                              t.M_9_VALUE - t.M_9_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '10' then
                              t.M_10_VALUE - t.M_10_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '11' then
                              t.M_11_VALUE - t.M_11_FACT_VALUE
                           when substr(config.finance_cycle,5,2) = '12' then
                              t.M_12_VALUE - t.M_12_FACT_VALUE
                           else
                             0
                           end  into V_BUDGET_AVAILABLE
                        from
                        BGT_B_CPN_MON_EXE_D t,(select id from BGT_B_CPN_MON_EXE 
                        where BUDGET_YEAR=config.budget_year 
                        and Budget_Contents_ID='00120003') T2
                        where t.base_id = T2.ID                    
                        and t.ITEM_ID=config.item_id;
                        end;
                        end if;
                    end;
                 end if;
                 --将可用预算,是否通过更新到执行明细表
                 update BGT_B_BUDGET_Control_D_EXE t
                 set t.available_money = V_BUDGET_AVAILABLE,
                 t.is_pass = (case when config.type_id = '02010002' then 1 /*弱控默认通过*/
                                  else 
                                     case when  /*强控比对可用预算和申请差异*/
                                     V_BUDGET_AVAILABLE >= t.apply_money then 1
                                     else 2
                                     end
                                  end)
                 where t.id = config.id
                 ;              
       end loop;       
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
         --rollback;/*在外部回滚*/
END SP_bgt_check_execute_data;


create or replace procedure SP_bgt_create_budget_account(p_yearid in char,p_msg out varchar2,p_succeed out number ) as
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、删除bgt_d_budget_account表中当前年的记录
   2、取当前年的bgt_d_budget_item中的所有记录,通过code和name左外关联到bgt_d_account_item表插入到bgt_d_budget_account表中
*/
begin
    --删除记录
    execute immediate 'delete from bgt_d_budget_account where budget_year = '''||p_yearid||'''';
    --新增记录
     execute immediate 'insert into bgt_d_budget_account(id,budget_item_id,account_item_id,budget_year)
     select sys_guid(),t.id,t1.id,'''||p_yearid||''' 
         from bgt_d_budget_item t
         left join bgt_d_account_item t1
         on t.code = t1.code and t.name = t1.name
         where t.budget_year='''||p_yearid||'''';
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_create_budget_account;


create or replace procedure SP_bgt_create_budget_adjust(p_adjustid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、从执行区拷贝,生成BGT_B_DEPT_MON_ADJUST/BGT_B_DEPT_MON_ADJUST_D记录(先删除,后插入)
   2、从执行区拷贝,生成BGT_B_DEPT_YEAR_ADJUST/BGT_B_DEPT_YEAR_ADJUST_D记录(先删除,后插入)
*/
begin
      --从执行区拷贝,生成BGT_B_DEPT_MON_ADJUST/BGT_B_DEPT_MON_ADJUST_D记录
      for config in(
                    select
                    t.id,
                    t.BUDGET_DEPT_ID,
                    t.BUDGET_CONTENTS_ID                                 
                    from  BGT_B_DEPT_MON_EXE t,BGT_B_BUDGET_ADJUST t1
                    where t.budget_year = t1.budget_year
                    and t1.id = p_adjustid

                  )
       loop  
                   --先删除
                   execute immediate 'delete from BGT_B_DEPT_MON_ADJUST where id ='''||config.id||''''; 
                   --后插入
                   execute immediate 'insert into BGT_B_DEPT_MON_ADJUST
                  (
                    id                ,
                    adjust_id         ,
                    budget_dept_id    ,
                    budget_contents_id,
                    is_function ,
                    state      
                  )
                  select 
                  '''||config.id||''',
                  '''||p_adjustid||''',
                  '''||config.BUDGET_DEPT_ID||''',
                  '''||config.BUDGET_CONTENTS_ID||''',
                  t.is_function,1
                  from BGT_D_BUDGET_DEPT t
                  where t.id =  '''||config.BUDGET_DEPT_ID||'''';      
                  execute immediate 'insert into BGT_B_DEPT_MON_ADJUST_D
                  (
                    id              ,
                    base_id         ,
                    item_id         ,       
                    m_1_base_value  ,
                    m_2_base_value  ,
                    m_3_base_value  ,
                    m_4_base_value  ,
                    m_5_base_value  ,
                    m_6_base_value  ,
                    m_7_base_value  ,
                    m_8_base_value  ,
                    m_9_base_value  ,
                    m_10_base_value ,
                    m_11_base_value ,
                    m_12_base_value ,
                    m_1_value  ,
                    m_2_value  ,
                    m_3_value  ,
                    m_4_value  ,
                    m_5_value  ,
                    m_6_value  ,
                    m_7_value  ,
                    m_8_value  ,
                    m_9_value  ,
                    m_10_value ,
                    m_11_value ,
                    m_12_value 
                  ) 
                  select t.id,
                  '''||config.id||''',
                  t.item_id,
                  t.m_1_value  ,
                  t.m_2_value  ,
                  t.m_3_value  ,
                  t.m_4_value  ,
                  t.m_5_value  ,
                  t.m_6_value  ,
                  t.m_7_value  ,
                  t.m_8_value  ,
                  t.m_9_value  ,
                  t.m_10_value ,
                  t.m_11_value ,
                  t.m_12_value ,
                  t.m_1_value  ,
                  t.m_2_value  ,
                  t.m_3_value  ,
                  t.m_4_value  ,
                  t.m_5_value  ,
                  t.m_6_value  ,
                  t.m_7_value  ,
                  t.m_8_value  ,
                  t.m_9_value  ,
                  t.m_10_value ,
                  t.m_11_value ,
                  t.m_12_value 
                  from 
                  BGT_B_DEPT_MON_EXE_D t
                  where t.base_id = '''||config.id||'''
                  ';
       end loop;   
      --从执行区拷贝,生成BGT_B_DEPT_YEAR_ADJUST/BGT_B_DEPT_YEAR_ADJUST_D记录
      for config in(
                    select
                    t.id,
                    t.BUDGET_DEPT_ID,
                    t.BUDGET_CONTENTS_ID                                 
                    from  BGT_B_DEPT_YEAR_EXE t,BGT_B_BUDGET_ADJUST t1
                    where t.budget_year = t1.budget_year
                    and t1.id = p_adjustid

                  )
       loop  
                   --先删除
                   execute immediate 'delete from BGT_B_DEPT_YEAR_ADJUST where id ='''||config.id||''''; 
                   --后插入
                  execute immediate 'insert into BGT_B_DEPT_YEAR_ADJUST
                  (
                    id                ,
                    adjust_id         ,
                    budget_dept_id    ,
                    budget_contents_id,
                    is_function  ,
                    state     
                  )
                  select 
                  '''||config.id||''',
                  '''||p_adjustid||''',
                  '''||config.BUDGET_DEPT_ID||''',
                  '''||config.BUDGET_CONTENTS_ID||''',
                  t.is_function,1
                  from BGT_D_BUDGET_DEPT t
                  where t.id =  '''||config.BUDGET_DEPT_ID||'''';      
                  execute immediate 'insert into BGT_B_DEPT_YEAR_ADJUST_D
                  (
                    id          ,
                    base_id     ,
                    item_id     ,
                    budget_base   ,
                    item_value                
                  ) 
                  select t.id,
                  '''||config.id||''',
                  t.item_id,
                  t.ITEM_VALUE,
                  t.ITEM_VALUE
                  from 
                  BGT_B_DEPT_YEAR_EXE_D t
                  where t.base_id = '''||config.id||'''
                  ';
       end loop; 
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_create_budget_adjust;


create or replace procedure SP_bgt_Create_ProjExecuteData(p_projid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、先删除对应的项目年度结转数据
   2、创建对应的项目年度结转数据
   3、创建对应的项目年度结转明细数据
*/
begin
      --先删除对应的项目年度结转数据
      execute immediate 'delete from BGT_B_BUDGET_PROJ_CO t
      where  t.PROJECT_ID = '''||p_projid||''' and t.BUDGET_YEAR = 
      (select BUDGET_YEAR from BGT_B_BUDGET_PROJ where id ='''||p_projid||''' )'; 
      --变量初始化
      execute immediate ' select sys_guid() from dual' into  V_NEW_GUID;
      --创建对应的项目年度结转数据
      execute immediate 'insert into BGT_B_BUDGET_PROJ_CO
      (id,PROJECT_ID,BUDGET_YEAR,EXECUTED_MONEY,BUDGET_MONEY,STATE,IS_RECENTLY)
      select '''||V_NEW_GUID||''',id,BUDGET_YEAR,0,REPLY_MONEY,3,1 from BGT_B_BUDGET_PROJ
      where id = '''||p_projid||'''';
      --创建对应的项目年度结转明细数据
      execute immediate 'insert into BGT_B_BUDGET_PROJ_CO_D 
      (id,base_id,item_id,budget_money,executed_money)
      select sys_guid(),'''||V_NEW_GUID||''',id,REPLY_MONEY,0 from BGT_B_BUDGET_PROJ_D
      where base_id = '''||p_projid||'''  ';  
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_Create_ProjExecuteData;


create or replace procedure SP_bgt_pub_inc_data(p_dataid in char,p_msg out varchar2,p_succeed out number ) as
V_BUDGET_YEAR varchar2(36);
V_BUDGET_CPN_ID varchar2(36);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、创建当前预算年度的执行版数据
   1.1、复制单位年、单位月、科室年、科室月的编制区数据到执行区
   1.2、复制单位月、科室月、单位年【未实现】、科室年【未实现】的编制区数据到历史区
   1.3、依据会计科目和预算科目的对应关系，写会计科目数据到执行区
   1.4、更新单位年、单位月、科室年、科室月的编制区数据状态
   1.5、更新当前记录的数据状态
*/
begin
    --变量初始化
    execute immediate 'select BUDGET_YEAR,BUDGET_CPN_ID from BGT_B_BUDGET_DATA where id='''||p_dataid||''''
     into V_BUDGET_YEAR,V_BUDGET_CPN_ID;

    --1.1复制单位年、单位月、科室年、科室月的编制区数据到执行区
    --删除记录
    execute immediate 'delete from BGT_B_CPN_YEAR_EXE where budget_contents_id =''00120002'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_CPN_MON_EXE where budget_contents_id =''00120002'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_DEPT_YEAR_EXE where budget_contents_id =''00120002'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_DEPT_MON_EXE where budget_contents_id =''00120002'' and budget_year = '''||V_BUDGET_YEAR||'''';
    
    execute immediate 'delete from BGT_B_CPN_YEAR_EXE where budget_contents_id =''00120004'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_CPN_MON_EXE where budget_contents_id =''00120004'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_DEPT_YEAR_EXE where budget_contents_id =''00120004'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_DEPT_MON_EXE where budget_contents_id =''00120004'' and budget_year = '''||V_BUDGET_YEAR||'''';
    
    execute immediate 'delete from BGT_B_CPN_HIS_DATA where budget_contents_id =''00120002'' and budget_year = '''||V_BUDGET_YEAR||''''; --单位月历史
    execute immediate 'delete from BGT_B_DEPT_HIS_DATA where budget_contents_id =''00120002'' and budget_year = '''||V_BUDGET_YEAR||'''';--科室月历史
    --新增记录
    for config in(
                    select t.id,
                    t.BUDGET_YEAR,
                    t.budget_cpn_id
                    from BGT_B_CPN_INC_YEAR t
                    where t.BUDGET_YEAR = V_BUDGET_YEAR
                    --and t.budget_cpn_id = V_BUDGET_CPN_ID
                  )
          loop
             execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
             --单位年主表
             execute immediate 'insert into BGT_B_CPN_YEAR_EXE(id,budget_year,budget_cpn_id,budget_contents_id)
             select '''||V_NEW_GUID||''','''||config.budget_year||''','''||config.budget_cpn_id||''',''00120002''
             from dual';
             --单位年明细表
              execute immediate 'insert into BGT_B_CPN_YEAR_EXE_D(id ,base_id,item_id,item_value,item_fact_value)
              select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.item_value,0
                 from BGT_B_CPN_INC_YEAR_D t  where t.base_id ='''||config.id||'''';
                 
             execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
             --单位年主表-会计科目             
             execute immediate 'insert into BGT_B_CPN_YEAR_EXE(id,budget_year,budget_cpn_id,budget_contents_id)
             select '''||V_NEW_GUID||''','''||config.budget_year||''','''||config.budget_cpn_id||''',''00120004''
             from dual';
             --单位年明细表-会计科目
             execute immediate 'insert into BGT_B_CPN_YEAR_EXE_D(id ,base_id,item_id,item_value,item_fact_value)
              select sys_guid(),'''||V_NEW_GUID||''',t1.account_item_id,t.item_value,0
                 from BGT_B_CPN_INC_YEAR_D t 
                 left join BGT_D_BUDGET_ACCOUNT t1 on t.item_id = t1.budget_item_id
                   where t.base_id ='''||config.id||''' 
                   and t1.budget_year = '''||V_BUDGET_YEAR||'''';
             --更新编制区数据状态
             execute immediate ' update BGT_B_CPN_INC_YEAR set state = 4 where id = '''||config.id||'''';
          end loop;

      for config in(
                    select t.id,
                    t.BUDGET_YEAR,
                    t.budget_cpn_id
                    from BGT_B_CPN_INC_MON t
                    where t.BUDGET_YEAR = V_BUDGET_YEAR
                    --and t.budget_cpn_id = V_BUDGET_CPN_ID
                  )
          loop
            execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
            --单位月主表
            execute immediate 'insert into BGT_B_CPN_MON_EXE(id,budget_year,budget_cpn_id,budget_contents_id)
            select '''||V_NEW_GUID||''','''||config.BUDGET_YEAR||''','''||config.budget_cpn_id||''',''00120002''
            from dual';
            --单位月明细表
            execute immediate 'insert into BGT_B_CPN_MON_EXE_D(id ,base_id,item_id, m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value,
                                      m_1_fact_value,
                                      m_2_fact_value,
                                      m_3_fact_value,
                                      m_4_fact_value,
                                      m_5_fact_value,
                                      m_6_fact_value,
                                      m_7_fact_value,
                                      m_8_fact_value,
                                      m_9_fact_value,
                                      m_10_fact_value,
                                      m_11_fact_value,
                                      m_12_fact_value)
            select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value,0,0,0,0,0,0,0,0,0,0,0,0
               from BGT_B_CPN_INC_MON_D t  where t.base_id ='''||config.id||'''';
               
            execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
            --单位月主表-会计科目
            execute immediate 'insert into BGT_B_CPN_MON_EXE(id,budget_year,budget_cpn_id,budget_contents_id)
            select '''||V_NEW_GUID||''','''||config.BUDGET_YEAR||''','''||config.budget_cpn_id||''',''00120004''
            from dual';
            --单位月明细表-会计科目
            execute immediate 'insert into BGT_B_CPN_MON_EXE_D(id ,base_id,item_id,m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value,
                                      m_1_fact_value,
                                      m_2_fact_value,
                                      m_3_fact_value,
                                      m_4_fact_value,
                                      m_5_fact_value,
                                      m_6_fact_value,
                                      m_7_fact_value,
                                      m_8_fact_value,
                                      m_9_fact_value,
                                      m_10_fact_value,
                                      m_11_fact_value,
                                      m_12_fact_value)
            select sys_guid(),'''||V_NEW_GUID||''',t1.account_item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value,0,0,0,0,0,0,0,0,0,0,0,0
               from BGT_B_CPN_INC_MON_D t 
                left join BGT_D_BUDGET_ACCOUNT t1 on t.item_id = t1.budget_item_id
                   where t.base_id ='''||config.id||''' 
                   and t1.budget_year = '''||V_BUDGET_YEAR||'''';
                   
                   
            execute immediate 'select sys_guid() from dual' into V_NEW_GUID;          
            --单位月历史表
            execute immediate 'insert into BGT_B_CPN_HIS_DATA(id,budget_year,budget_cpn_id,budget_contents_id,state)
            select '''||V_NEW_GUID||''','''||config.BUDGET_YEAR||''','''||config.budget_cpn_id||''',''00120002'',4
            from dual';
            --单位月历史明细表
            execute immediate 'insert into BGT_B_CPN_HIS_DATA_D(id,base_id,item_id,m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value)
            select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value
            from BGT_B_CPN_INC_MON_D t  where t.base_id ='''||config.id||'''';
            --更新编制区数据状态
            execute immediate ' update BGT_B_CPN_INC_MON set state = 4 where id = '''||config.id||'''';
          end loop;
      for config in(
                    select t.id,
                    t.BUDGET_YEAR,
                    t.budget_dept_id
                    from BGT_B_DEPT_INC_YEAR t
                    where t.BUDGET_YEAR = V_BUDGET_YEAR
                  )
          loop
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              --科室年主表
              execute immediate 'insert into BGT_B_DEPT_YEAR_EXE(id,budget_year,budget_cpn_id,budget_contents_id,budget_dept_id)
              select '''||V_NEW_GUID||''','''||config.budget_year||''','''||V_BUDGET_CPN_ID||''',''00120002'','''||config.budget_dept_id||'''
              from dual';
              --科室年明细表
               execute immediate 'insert into BGT_B_DEPT_YEAR_EXE_D(id ,base_id,item_id,item_value,item_fact_value)
              select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.item_value,0
                 from BGT_B_DEPT_INC_YEAR_D t  where t.base_id ='''||config.id||'''';
                 
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              --科室年主表-会计科目
              execute immediate 'insert into BGT_B_DEPT_YEAR_EXE(id,budget_year,budget_cpn_id,budget_contents_id,budget_dept_id)
              select '''||V_NEW_GUID||''','''||config.budget_year||''','''||V_BUDGET_CPN_ID||''',''00120004'','''||config.budget_dept_id||'''
              from dual';
              --科室年明细表-会计科目
              execute immediate 'insert into BGT_B_DEPT_YEAR_EXE_D(id ,base_id,item_id,item_value,item_fact_value)
              select sys_guid(),'''||V_NEW_GUID||''',t1.account_item_id,t.item_value,0
                 from BGT_B_DEPT_INC_YEAR_D t
                   left join BGT_D_BUDGET_ACCOUNT t1 on t.item_id = t1.budget_item_id
                   where t.base_id ='''||config.id||''' 
                   and t1.budget_year = '''||V_BUDGET_YEAR||'''';
                   
                 
              --更新编制区数据状态
              execute immediate ' update BGT_B_DEPT_INC_YEAR set state = 4 where id = '''||config.id||'''';
          end loop;
          for config in(
                    select t.id,
                    t.BUDGET_YEAR,
                    t.budget_dept_id
                    from BGT_B_DEPT_INC_MON t
                    where t.BUDGET_YEAR = V_BUDGET_YEAR
                  )
          loop
             execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              --科室月主表
              execute immediate 'insert into BGT_B_DEPT_MON_EXE(id,budget_year,budget_cpn_id,budget_contents_id,budget_dept_id)
              select '''||V_NEW_GUID||''','''||config.budget_year||''','''||V_BUDGET_CPN_ID||''',''00120002'','''||config.budget_dept_id||'''
              from dual';
              --科室月明细表
              execute immediate 'insert into BGT_B_DEPT_MON_EXE_D(id ,base_id,item_id,m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value,
                                      m_1_fact_value,
                                      m_2_fact_value,
                                      m_3_fact_value,
                                      m_4_fact_value,
                                      m_5_fact_value,
                                      m_6_fact_value,
                                      m_7_fact_value,
                                      m_8_fact_value,
                                      m_9_fact_value,
                                      m_10_fact_value,
                                      m_11_fact_value,
                                      m_12_fact_value)
              select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value,0,0,0,0,0,0,0,0,0,0,0,0
                 from BGT_B_DEPT_INC_MON_D t  where t.base_id ='''||config.id||'''';
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              --科室月主表-会计科目
              execute immediate 'insert into BGT_B_DEPT_MON_EXE(id,budget_year,budget_cpn_id,budget_contents_id,budget_dept_id)
              select '''||V_NEW_GUID||''','''||config.budget_year||''','''||V_BUDGET_CPN_ID||''',''00120004'','''||config.budget_dept_id||'''
              from dual';
              --科室月明细表-会计科目
              execute immediate 'insert into BGT_B_DEPT_MON_EXE_D(id ,base_id,item_id,m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value,
                                      m_1_fact_value,
                                      m_2_fact_value,
                                      m_3_fact_value,
                                      m_4_fact_value,
                                      m_5_fact_value,
                                      m_6_fact_value,
                                      m_7_fact_value,
                                      m_8_fact_value,
                                      m_9_fact_value,
                                      m_10_fact_value,
                                      m_11_fact_value,
                                      m_12_fact_value)
              select sys_guid(),'''||V_NEW_GUID||''',t1.account_item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value,0,0,0,0,0,0,0,0,0,0,0,0
                 from BGT_B_DEPT_INC_MON_D t  
                 left join BGT_D_BUDGET_ACCOUNT t1 on t.item_id = t1.budget_item_id
                   where t.base_id ='''||config.id||''' 
                   and t1.budget_year = '''||V_BUDGET_YEAR||'''';
              
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              --科室月历史表
              execute immediate 'insert into BGT_B_DEPT_HIS_DATA(id,budget_year,budget_dept_id,budget_contents_id,state)
              select '''||V_NEW_GUID||''','''||config.BUDGET_YEAR||''','''||config.budget_dept_id||''',''00120002'',4
              from dual';
              --科室月历史明细表
              execute immediate 'insert into BGT_B_DEPT_HIS_DATA_D(id,base_id,item_id,m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value)
              select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value
              from BGT_B_DEPT_INC_MON_D t  where t.base_id ='''||config.id||'''';
              --更新编制区数据状态
              execute immediate ' update BGT_B_DEPT_INC_MON set state = 4 where id = '''||config.id||'''';
         end loop;
         --更新当前记录的数据状态
         execute immediate 'update BGT_B_BUDGET_DATA set state = 4 where id='''||p_dataid||'''';
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_pub_inc_data;



create or replace procedure SP_bgt_pub_inc_fact_data(p_factid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_DYNCOLUMN varchar2(36);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、从BGT_B_DEPT_INC_MON_FACT按预算科目和预算内容数据类型更新到BGT_B_DEPT_MON_EXE（科室月）
   2、从BGT_B_DEPT_MON_EXE（科室月）汇总更新到BGT_B_DEPT_YEAR_EXE（科室年）
   3、从BGT_B_DEPT_MON_EXE（科室月）汇总更新到BGT_B_CPN_MON_EXE（单位月）
   4、从BGT_B_DEPT_YEAR_EXE（科室年）汇总更新到BGT_B_CPN_YEAR_EXE（单位年）
   5、修改BGT_B_DEPT_INC_MON_FACT状态为归档
*/
begin
      --1、从BGT_B_DEPT_INC_MON_FACT按预算科目和预算内容数据类型更新到BGT_B_DEPT_MON_EXE（科室月）
      for config in(
                    select
                    t2.id,
                    t2.item_id,
                    t2.fact_value,
                    t.BUDGET_DEPT_ID,
                    t.finance_cycle
                    from  BGT_B_DEPT_INC_MON_FACT t,BGT_B_DEPT_INC_MON_FACT_D t2
                    where t2.base_id = t.id
                    and t.id = p_factid
                  )
       loop
                  --计算要更新的目标列
                  select
                  'm_'||decode(substr(config.finance_cycle,5,1),'1',substr(config.finance_cycle,5,2),substr(config.finance_cycle,6,1))||
                  '_fact_value' into V_DYNCOLUMN from dual;
                  dbms_output.put_line(V_DYNCOLUMN);
                  --更新预算内容为收入的数据,更新形式为覆写
                   execute immediate '
                  update BGT_B_DEPT_MON_EXE_D t1 set
                  t1.'||V_DYNCOLUMN||' = '||config.fact_value||'
                  where t1.item_id = '''||config.item_id||'''
                  and t1.base_id = (
                      select b.id from BGT_B_DEPT_MON_EXE b where b.budget_dept_id =
                      '''||config.budget_dept_id||'''
                      and b.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr('''||config.finance_cycle||''',0,4))
                      and BUDGET_CONTENTS_ID = ''00120002''
                  )';
       end loop;
      --2、从BGT_B_DEPT_MON_EXE（科室月）汇总更新到BGT_B_DEPT_YEAR_EXE（科室年）
      for config in(
                    select
                              t2.item_id,
                              (t2.m_1_fact_value + t2.m_2_fact_value + t2.m_3_fact_value +
                              t2.m_4_fact_value + t2.m_5_fact_value + t2.m_6_fact_value +
                              t2.m_7_fact_value + t2.m_8_fact_value + t2.m_9_fact_value +
                              t2.m_10_fact_value + t2.m_11_fact_value + t2.m_12_fact_value) as fact_value,
                              t3.finance_cycle,
                              t.BUDGET_DEPT_ID,
                              t.BUDGET_CONTENTS_ID
                    from  BGT_B_DEPT_MON_EXE t,BGT_B_DEPT_MON_EXE_D t2,BGT_B_DEPT_INC_MON_FACT t3
                    where t2.base_id = t.id
                    and t3.id = p_factid
                    and t3.budget_dept_id = t.budget_dept_id
                    and t.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr(t3.finance_cycle,0,4))
                  )
       loop
                   --更新形式为覆写
                   update BGT_B_DEPT_YEAR_EXE_D t
                   set t.item_fact_value = config.fact_value
                   where t.base_id =
                   (
                         select b.id from BGT_B_DEPT_YEAR_EXE b
                         where b.budget_year =
                               (select id from
                                       bgt_d_budget_year
                                where  budget_year=substr(config.finance_cycle,0,4)
                                )
                         and b.budget_dept_id = config.BUDGET_DEPT_ID
                         and b.budget_contents_id = config.budget_contents_id
                    )
                   and t.item_id =  config.item_id;
       end loop;
       --3、从BGT_B_DEPT_MON_EXE（科室月）汇总更新到BGT_B_CPN_MON_EXE（单位月）
      for config in(
                    select
                    t2.item_id,
                    sum(t2.m_1_fact_value + t2.m_2_fact_value + t2.m_3_fact_value +
                    t2.m_4_fact_value + t2.m_5_fact_value + t2.m_6_fact_value +
                    t2.m_7_fact_value + t2.m_8_fact_value + t2.m_9_fact_value +
                    t2.m_10_fact_value + t2.m_11_fact_value + t2.m_12_fact_value) as fact_value,
                    t3.finance_cycle,
                    t.BUDGET_DEPT_ID,
                    t.BUDGET_CONTENTS_ID
                    from  BGT_B_DEPT_MON_EXE t,BGT_B_DEPT_MON_EXE_D t2,BGT_B_DEPT_INC_MON_FACT t3
                    where t2.base_id = t.id
                    and t3.id = p_factid
                    and t3.budget_dept_id = t.budget_dept_id
                    and t.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr(t3.finance_cycle,0,4))
                    group by t2.item_id,t3.finance_cycle,t.BUDGET_DEPT_ID,t.BUDGET_CONTENTS_ID
                  )
       loop
                    --计算要更新的目标列
                  select
                  'm_'||decode(substr(config.finance_cycle,5,1),'1',substr(config.finance_cycle,5,2),substr(config.finance_cycle,6,1))||
                  '_fact_value' into V_DYNCOLUMN from dual;
                  --更新预算内容为收入的数据,更新形式为覆写
                  execute immediate '
                  update BGT_B_CPN_MON_EXE_D t1 set
                  t1.'||V_DYNCOLUMN||' = '||config.fact_value||'
                  where t1.item_id = '''||config.item_id||'''
                  and t1.base_id = (
                      select b.id from BGT_B_CPN_MON_EXE b where
                      b.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr('''||config.finance_cycle||''',0,4))
                      and BUDGET_CONTENTS_ID = ''00120002''
                  )';
       end loop;
       --4、从BGT_B_DEPT_YEAR_EXE（科室年）汇总更新到BGT_B_CPN_YEAR_EXE（单位年）
       for config in(
                    select
                              t2.item_id,
                              sum(t2.item_fact_value) as fact_value,
                              t3.finance_cycle,
                              t.BUDGET_DEPT_ID,
                              t.BUDGET_CONTENTS_ID
                    from  BGT_B_DEPT_YEAR_EXE t,BGT_B_DEPT_YEAR_EXE_D t2,BGT_B_DEPT_INC_MON_FACT t3
                    where t2.base_id = t.id
                    and t3.id = p_factid
                    and t3.budget_dept_id = t.budget_dept_id
                    and t.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr(t3.finance_cycle,0,4))
                    group by t2.item_id,t3.finance_cycle,t.BUDGET_DEPT_ID,t.BUDGET_CONTENTS_ID
                  )
       loop
                   --更新形式为覆写
                   update BGT_B_CPN_YEAR_EXE_D t
                   set t.item_fact_value = config.fact_value
                   where t.base_id =
                   (
                         select b.id from BGT_B_CPN_YEAR_EXE b
                         where b.budget_year =
                               (select id from
                                       bgt_d_budget_year
                                where  budget_year=substr(config.finance_cycle,0,4)
                                )
                         and b.budget_contents_id = config.budget_contents_id
                    )
                   and t.item_id =  config.item_id;
       end loop;
       --5、修改BGT_B_DEPT_INC_MON_FACT状态为归档
       execute immediate 'update BGT_B_DEPT_INC_MON_FACT set state = 4 where id = '''||p_factid||'''';
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_pub_inc_fact_data;


create or replace procedure SP_bgt_pub_pay_data(p_dataid in char,p_msg out varchar2,p_succeed out number ) as
V_BUDGET_YEAR varchar2(36);
V_BUDGET_CPN_ID varchar2(36);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、创建当前预算年度的执行版数据
   1.1、复制单位年、单位月、科室年、科室月的编制区数据到执行区
   1.2、复制单位月、科室月、单位年【未实现】、科室年【未实现】的编制区数据到历史区
   1.3、依据会计科目和预算科目的对应关系，写会计科目数据到执行区
   1.4、更新单位年、单位月、科室年、科室月的编制区数据状态
   1.5、更新当前记录的数据状态
*/
begin
    --变量初始化
    execute immediate 'select BUDGET_YEAR,BUDGET_CPN_ID from BGT_B_BUDGET_DATA where id='''||p_dataid||''''
     into V_BUDGET_YEAR,V_BUDGET_CPN_ID;

    --1.1复制单位年、单位月、科室年、科室月的编制区数据到执行区
    --删除记录
    execute immediate 'delete from BGT_B_CPN_YEAR_EXE where budget_contents_id =''00120003'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_CPN_MON_EXE where budget_contents_id =''00120003'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_DEPT_YEAR_EXE where budget_contents_id =''00120003'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_DEPT_MON_EXE where budget_contents_id =''00120003'' and budget_year = '''||V_BUDGET_YEAR||'''';
    
    execute immediate 'delete from BGT_B_CPN_YEAR_EXE where budget_contents_id =''00120004'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_CPN_MON_EXE where budget_contents_id =''00120004'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_DEPT_YEAR_EXE where budget_contents_id =''00120004'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_DEPT_MON_EXE where budget_contents_id =''00120004'' and budget_year = '''||V_BUDGET_YEAR||'''';
    
    execute immediate 'delete from BGT_B_CPN_HIS_DATA where budget_contents_id =''00120003'' and budget_year = '''||V_BUDGET_YEAR||''''; --单位月历史
    execute immediate 'delete from BGT_B_DEPT_HIS_DATA where budget_contents_id =''00120003'' and budget_year = '''||V_BUDGET_YEAR||'''';--科室月历史
    --新增记录
    for config in(
                    select t.id,
                    t.BUDGET_YEAR,
                    t.budget_cpn_id
                    from BGT_B_CPN_PAY_YEAR t
                    where t.BUDGET_YEAR = V_BUDGET_YEAR
                    --and t.budget_cpn_id = V_BUDGET_CPN_ID
                  )
          loop
             execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
             --单位年主表
             execute immediate 'insert into BGT_B_CPN_YEAR_EXE(id,budget_year,budget_cpn_id,budget_contents_id)
             select '''||V_NEW_GUID||''','''||config.budget_year||''','''||config.budget_cpn_id||''',''00120003''
             from dual';
             --单位年明细表
              execute immediate 'insert into BGT_B_CPN_YEAR_EXE_D(id ,base_id,item_id,item_value,item_fact_value)
              select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.item_value,0
                 from BGT_B_CPN_PAY_YEAR_D t  where t.base_id ='''||config.id||'''';
                 
             execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
             --单位年主表-会计科目
             execute immediate 'insert into BGT_B_CPN_YEAR_EXE(id,budget_year,budget_cpn_id,budget_contents_id)
             select '''||V_NEW_GUID||''','''||config.budget_year||''','''||config.budget_cpn_id||''',''00120004''
             from dual';
             --单位年明细表-会计科目
              execute immediate 'insert into BGT_B_CPN_YEAR_EXE_D(id ,base_id,item_id,item_value,item_fact_value)
              select sys_guid(),'''||V_NEW_GUID||''',t1.account_item_id,t.item_value,0
                 from BGT_B_CPN_PAY_YEAR_D t  
                  left join BGT_D_BUDGET_ACCOUNT t1 on t.item_id = t1.budget_item_id
                   where t.base_id ='''||config.id||''' 
                   and t1.budget_year = '''||V_BUDGET_YEAR||'''';  
                 
             --更新编制区数据状态
             execute immediate ' update BGT_B_CPN_PAY_YEAR set state = 4 where id = '''||config.id||'''';
          end loop;

      for config in(
                    select t.id,
                    t.BUDGET_YEAR,
                    t.budget_cpn_id
                    from BGT_B_CPN_PAY_MON t
                    where t.BUDGET_YEAR = V_BUDGET_YEAR
                    --and t.budget_cpn_id = V_BUDGET_CPN_ID
                  )
          loop
            execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
            --单位月主表
            execute immediate 'insert into BGT_B_CPN_MON_EXE(id,budget_year,budget_cpn_id,budget_contents_id)
            select '''||V_NEW_GUID||''','''||config.BUDGET_YEAR||''','''||config.budget_cpn_id||''',''00120003''
            from dual';
            --单位月明细表
            execute immediate 'insert into BGT_B_CPN_MON_EXE_D(id ,base_id,item_id,
                                      m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value,
                                      m_1_fact_value,
                                      m_2_fact_value,
                                      m_3_fact_value,
                                      m_4_fact_value,
                                      m_5_fact_value,
                                      m_6_fact_value,
                                      m_7_fact_value,
                                      m_8_fact_value,
                                      m_9_fact_value,
                                      m_10_fact_value,
                                      m_11_fact_value,
                                      m_12_fact_value)
            select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value,0,0,0,0,0,0,0,0,0,0,0,0
               from BGT_B_CPN_PAY_MON_D t  where t.base_id ='''||config.id||'''';
               
             execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
            --单位月主表-会计科目
            execute immediate 'insert into BGT_B_CPN_MON_EXE(id,budget_year,budget_cpn_id,budget_contents_id)
            select '''||V_NEW_GUID||''','''||config.BUDGET_YEAR||''','''||config.budget_cpn_id||''',''00120004''
            from dual';
            --单位月明细表-会计科目
            execute immediate 'insert into BGT_B_CPN_MON_EXE_D(id ,base_id,item_id,m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value,
                                      m_1_fact_value,
                                      m_2_fact_value,
                                      m_3_fact_value,
                                      m_4_fact_value,
                                      m_5_fact_value,
                                      m_6_fact_value,
                                      m_7_fact_value,
                                      m_8_fact_value,
                                      m_9_fact_value,
                                      m_10_fact_value,
                                      m_11_fact_value,
                                      m_12_fact_value)
            select sys_guid(),'''||V_NEW_GUID||''',t1.account_item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value,0,0,0,0,0,0,0,0,0,0,0,0
               from BGT_B_CPN_PAY_MON_D t  
               left join BGT_D_BUDGET_ACCOUNT t1 on t.item_id = t1.budget_item_id
                   where t.base_id ='''||config.id||''' 
                   and t1.budget_year = '''||V_BUDGET_YEAR||'''';  
             
               
            execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
            --单位月历史表
            execute immediate 'insert into BGT_B_CPN_HIS_DATA(id,budget_year,budget_cpn_id,budget_contents_id,state)
            select '''||V_NEW_GUID||''','''||config.BUDGET_YEAR||''','''||config.budget_cpn_id||''',''00120003'',4
            from dual';
            --单位月历史明细表
            execute immediate 'insert into BGT_B_CPN_HIS_DATA_D(id,base_id,item_id,m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value)
            select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value
            from BGT_B_CPN_PAY_MON_D t  where t.base_id ='''||config.id||'''';
            --更新编制区数据状态
            execute immediate ' update BGT_B_CPN_PAY_MON set state = 4 where id = '''||config.id||'''';
          end loop;
      for config in(
                    select t.id,
                    t.BUDGET_YEAR,
                    t.budget_dept_id
                    from BGT_B_DEPT_PAY_YEAR t
                    where t.BUDGET_YEAR = V_BUDGET_YEAR
                  )
          loop
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              --科室年主表
              execute immediate 'insert into BGT_B_DEPT_YEAR_EXE(id,budget_year,budget_cpn_id,budget_contents_id,budget_dept_id)
              select '''||V_NEW_GUID||''','''||config.budget_year||''','''||V_BUDGET_CPN_ID||''',''00120003'','''||config.budget_dept_id||'''
              from dual';
              --科室年明细表
               execute immediate 'insert into BGT_B_DEPT_YEAR_EXE_D(id ,base_id,item_id,item_value,item_fact_value)
              select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.item_value,0
                 from BGT_B_DEPT_PAY_YEAR_D t  where t.base_id ='''||config.id||'''';
                 
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              --科室年主表-会计科目
              execute immediate 'insert into BGT_B_DEPT_YEAR_EXE(id,budget_year,budget_cpn_id,budget_contents_id,budget_dept_id)
              select '''||V_NEW_GUID||''','''||config.budget_year||''','''||V_BUDGET_CPN_ID||''',''00120004'','''||config.budget_dept_id||'''
              from dual';
              --科室年明细表-会计科目
               execute immediate 'insert into BGT_B_DEPT_YEAR_EXE_D(id ,base_id,item_id,item_value,item_fact_value)
              select sys_guid(),'''||V_NEW_GUID||''',t1.account_item_id,t.item_value,0
                 from BGT_B_DEPT_PAY_YEAR_D t 
                   left join BGT_D_BUDGET_ACCOUNT t1 on t.item_id = t1.budget_item_id
                   where t.base_id ='''||config.id||''' 
                   and t1.budget_year = '''||V_BUDGET_YEAR||'''';  
              
              
              --更新编制区数据状态
              execute immediate ' update BGT_B_DEPT_PAY_YEAR set state = 4 where id = '''||config.id||'''';
          end loop;
          for config in(
                    select t.id,
                    t.BUDGET_YEAR,
                    t.budget_dept_id
                    from BGT_B_DEPT_PAY_MON t
                    where t.BUDGET_YEAR = V_BUDGET_YEAR
                  )
          loop
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              --科室月主表
              execute immediate 'insert into BGT_B_DEPT_MON_EXE(id,budget_year,budget_cpn_id,budget_contents_id,budget_dept_id)
              select '''||V_NEW_GUID||''','''||config.budget_year||''','''||V_BUDGET_CPN_ID||''',''00120003'','''||config.budget_dept_id||'''
              from dual';
              --科室月明细表
              execute immediate 'insert into BGT_B_DEPT_MON_EXE_D(id ,base_id,item_id,m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value,
                                      m_1_fact_value,
                                      m_2_fact_value,
                                      m_3_fact_value,
                                      m_4_fact_value,
                                      m_5_fact_value,
                                      m_6_fact_value,
                                      m_7_fact_value,
                                      m_8_fact_value,
                                      m_9_fact_value,
                                      m_10_fact_value,
                                      m_11_fact_value,
                                      m_12_fact_value)
              select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value,0,0,0,0,0,0,0,0,0,0,0,0
                 from BGT_B_DEPT_PAY_MON_D t  where t.base_id ='''||config.id||'''';
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              --科室月主表-会计科目
              execute immediate 'insert into BGT_B_DEPT_MON_EXE(id,budget_year,budget_cpn_id,budget_contents_id,budget_dept_id)
              select '''||V_NEW_GUID||''','''||config.budget_year||''','''||V_BUDGET_CPN_ID||''',''00120004'','''||config.budget_dept_id||'''
              from dual';
              --科室月明细表-会计科目
              execute immediate 'insert into BGT_B_DEPT_MON_EXE_D(id ,base_id,item_id,m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value,
                                      m_1_fact_value,
                                      m_2_fact_value,
                                      m_3_fact_value,
                                      m_4_fact_value,
                                      m_5_fact_value,
                                      m_6_fact_value,
                                      m_7_fact_value,
                                      m_8_fact_value,
                                      m_9_fact_value,
                                      m_10_fact_value,
                                      m_11_fact_value,
                                      m_12_fact_value)
              select sys_guid(),'''||V_NEW_GUID||''',t1.account_item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value,0,0,0,0,0,0,0,0,0,0,0,0
                 from BGT_B_DEPT_PAY_MON_D t  
                 left join BGT_D_BUDGET_ACCOUNT t1 on t.item_id = t1.budget_item_id
                   where t.base_id ='''||config.id||''' 
                   and t1.budget_year = '''||V_BUDGET_YEAR||'''';  
                 
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;              
              --科室月历史表
              execute immediate 'insert into BGT_B_DEPT_HIS_DATA(id,budget_year,budget_dept_id,budget_contents_id,state)
              select '''||V_NEW_GUID||''','''||config.BUDGET_YEAR||''','''||config.budget_dept_id||''',''00120003'',4
              from dual';
              --科室月历史明细表
              execute immediate 'insert into BGT_B_DEPT_HIS_DATA_D(id,base_id,item_id,m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value)
              select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value
              from BGT_B_DEPT_PAY_MON_D t  where t.base_id ='''||config.id||'''';
              --更新编制区数据状态
              execute immediate ' update BGT_B_DEPT_PAY_MON set state = 4 where id = '''||config.id||'''';
         end loop;
         --更新当前记录的数据状态
         execute immediate 'update BGT_B_BUDGET_DATA set state = 4 where id='''||p_dataid||'''';
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_pub_pay_data;


create or replace procedure SP_bgt_pub_pay_exe_data(p_bizid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_DYNCOLUMN varchar2(36);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、更新BGT_B_BUDGET_CONTROL_D_EXE表中与当前bizid关联ispass=1的记录的执行金额(money)
   2、从BGT_B_BUDGET_CONTROL_D_EXE中取与当前bizid关联ispass=1的记录按预算科目和预算内容数据类型更新到
      对应版本
*/
begin
     --1、更新BGT_B_BUDGET_CONTROL_D_EXE表中与当前bizid关联ispass=1的记录的执行金额(money)
     update BGT_B_BUDGET_CONTROL_D_EXE t set t.money = t.apply_money
     where t.is_pass = 1
     and t.ref_tab_id = p_bizid;
     for config in(
                    select
                    t.id,
                    t.item_id,
                    t.money,
                    t.BUDGET_DEPT_ID,
                    t.finance_cycle,
                    d.edition_id
                    from  BGT_B_BUDGET_CONTROL_D_EXE t,BGT_B_BUDGET_CONTROL_D d
                    where t.ref_tab_id = p_bizid
                    and t.is_pass = 1 /*仅取已通过检查的数据*/
                  )
       loop
                if config.edition_id = '02020002' then --科室月
                 begin
                        --计算要更新的目标列
                        select
                        'm_'||decode(substr(config.finance_cycle,5,1),'1',substr(config.finance_cycle,5,2),substr(config.finance_cycle,6,1))||
                        '_fact_value' into V_DYNCOLUMN from dual;
                        dbms_output.put_line(V_DYNCOLUMN);
                        --更新预算内容为支出的数据,更新形式为追加
                         execute immediate '
                        update BGT_B_DEPT_MON_EXE_D t1 set
                        t1.'||V_DYNCOLUMN||' = t1.'||V_DYNCOLUMN||' + '||config.money||'
                        where t1.item_id = '''||config.item_id||'''
                        and t1.base_id = (
                            select b.id from BGT_B_DEPT_MON_EXE b where b.budget_dept_id =
                            '''||config.budget_dept_id||'''
                            and b.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr('''||config.finance_cycle||''',0,4))
                            and BUDGET_CONTENTS_ID = ''00120003''
                        )';
                 end;
                elsif config.edition_id = '02020001' then --科室年
                 begin
                       --更新形式为追加
                       update BGT_B_DEPT_YEAR_EXE_D t
                       set t.item_fact_value = t.item_fact_value + config.money
                       where t.base_id =
                       (
                             select b.id from BGT_B_DEPT_YEAR_EXE b
                             where b.budget_year =
                                   (select id from
                                           bgt_d_budget_year
                                    where  budget_year=substr(config.finance_cycle,0,4)
                                    )
                             and b.budget_dept_id = config.BUDGET_DEPT_ID
                             and b.budget_contents_id = '00120003'
                        )
                       and t.item_id =  config.item_id;
                 end;
                elsif config.edition_id = '02020003' then --单位年
                 begin
                        --更新形式为追加
                       update BGT_B_CPN_YEAR_EXE_D t
                       set t.item_fact_value = t.item_fact_value + config.money
                       where t.base_id =
                       (
                             select b.id from BGT_B_CPN_YEAR_EXE b
                             where b.budget_year =
                                   (select id from
                                           bgt_d_budget_year
                                    where  budget_year=substr(config.finance_cycle,0,4)
                                    )
                             and b.budget_contents_id = '00120003'
                        )
                       and t.item_id =  config.item_id;
                 end;
                elsif config.edition_id = '02020004' then --单位月
                 begin
                        --计算要更新的目标列
                        select
                        'm_'||decode(substr(config.finance_cycle,5,1),'1',substr(config.finance_cycle,5,2),substr(config.finance_cycle,6,1))||
                        '_fact_value' into V_DYNCOLUMN from dual;
                        --更新预算内容为支出的数据,更新形式为追加
                        execute immediate '
                        update BGT_B_CPN_MON_EXE_D t1 set
                        t1.'||V_DYNCOLUMN||' = t1.'||V_DYNCOLUMN||' + '||config.money||'
                        where t1.item_id = '''||config.item_id||'''
                        and t1.base_id = (
                            select b.id from BGT_B_CPN_MON_EXE b where
                            b.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr('''||config.finance_cycle||''',0,4))
                            and BUDGET_CONTENTS_ID = ''00120003''
                        )';
                 end;
                end if;
       end loop;

      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        --rollback;/*在外部回滚*/
END SP_bgt_pub_pay_exe_data;





create or replace procedure SP_bgt_pub_pay_fact_data(p_factid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_DYNCOLUMN varchar2(36);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、从BGT_B_DEPT_PAY_MON_FACT按预算科目和预算内容数据类型更新到BGT_B_DEPT_MON_EXE（科室月）
   2、从BGT_B_DEPT_MON_EXE（科室月）汇总更新到BGT_B_DEPT_YEAR_EXE（科室年）
   3、从BGT_B_DEPT_MON_EXE（科室月）汇总更新到BGT_B_CPN_MON_EXE（单位月）
   4、从BGT_B_DEPT_YEAR_EXE（科室年）汇总更新到BGT_B_CPN_YEAR_EXE（单位年）
   5、修改BGT_B_DEPT_PAY_MON_FACT状态为归档
*/
begin
      --1、从BGT_B_DEPT_PAY_MON_FACT按预算科目和预算内容数据类型更新到BGT_B_DEPT_MON_EXE（科室月）
      for config in(
                    select
                    t2.id,
                    t2.item_id,
                    t2.fact_value,
                    t.BUDGET_DEPT_ID,
                    t.finance_cycle
                    from  BGT_B_DEPT_PAY_MON_FACT t,BGT_B_DEPT_PAY_MON_FACT_D t2
                    where t2.base_id = t.id
                    and t.id = p_factid
                  )
       loop
                  --计算要更新的目标列
                  select
                  'm_'||decode(substr(config.finance_cycle,5,1),'1',substr(config.finance_cycle,5,2),substr(config.finance_cycle,6,1))||
                  '_fact_value' into V_DYNCOLUMN from dual;
                  dbms_output.put_line(V_DYNCOLUMN);
                  --更新预算内容为支出的数据,更新形式为覆写
                   execute immediate '
                  update BGT_B_DEPT_MON_EXE_D t1 set
                  t1.'||V_DYNCOLUMN||' = '||config.fact_value||'
                  where t1.item_id = '''||config.item_id||'''
                  and t1.base_id = (
                      select b.id from BGT_B_DEPT_MON_EXE b where b.budget_dept_id =
                      '''||config.budget_dept_id||'''
                      and b.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr('''||config.finance_cycle||''',0,4))
                      and BUDGET_CONTENTS_ID = ''00120003''
                  )';
       end loop;
      --2、从BGT_B_DEPT_MON_EXE（科室月）汇总更新到BGT_B_DEPT_YEAR_EXE（科室年）
      for config in(
                    select
                              t2.item_id,
                              (t2.m_1_fact_value + t2.m_2_fact_value + t2.m_3_fact_value +
                              t2.m_4_fact_value + t2.m_5_fact_value + t2.m_6_fact_value +
                              t2.m_7_fact_value + t2.m_8_fact_value + t2.m_9_fact_value +
                              t2.m_10_fact_value + t2.m_11_fact_value + t2.m_12_fact_value) as fact_value,
                              t3.finance_cycle,
                              t.BUDGET_DEPT_ID,
                              t.BUDGET_CONTENTS_ID
                    from  BGT_B_DEPT_MON_EXE t,BGT_B_DEPT_MON_EXE_D t2,BGT_B_DEPT_PAY_MON_FACT t3
                    where t2.base_id = t.id
                    and t3.id = p_factid
                    and t3.budget_dept_id = t.budget_dept_id
                    and t.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr(t3.finance_cycle,0,4))
                  )
       loop
                   --更新形式为覆写
                   update BGT_B_DEPT_YEAR_EXE_D t
                   set t.item_fact_value = config.fact_value
                   where t.base_id =
                   (
                         select b.id from BGT_B_DEPT_YEAR_EXE b
                         where b.budget_year =
                               (select id from
                                       bgt_d_budget_year
                                where  budget_year=substr(config.finance_cycle,0,4)
                                )
                         and b.budget_dept_id = config.BUDGET_DEPT_ID
                         and b.budget_contents_id = config.budget_contents_id
                    )
                   and t.item_id =  config.item_id;
       end loop;
       --3、从BGT_B_DEPT_MON_EXE（科室月）汇总更新到BGT_B_CPN_MON_EXE（单位月）
      for config in(
                    select
                    t2.item_id,
                    sum(t2.m_1_fact_value + t2.m_2_fact_value + t2.m_3_fact_value +
                    t2.m_4_fact_value + t2.m_5_fact_value + t2.m_6_fact_value +
                    t2.m_7_fact_value + t2.m_8_fact_value + t2.m_9_fact_value +
                    t2.m_10_fact_value + t2.m_11_fact_value + t2.m_12_fact_value) as fact_value,
                    t3.finance_cycle,
                    t.BUDGET_DEPT_ID,
                    t.BUDGET_CONTENTS_ID
                    from  BGT_B_DEPT_MON_EXE t,BGT_B_DEPT_MON_EXE_D t2,BGT_B_DEPT_PAY_MON_FACT t3
                    where t2.base_id = t.id
                    and t3.id = p_factid
                    and t3.budget_dept_id = t.budget_dept_id
                    and t.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr(t3.finance_cycle,0,4))
                    group by t2.item_id,t3.finance_cycle,t.BUDGET_DEPT_ID,t.BUDGET_CONTENTS_ID
                  )
       loop
                    --计算要更新的目标列
                  select
                  'm_'||decode(substr(config.finance_cycle,5,1),'1',substr(config.finance_cycle,5,2),substr(config.finance_cycle,6,1))||
                  '_fact_value' into V_DYNCOLUMN from dual;
                  --更新预算内容为支出的数据,更新形式为覆写
                  execute immediate '
                  update BGT_B_CPN_MON_EXE_D t1 set
                  t1.'||V_DYNCOLUMN||' = '||config.fact_value||'
                  where t1.item_id = '''||config.item_id||'''
                  and t1.base_id = (
                      select b.id from BGT_B_CPN_MON_EXE b where
                      b.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr('''||config.finance_cycle||''',0,4))
                      and BUDGET_CONTENTS_ID = ''00120003''
                  )';
       end loop;
       --4、从BGT_B_DEPT_YEAR_EXE（科室年）汇总更新到BGT_B_CPN_YEAR_EXE（单位年）
       for config in(
                    select
                              t2.item_id,
                              sum(t2.item_fact_value) as fact_value,
                              t3.finance_cycle,
                              t.BUDGET_DEPT_ID,
                              t.BUDGET_CONTENTS_ID
                    from  BGT_B_DEPT_YEAR_EXE t,BGT_B_DEPT_YEAR_EXE_D t2,BGT_B_DEPT_PAY_MON_FACT t3
                    where t2.base_id = t.id
                    and t3.id = p_factid
                    and t3.budget_dept_id = t.budget_dept_id
                    and t.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr(t3.finance_cycle,0,4))
                    group by t2.item_id,t3.finance_cycle,t.BUDGET_DEPT_ID,t.BUDGET_CONTENTS_ID
                  )
       loop
                   --更新形式为覆写
                   update BGT_B_CPN_YEAR_EXE_D t
                   set t.item_fact_value = config.fact_value
                   where t.base_id =
                   (
                         select b.id from BGT_B_CPN_YEAR_EXE b
                         where b.budget_year =
                               (select id from
                                       bgt_d_budget_year
                                where  budget_year=substr(config.finance_cycle,0,4)
                                )
                         and b.budget_contents_id = config.budget_contents_id
                    )
                   and t.item_id =  config.item_id;
       end loop;
       --5、修改BGT_B_DEPT_PAY_MON_FACT状态为归档
       execute immediate 'update BGT_B_DEPT_PAY_MON_FACT set state = 4 where id = '''||p_factid||'''';
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_pub_pay_fact_data;


create or replace procedure SP_bgt_pub_plan_data(p_dataid in char,p_msg out varchar2,p_succeed out number ) as
V_BUDGET_YEAR varchar2(36);
V_BUDGET_CPN_ID varchar2(36);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、创建当前预算年度的执行版数据
   1.1、复制单位年、单位月、科室年、科室月的编制区数据到执行区
   1.2、复制单位月、科室月、单位年【未实现】、科室年【未实现】的编制区数据到历史区
   1.3、更新单位年、单位月、科室年、科室月的编制区数据状态
   1.4、更新当前记录的数据状态
*/
begin
    --变量初始化
    execute immediate 'select BUDGET_YEAR,BUDGET_CPN_ID from BGT_B_BUDGET_DATA where id='''||p_dataid||''''
     into V_BUDGET_YEAR,V_BUDGET_CPN_ID;
        
    --1.1复制单位年、单位月、科室年、科室月的编制区数据到执行区
    --删除记录
    execute immediate 'delete from BGT_B_CPN_YEAR_EXE where budget_contents_id =''00120001'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_CPN_MON_EXE where budget_contents_id =''00120001'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_DEPT_YEAR_EXE where budget_contents_id =''00120001'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_DEPT_MON_EXE where budget_contents_id =''00120001'' and budget_year = '''||V_BUDGET_YEAR||'''';
    execute immediate 'delete from BGT_B_CPN_HIS_DATA where budget_contents_id =''00120001'' and budget_year = '''||V_BUDGET_YEAR||''''; --单位月历史
    execute immediate 'delete from BGT_B_DEPT_HIS_DATA where budget_contents_id =''00120001'' and budget_year = '''||V_BUDGET_YEAR||'''';--科室月历史
    --新增记录
    for config in(
                    select t.id,
                    t.BUDGET_YEAR,
                    t.budget_cpn_id
                    from BGT_B_CPN_PLAN_YEAR t 
                    where t.BUDGET_YEAR = V_BUDGET_YEAR
                    --and t.budget_cpn_id = V_BUDGET_CPN_ID
                  )
          loop
             execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
             --单位年主表             
             execute immediate 'insert into BGT_B_CPN_YEAR_EXE(id,budget_year,budget_cpn_id,budget_contents_id)
             select '''||V_NEW_GUID||''','''||config.budget_year||''','''||config.budget_cpn_id||''',''00120001''  
             from dual';
             --单位年明细表
              execute immediate 'insert into BGT_B_CPN_YEAR_EXE_D(id ,base_id,item_id,item_value,item_fact_value) 
              select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.item_value,0
                 from BGT_B_CPN_PLAN_YEAR_D t  where t.base_id ='''||config.id||'''';
             --更新编制区数据状态
             execute immediate ' update BGT_B_CPN_PLAN_YEAR set state = 4 where id = '''||config.id||'''';
          end loop;    
      
      for config in(
                    select t.id,
                    t.BUDGET_YEAR,
                    t.budget_cpn_id
                    from BGT_B_CPN_PLAN_MON t 
                    where t.BUDGET_YEAR = V_BUDGET_YEAR
                    --and t.budget_cpn_id = V_BUDGET_CPN_ID
                  )
          loop
            execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
            --单位月主表
            execute immediate 'insert into BGT_B_CPN_MON_EXE(id,budget_year,budget_cpn_id,budget_contents_id)
            select '''||V_NEW_GUID||''','''||config.BUDGET_YEAR||''','''||config.budget_cpn_id||''',''00120001''
            from dual';
            --单位月明细表
            execute immediate 'insert into BGT_B_CPN_MON_EXE_D(id ,base_id,item_id, m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value, 
                                      m_1_fact_value,
                                      m_2_fact_value,
                                      m_3_fact_value,
                                      m_4_fact_value,
                                      m_5_fact_value,
                                      m_6_fact_value,
                                      m_7_fact_value,
                                      m_8_fact_value,
                                      m_9_fact_value,
                                      m_10_fact_value,
                                      m_11_fact_value,
                                      m_12_fact_value) 
            select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value,0,0,0,0,0,0,0,0,0,0,0,0
               from BGT_B_CPN_PLAN_MON_D t  where t.base_id ='''||config.id||'''';  
            execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
            --单位月历史表         
            execute immediate 'insert into BGT_B_CPN_HIS_DATA(id,budget_year,budget_cpn_id,budget_contents_id,state)
            select '''||V_NEW_GUID||''','''||config.BUDGET_YEAR||''','''||config.budget_cpn_id||''',''00120001'',4 
            from dual';
            --单位月历史明细表  
            execute immediate 'insert into BGT_B_CPN_HIS_DATA_D(id,base_id,item_id, m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value)
            select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value
            from BGT_B_CPN_PLAN_MON_D t  where t.base_id ='''||config.id||'''';
            --更新编制区数据状态
            execute immediate ' update BGT_B_CPN_PLAN_MON set state = 4 where id = '''||config.id||'''';
          end loop;
      for config in(
                    select t.id,
                    t.BUDGET_YEAR,
                    t.budget_dept_id
                    from BGT_B_DEPT_PLAN_YEAR t 
                    where t.BUDGET_YEAR = V_BUDGET_YEAR
                  )
          loop
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              --科室年主表
              execute immediate 'insert into BGT_B_DEPT_YEAR_EXE(id,budget_year,budget_cpn_id,budget_contents_id,budget_dept_id)
              select '''||V_NEW_GUID||''','''||config.budget_year||''','''||V_BUDGET_CPN_ID||''',''00120001'','''||config.budget_dept_id||'''
              from dual';
              --科室年明细表
               execute immediate 'insert into BGT_B_DEPT_YEAR_EXE_D(id ,base_id,item_id,item_value,item_fact_value) 
              select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.item_value,0
                 from BGT_B_DEPT_PLAN_YEAR_D t  where t.base_id ='''||config.id||'''';
              --更新编制区数据状态
              execute immediate ' update BGT_B_DEPT_PLAN_YEAR set state = 4 where id = '''||config.id||'''';
          end loop; 
          for config in(
                    select t.id,
                    t.BUDGET_YEAR,
                    t.budget_dept_id
                    from BGT_B_DEPT_PLAN_MON t 
                    where t.BUDGET_YEAR = V_BUDGET_YEAR
                  )
          loop
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              --科室月主表
              execute immediate 'insert into BGT_B_DEPT_MON_EXE(id,budget_year,budget_cpn_id,budget_contents_id,budget_dept_id)
              select '''||V_NEW_GUID||''','''||config.budget_year||''','''||V_BUDGET_CPN_ID||''',''00120001'','''||config.budget_dept_id||'''
              from dual';
              --科室月明细表    
              execute immediate 'insert into BGT_B_DEPT_MON_EXE_D(id ,base_id,item_id, m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value,
                                      m_1_fact_value,
                                      m_2_fact_value,
                                      m_3_fact_value,
                                      m_4_fact_value,
                                      m_5_fact_value,
                                      m_6_fact_value,
                                      m_7_fact_value,
                                      m_8_fact_value,
                                      m_9_fact_value,
                                      m_10_fact_value,
                                      m_11_fact_value,
                                      m_12_fact_value) 
              select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t. m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value,0,0,0,0,0,0,0,0,0,0,0,0
                 from BGT_B_DEPT_PLAN_MON_D t  where t.base_id ='''||config.id||'''';  
              execute immediate 'select sys_guid() from dual' into V_NEW_GUID;
              --科室月历史表
              execute immediate 'insert into BGT_B_DEPT_HIS_DATA(id,budget_year,budget_dept_id,budget_contents_id,state)
              select '''||V_NEW_GUID||''','''||config.BUDGET_YEAR||''','''||config.budget_dept_id||''',''00120001'',4 
              from dual';
              --科室月历史明细表 
              execute immediate 'insert into BGT_B_DEPT_HIS_DATA_D(id,base_id,item_id, m_1_value,
                                      m_2_value,
                                      m_3_value,
                                      m_4_value,
                                      m_5_value,
                                      m_6_value,
                                      m_7_value,
                                      m_8_value,
                                      m_9_value,
                                      m_10_value,
                                      m_11_value,
                                      m_12_value)
              select sys_guid(),'''||V_NEW_GUID||''',t.item_id,t.m_1_value,
                                      t.m_2_value,
                                      t.m_3_value,
                                      t.m_4_value,
                                      t.m_5_value,
                                      t.m_6_value,
                                      t.m_7_value,
                                      t.m_8_value,
                                      t.m_9_value,
                                      t.m_10_value,
                                      t.m_11_value,
                                      t.m_12_value
              from BGT_B_DEPT_PLAN_MON_D t  where t.base_id ='''||config.id||'''';
              --更新编制区数据状态
              execute immediate ' update BGT_B_DEPT_PLAN_MON set state = 4 where id = '''||config.id||'''';
         end loop;
         --更新当前记录的数据状态
         execute immediate 'update BGT_B_BUDGET_DATA set state = 4 where id='''||p_dataid||'''';
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_pub_plan_data;


create or replace procedure SP_bgt_pub_plan_fact_data(p_factid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_DYNCOLUMN varchar2(36);
V_NEW_GUID varchar2(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
   1、从BGT_B_DEPT_PLAN_MON_FACT按计划指标和预算内容数据类型更新到BGT_B_DEPT_MON_EXE（科室月）
   2、从BGT_B_DEPT_MON_EXE（科室月）汇总更新到BGT_B_DEPT_YEAR_EXE（科室年）
   3、从BGT_B_DEPT_MON_EXE（科室月）汇总更新到BGT_B_CPN_MON_EXE（单位月）
   4、从BGT_B_DEPT_YEAR_EXE（科室年）汇总更新到BGT_B_CPN_YEAR_EXE（单位年）
   5、修改BGT_B_DEPT_PLAN_MON_FACT状态为归档
*/
begin
      --1、从BGT_B_DEPT_PLAN_MON_FACT按计划指标和预算内容数据类型更新到BGT_B_DEPT_MON_EXE（科室月）
      for config in(
                    select
                    t2.id,
                    t2.item_id,
                    t2.fact_value,
                    t.BUDGET_DEPT_ID,
                    t.finance_cycle
                    from  BGT_B_DEPT_PLAN_MON_FACT t,BGT_B_DEPT_PLAN_MON_FACT_D t2
                    where t2.base_id = t.id
                    and t.id = p_factid
                  )
       loop
                  --计算要更新的目标列
                  select
                  'm_'||decode(substr(config.finance_cycle,5,1),'1',substr(config.finance_cycle,5,2),substr(config.finance_cycle,6,1))||
                  '_fact_value' into V_DYNCOLUMN from dual;
                  dbms_output.put_line(V_DYNCOLUMN);
                  --更新预算内容为事业计划的数据,更新形式为覆写
                   execute immediate '
                  update BGT_B_DEPT_MON_EXE_D t1 set
                  t1.'||V_DYNCOLUMN||' = '||config.fact_value||'
                  where t1.item_id = '''||config.item_id||'''
                  and t1.base_id = (
                      select b.id from BGT_B_DEPT_MON_EXE b where b.budget_dept_id =
                      '''||config.budget_dept_id||'''
                      and b.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr('''||config.finance_cycle||''',0,4))
                      and BUDGET_CONTENTS_ID = ''00120001''
                  )';
       end loop;
      --2、从BGT_B_DEPT_MON_EXE（科室月）汇总更新到BGT_B_DEPT_YEAR_EXE（科室年）
      for config in(
                    select
                              t2.item_id,
                              (t2.m_1_fact_value + t2.m_2_fact_value + t2.m_3_fact_value +
                              t2.m_4_fact_value + t2.m_5_fact_value + t2.m_6_fact_value +
                              t2.m_7_fact_value + t2.m_8_fact_value + t2.m_9_fact_value +
                              t2.m_10_fact_value + t2.m_11_fact_value + t2.m_12_fact_value) as fact_value,
                              t3.finance_cycle,
                              t.BUDGET_DEPT_ID,
                              t.BUDGET_CONTENTS_ID
                    from  BGT_B_DEPT_MON_EXE t,BGT_B_DEPT_MON_EXE_D t2,BGT_B_DEPT_PLAN_MON_FACT t3
                    where t2.base_id = t.id
                    and t3.id = p_factid
                    and t3.budget_dept_id = t.budget_dept_id
                    and t.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr(t3.finance_cycle,0,4))
                  )
       loop
                   --更新形式为覆写
                   update BGT_B_DEPT_YEAR_EXE_D t
                   set t.item_fact_value = config.fact_value
                   where t.base_id =
                   (
                         select b.id from BGT_B_DEPT_YEAR_EXE b
                         where b.budget_year =
                               (select id from
                                       bgt_d_budget_year
                                where  budget_year=substr(config.finance_cycle,0,4)
                                )
                         and b.budget_dept_id = config.BUDGET_DEPT_ID
                         and b.budget_contents_id = config.budget_contents_id
                    )
                   and t.item_id =  config.item_id;
       end loop;
       --3、从BGT_B_DEPT_MON_EXE（科室月）汇总更新到BGT_B_CPN_MON_EXE（单位月）
      for config in(
                    select
                    t2.item_id,
                    sum(t2.m_1_fact_value + t2.m_2_fact_value + t2.m_3_fact_value +
                    t2.m_4_fact_value + t2.m_5_fact_value + t2.m_6_fact_value +
                    t2.m_7_fact_value + t2.m_8_fact_value + t2.m_9_fact_value +
                    t2.m_10_fact_value + t2.m_11_fact_value + t2.m_12_fact_value) as fact_value,
                    t3.finance_cycle,
                    t.BUDGET_DEPT_ID,
                    t.BUDGET_CONTENTS_ID
                    from  BGT_B_DEPT_MON_EXE t,BGT_B_DEPT_MON_EXE_D t2,BGT_B_DEPT_PLAN_MON_FACT t3
                    where t2.base_id = t.id
                    and t3.id = p_factid
                    and t3.budget_dept_id = t.budget_dept_id
                    and t.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr(t3.finance_cycle,0,4))
                    group by t2.item_id,t3.finance_cycle,t.BUDGET_DEPT_ID,t.BUDGET_CONTENTS_ID
                  )
       loop
                    --计算要更新的目标列
                  select
                  'm_'||decode(substr(config.finance_cycle,5,1),'1',substr(config.finance_cycle,5,2),substr(config.finance_cycle,6,1))||
                  '_fact_value' into V_DYNCOLUMN from dual;
                  --更新预算内容为事业计划的数据,更新形式为覆写
                  execute immediate '
                  update BGT_B_CPN_MON_EXE_D t1 set
                  t1.'||V_DYNCOLUMN||' = '||config.fact_value||'
                  where t1.item_id = '''||config.item_id||'''
                  and t1.base_id = (
                      select b.id from BGT_B_CPN_MON_EXE b where
                      b.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr('''||config.finance_cycle||''',0,4))
                      and BUDGET_CONTENTS_ID = ''00120001''
                  )';
       end loop;
       --4、从BGT_B_DEPT_YEAR_EXE（科室年）汇总更新到BGT_B_CPN_YEAR_EXE（单位年）
       for config in(
                    select
                              t2.item_id,
                              sum(t2.item_fact_value) as fact_value,
                              t3.finance_cycle,
                              t.BUDGET_DEPT_ID,
                              t.BUDGET_CONTENTS_ID
                    from  BGT_B_DEPT_YEAR_EXE t,BGT_B_DEPT_YEAR_EXE_D t2,BGT_B_DEPT_PLAN_MON_FACT t3
                    where t2.base_id = t.id
                    and t3.id = p_factid
                    and t3.budget_dept_id = t.budget_dept_id
                    and t.budget_year = (select id from bgt_d_budget_year where BUDGET_YEAR = substr(t3.finance_cycle,0,4))
                    group by t2.item_id,t3.finance_cycle,t.BUDGET_DEPT_ID,t.BUDGET_CONTENTS_ID
                  )
       loop
                   --更新形式为覆写
                   update BGT_B_CPN_YEAR_EXE_D t
                   set t.item_fact_value = config.fact_value
                   where t.base_id =
                   (
                         select b.id from BGT_B_CPN_YEAR_EXE b
                         where b.budget_year =
                               (select id from
                                       bgt_d_budget_year
                                where  budget_year=substr(config.finance_cycle,0,4)
                                )
                         and b.budget_contents_id = config.budget_contents_id
                    )
                   and t.item_id =  config.item_id;
       end loop;
       --5、修改BGT_B_DEPT_PLAN_MON_FACT状态为归档
       execute immediate 'update BGT_B_DEPT_PLAN_MON_FACT set state = 4 where id = '''||p_factid||'''';
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_pub_plan_fact_data;



create or replace procedure SP_bgt_undo_dept_plan_year(p_planid in char,p_msg out varchar2,p_succeed out number ) as
V_DYNA_SQL clob;
V_EXEC_SQL clob;
V_STATE number(3);
V_PRE_BUDGET_YEAR char(36);
V_BUDGET_YEAR char(36);
V_BUDGET_DEPT_ID char(36);
V_BUDGET_TEMPLET_ID char(36);
V_BASE_ID char(36);
v_ErrorCode varchar2(1024);
v_ErrorMsg varchar2(1024);
v_CurrentUser varchar2(1024);
v_Information varchar2(1024);
/*
撤销科室年度计划,回滚bgt_b_budget_data_detail中写入的数据
*/
begin
    --变量初始化
    execute immediate '
    select BUDGET_YEAR,TEMPLET_ID,BUDGET_DEPT_ID from BGT_B_DEPT_PLAN_YEAR where id ='''||p_planid||''''
    into V_BUDGET_YEAR,V_BUDGET_TEMPLET_ID,V_BUDGET_DEPT_ID;
    --删除明细项
    execute immediate 'delete from bgt_b_budget_data_detail where ref_tab_name =''BGT_B_DEPT_PLAN_YEAR_D'' and ref_tab_id in
    (select id from BGT_B_DEPT_PLAN_YEAR_D where base_id = '''||p_planid||''')';
      p_msg:= '';
      p_succeed := 1;--返回成功
exception
      when others
        then
        v_ErrorCode := SQLCODE;
        v_ErrorMsg := SQLERRM;
        v_CurrentUser := USER;
        v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' || v_CurrentUser;
        p_msg:= '执行错误,自动回滚.';
        dbms_output.put_line('执行错误,自动回滚.');
        p_msg:= p_msg || '详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information;
        dbms_output.put_line('详细信息:'||'错误代码:'||v_ErrorCode||',错误消息:'||v_ErrorMsg||',日志信息:'||v_Information);
        /*写失败标志*/
        p_succeed := 0;
        rollback;
END SP_bgt_undo_dept_plan_year;





  
  --存储过程 预算数据进入执行区  
  create or replace procedure SP_BGT_ACTION_FUND_EXE(
                                                  p_msg     out varchar2,
                                                  p_succeed out number) as
  v_Num         number(10);
  v_ErrorCode   varchar2(1024);
  v_ErrorMsg    varchar2(1024);
  v_CurrentUser varchar2(1024);
  v_Information varchar2(1024);

begin
   select count(1) into v_Num from BGT_B_DEPT_FUND_EXE where BUDGET_YEAR=(select t.id from bgt_d_budget_year t where t.is_availabe=1 );

   if v_Num=0 then
  insert into BGT_B_DEPT_FUND_EXE
    (ID,
     Ref_Tab_Id,
      ref_tab_name,
     BUDGET_YEAR,
     BUDGET_DEPT_ID,
     DEPT_USER_ID,
     ITEM_NAME,
     BGT_D_BUDGET_ITEM_ID,
     FUND_MONEY,
     NEW_FUND_MONEY,
     IS_UPDATE_ITEM,
     FUND_TYPE_ID,
     DECALRE_CAUSE,
     STATE,
     COMMENTS,
     Create_User_Id,
     Create_Dept_Id,
     Create_Time,
     MODIFY_USER_ID,
     MODIFY_DEPT_ID,
     MODIFY_TIME,
     DATA_TIMESTAMP,
     DATA_ORGANISE_ID,
     code,
     NAME,
     FINANCE_IDEA,
     FREE_FIELD,
     FREE_FIELD2,
     FREE_FIELD3,
     CONTROL_MONEY,
     Is_Performance,
     Is_Fixed)
    select sys_guid(),
           ID,
           'BGT_B_DEPT_PAY_YEAR_FUND',
           BUDGET_YEAR,
           BUDGET_DEPT_ID,
           DEPT_USER_ID,
           ITEM_NAME,
           BGT_D_BUDGET_ITEM_ID,
           FUND_MONEY,
           FUND_MONEY,
           2,
           FUND_TYPE_ID,
           DECALRE_CAUSE,
           STATE,
           COMMENTS,
           Create_User_Id,
           Create_Dept_Id,
           Create_Time,
           MODIFY_USER_ID,
           MODIFY_DEPT_ID,
           MODIFY_TIME,
           DATA_TIMESTAMP,
           DATA_ORGANISE_ID,
           code,
           NAME,
           FINANCE_IDEA,
           FREE_FIELD,
           FREE_FIELD2,
           FREE_FIELD3,
           CONTROL_MONEY,
           Is_Performance,
           Is_Fixed
      from BGT_B_DEPT_PAY_YEAR_FUND;
    commit;
    end if;
  p_msg     := '';
  p_succeed := 1; --返回成功
exception
  when others then
    v_ErrorCode   := SQLCODE;
    v_ErrorMsg    := SQLERRM;
    v_CurrentUser := USER;
    v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' ||
                     v_CurrentUser;
    p_msg         := '执行错误,自动回滚.';
    dbms_output.put_line('执行错误,自动回滚.');
    p_msg := p_msg || '详细信息:' || '错误代码:' || v_ErrorCode || ',错误消息:' ||
             v_ErrorMsg || ',日志信息:' || v_Information;
    dbms_output.put_line('详细信息:' || '错误代码:' || v_ErrorCode || ',错误消息:' ||
                         v_ErrorMsg || ',日志信息:' || v_Information);
    /*写失败标志*/
    p_succeed := 0;
    rollback;
end SP_BGT_ACTION_FUND_EXE;


--在预算执行变更 增加预算经费，需要把预算经费增加到执行区
create or replace procedure SP_BGT_ACTION_FUND_UPDATE_EXE(
                                                  p_id      char,
                                                  p_msg     out varchar2,
                                                  p_succeed out number) as
  v_Num         number(10);
  v_ErrorCode   varchar2(1024);
  v_ErrorMsg    varchar2(1024);
  v_CurrentUser varchar2(1024);
  v_Information varchar2(1024);

begin
   select count(1) into v_Num from BGT_B_DEPT_FUND_EXE where REF_TAB_ID=p_id;

   if v_Num=0 then
  insert into BGT_B_DEPT_FUND_EXE
    (ID,
     Ref_Tab_Id,
      ref_tab_name,
     BUDGET_YEAR,
     BUDGET_DEPT_ID,
     DEPT_USER_ID,
     ITEM_NAME,
     BGT_D_BUDGET_ITEM_ID,
     FUND_MONEY,
     NEW_FUND_MONEY,
     IS_UPDATE_ITEM,
     FUND_TYPE_ID,
     DECALRE_CAUSE,
     STATE,
     COMMENTS,
     Create_User_Id,
     Create_Dept_Id,
     Create_Time,
     MODIFY_USER_ID,
     MODIFY_DEPT_ID,
     MODIFY_TIME,
     DATA_TIMESTAMP,
     DATA_ORGANISE_ID,
     code,
     NAME,
     FINANCE_IDEA,
     FREE_FIELD,
     FREE_FIELD2,
     FREE_FIELD3,
     CONTROL_MONEY,
     Is_Performance,
     Is_Fixed)
    select sys_guid(),
           ID,
           'BGT_B_DEPT_FUND_EXE_ADD_UPDATE',
           BUDGET_YEAR,
           BUDGET_DEPT_ID,
           DEPT_USER_ID,
           ITEM_NAME,
           BGT_D_BUDGET_ITEM_ID,
           FUND_MONEY,
           FUND_MONEY,
           1,
           FUND_TYPE_ID,
           DECALRE_CAUSE,
           STATE,
           COMMENTS,
           Create_User_Id,
           Create_Dept_Id,
           Create_Time,
           MODIFY_USER_ID,
           MODIFY_DEPT_ID,
           MODIFY_TIME,
           DATA_TIMESTAMP,
           DATA_ORGANISE_ID,
           code,
           NAME,
           FINANCE_IDEA,
           FREE_FIELD,
           FREE_FIELD2,
           FREE_FIELD3,
           CONTROL_MONEY,
           Is_Performance,
           Is_Fixed
      from BGT_B_DEPT_FUND_EXE_ADD_UPDATE where id=p_id;
    commit;
    end if;
  p_msg     := '';
  p_succeed := 1; --返回成功
exception
  when others then
    v_ErrorCode   := SQLCODE;
    v_ErrorMsg    := SQLERRM;
    v_CurrentUser := USER;
    v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' ||
                     v_CurrentUser;
    p_msg         := '执行错误,自动回滚.';
    dbms_output.put_line('执行错误,自动回滚.');
    p_msg := p_msg || '详细信息:' || '错误代码:' || v_ErrorCode || ',错误消息:' ||
             v_ErrorMsg || ',日志信息:' || v_Information;
    dbms_output.put_line('详细信息:' || '错误代码:' || v_ErrorCode || ',错误消息:' ||
                         v_ErrorMsg || ',日志信息:' || v_Information);
    /*写失败标志*/
    p_succeed := 0;
    rollback;
end SP_BGT_ACTION_FUND_UPDATE_EXE;


--把一上的数据 放入历史表中
create or replace procedure SP_BGT_ACTION_HISTORY(p_step_id in char,
                                                  p_msg     out varchar2,
                                                  p_succeed out number) as
  v_Num         number(10);
  v_ErrorCode   varchar2(1024);
  v_ErrorMsg    varchar2(1024);
  v_CurrentUser varchar2(1024);
  v_Information varchar2(1024);

begin
   select count(1) into v_Num from BGT_B_DEPT_PAY_YEAR_FUND_H h where STEP_ID=p_step_id and h.budget_year=(select ID from bgt_d_budget_year s where s.is_availabe=1 );

   if v_Num=0 then
  insert into BGT_B_DEPT_PAY_YEAR_FUND_H
    (ID,
     Ref_Tab_Id,
     BUDGET_YEAR,
     BUDGET_DEPT_ID,
     DEPT_USER_ID,
     ITEM_NAME,
     BGT_D_BUDGET_ITEM_ID,
     FUND_MONEY,
     FUND_TYPE_ID,
     DECALRE_CAUSE,
     STATE,
     COMMENTS,
     Create_User_Id,
     Create_Dept_Id,
     Create_Time,
     MODIFY_USER_ID,
     MODIFY_DEPT_ID,
     MODIFY_TIME,
     DATA_TIMESTAMP,
     DATA_ORGANISE_ID,
     code,
     NAME,
     FINANCE_IDEA,
     FREE_FIELD,
     FREE_FIELD2,
     FREE_FIELD3,
     CONTROL_MONEY,
     Is_Performance,
     Is_Fixed,
     STEP_ID)
    select sys_guid(),
           ID,
           BUDGET_YEAR,
           BUDGET_DEPT_ID,
           DEPT_USER_ID,
           ITEM_NAME,
           BGT_D_BUDGET_ITEM_ID,
           FUND_MONEY,
           FUND_TYPE_ID,
           DECALRE_CAUSE,
           STATE,
           COMMENTS,
           Create_User_Id,
           Create_Dept_Id,
           Create_Time,
           MODIFY_USER_ID,
           MODIFY_DEPT_ID,
           MODIFY_TIME,
           DATA_TIMESTAMP,
           DATA_ORGANISE_ID,
           code,
           NAME,
           FINANCE_IDEA,
           FREE_FIELD,
           FREE_FIELD2,
           FREE_FIELD3,
           CONTROL_MONEY,
           Is_Performance,
           Is_Fixed,
           p_step_id
      from BGT_B_DEPT_PAY_YEAR_FUND;
  insert into BGT_B_DEPT_PAY_YEAY_D_FUND_H
    (ID,
     ref_tab_id,
     BASE_ID,
     ASSET_ID,
     ASSET_NAME,
     PRICE,
     AMOUNT,
     BUILDING_NAME,
     COMPLETE_TIME,
     FUND_NAME,
     MONEY,
     DECLARE_CAUSE,
     BGT_D_ACCOUNT_ITEM_ID,
     ACCOUNT_ITEM_ID,
     FINANCE_IDEA,
     FREE_FIELD,
     FREE_FIELD2,
     FREE_FIELD3,
     CONTROL_MONEY,
     Step_id)
    select sys_guid(),
           ID,
           BASE_ID,
           ASSET_ID,
           ASSET_NAME,
           PRICE,
           AMOUNT,
           BUILDING_NAME,
           COMPLETE_TIME,
           FUND_NAME,
           MONEY,
           DECLARE_CAUSE,
           BGT_D_ACCOUNT_ITEM_ID,
           ACCOUNT_ITEM_ID,
           FINANCE_IDEA,
           FREE_FIELD,
           FREE_FIELD2,
           FREE_FIELD3,
           CONTROL_MONEY,
           p_step_id
      from BGT_B_DEPT_PAY_YEAY_D_FUND;


    commit;
    end if;
  p_msg     := '';
  p_succeed := 1; --返回成功
exception
  when others then
    v_ErrorCode   := SQLCODE;
    v_ErrorMsg    := SQLERRM;
    v_CurrentUser := USER;
    v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' ||
                     v_CurrentUser;
    p_msg         := '执行错误,自动回滚.';
    dbms_output.put_line('执行错误,自动回滚.');
    p_msg := p_msg || '详细信息:' || '错误代码:' || v_ErrorCode || ',错误消息:' ||
             v_ErrorMsg || ',日志信息:' || v_Information;
    dbms_output.put_line('详细信息:' || '错误代码:' || v_ErrorCode || ',错误消息:' ||
                         v_ErrorMsg || ',日志信息:' || v_Information);
    /*写失败标志*/
    p_succeed := 0;
    rollback;
end SP_BGT_ACTION_HISTORY;


--预算系统  增加新的预算年份  1.复制预算部门 2.复制预算科目 3.复制预算部门对应预算科目 
create or replace procedure SP_BGT_NEW_BUDGET_YEAR(p_old_year_id char,
                                                   p_new_year_id char,
                                                   p_msg         out varchar2,
                                                   p_succeed     out number) as
  v_count number;  
  v_str         varchar2(4000);
  v_ErrorCode   varchar2(1024);
  v_ErrorMsg    varchar2(1024);
  v_CurrentUser varchar2(1024);
  v_Information varchar2(1024);

begin
  select count(1) into v_count from user_tables t where t.TABLE_NAME='TEM_BGT_D_BUDGET_DEPT';
  if v_count>0 then  
  execute immediate ' drop table TEM_BGT_D_BUDGET_DEPT';  -- 这里表名也要大写  
 end if;  
 v_str:=' Create Global Temporary Table tem_bgt_d_budget_dept(dept_old_id char(36),dept_new_id char(36),v_type number) On Commit Delete Rows';
 dbms_output.put_line(v_str);
 execute immediate v_str; 
  dbms_output.put_line('开始');
  --插入部门预算表 2018年的预算部门
 v_str:='begin insert into tem_bgt_d_budget_dept
    (dept_old_id, dept_new_id, v_type)
    select dt.id, sys_guid(), 1
      from bgt_d_budget_dept dt
     where dt.budget_year ='''|| p_old_year_id||'''
    dt.id in (select exe.budget_dept_id
                          from bgt_b_dept_fund_exe exe
                         where exe.budget_year ='''|| p_old_year_id||''');;
  insert into BGT_D_BUDGET_DEPT
    (ID,
     BUDGET_YEAR,
     CODE,
     NAME,
     DEPT_PROPERTY_ID,
     DEPT_TYPE_ID,
     IS_FUNCTION,
     STATE,
     COMMENTS,
     CREATE_USER_ID,
     CREATE_DEPT_ID,
     CREATE_TIME,
     MODIFY_USER_ID,
     MODIFY_DEPT_ID,
     MODIFY_TIME,
     DATA_TIMESTAMP,
     DATA_ORGANISE_ID,
     CPN_ID,
     DEPT_ID)
    select tmp_dept.dept_new_id, --新预算部门ID
           '''||p_new_year_id||''', --新的预算年 2018
           de.CODE,
           de.NAME,
           de.DEPT_PROPERTY_ID,
           de.DEPT_TYPE_ID,
           de.IS_FUNCTION,
           de.STATE,
           de.COMMENTS,
           de.CREATE_USER_ID,
           de.CREATE_DEPT_ID,
           de.CREATE_TIME,
           de.MODIFY_USER_ID,
           de.MODIFY_DEPT_ID,
           de.MODIFY_TIME,
           de.DATA_TIMESTAMP,
           de.DATA_ORGANISE_ID,
           de.CPN_ID,
           de.DEPT_ID
      from BGT_D_BUDGET_DEPT de
     inner join tem_bgt_d_budget_dept tmp_dept
        on de.id = tmp_dept.dept_old_id
     where tmp_dept.v_type = 1;

  insert into tem_bgt_d_budget_dept
    (dept_old_id, dept_new_id, v_type)
    select dt.id, sys_guid(), 2
      from BGT_D_BUDGET_ITEM dt
     where dt.budget_year ='''||p_old_year_id||''';
  insert into BGT_D_BUDGET_ITEM
    (ID,
     BUDGET_YEAR,
     CODE,
     NAME,
     ITEM_TYPE_ID,
     PREPARE_PATTERN_ID,
     IMPORT_TYPE_ID,
     DATA_TYPE_ID,
     IS_CARRYOVER,
     IS_MERGE,
     IS_END,
     USAGE_ID,
     PARENT_ID,
     STATE,
     COMMENTS,
     CREATE_USER_ID,
     CREATE_DEPT_ID,
     CREATE_TIME,
     MODIFY_USER_ID,
     MODIFY_DEPT_ID,
     MODIFY_TIME,
     DATA_TIMESTAMP,
     DATA_ORGANISE_ID)
    select tem_bgt_d_budget_dept.dept_new_id,
           '''||p_new_year_id||''',
           ditem.CODE,
           ditem.NAME,
           ditem.ITEM_TYPE_ID,
           ditem.PREPARE_PATTERN_ID,
           ditem.IMPORT_TYPE_ID,
           ditem.DATA_TYPE_ID,
           ditem.IS_CARRYOVER,
           ditem.IS_MERGE,
           ditem.IS_END,
           ditem.USAGE_ID,
           (select dept_new_id
              from tem_bgt_d_budget_dept sd
             where sd.dept_old_id = ditem.parent_id) parent_id,
           ditem.STATE,
           ditem.COMMENTS,
           ditem.CREATE_USER_ID,
           ditem.CREATE_DEPT_ID,
           ditem.CREATE_TIME,
           ditem.MODIFY_USER_ID,
           ditem.MODIFY_DEPT_ID,
           ditem.MODIFY_TIME,
           ditem.DATA_TIMESTAMP,
           ditem.DATA_ORGANISE_ID
      from BGT_D_BUDGET_ITEM ditem
     inner join tem_bgt_d_budget_dept
        on ditem.id = tem_bgt_d_budget_dept.dept_old_id
     where tem_bgt_d_budget_dept.v_type = 2
       and ditem.id in (select exe.bgt_d_budget_item_id
                          from bgt_b_dept_fund_exe exe
                         where exe.budget_year ='''|| p_old_year_id||''');
  --插入科目和预算部门对应表
  insert into BGT_D_BUDGET_DEPT_BUDGET_ITEM
    (ID, BASE_ID, BUDGET_ITEM_ID)
    select sys_guid(), t_d.dept_new_id, t_d2.dept_new_id
      from BGT_D_BUDGET_DEPT_BUDGET_ITEM t
     inner join tem_bgt_d_budget_dept t_d
        on t.base_id = t_d.dept_old_id
       and t_d.v_type = 1
     inner join tem_bgt_d_budget_dept t_d2
        on t.budget_item_id = t_d2.dept_old_id
       and t_d2.v_type = 2;commit; end;';
       dbms_output.put_line(v_str);
 execute immediate v_str; 
 -- commit;
  p_msg     := '';
  p_succeed := 1; --返回成功
exception
  when others then
    v_ErrorCode   := SQLCODE;
    v_ErrorMsg    := SQLERRM;
    v_CurrentUser := USER;
    v_Information := '遇到了错误 ' || TO_CHAR(SYSDATE) || ' 数据库用户 ' ||
                     v_CurrentUser;
    p_msg         := '执行错误,自动回滚.';
    dbms_output.put_line('执行错误,自动回滚.');
    p_msg := p_msg || '详细信息:' || '错误代码:' || v_ErrorCode || ',错误消息:' ||
             v_ErrorMsg || ',日志信息:' || v_Information;
    dbms_output.put_line('详细信息:' || '错误代码:' || v_ErrorCode || ',错误消息:' ||
                         v_ErrorMsg || ',日志信息:' || v_Information);
    /*写失败标志*/
    p_succeed := 0;
    rollback;
end SP_BGT_NEW_BUDGET_YEAR;



--通用类型 
insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_0001                            ', 'BGT_0001', '经费类别', '0000                                ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_000101                          ', 'BGT_000101', '一般项目预算', 'BGT_0001                            ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_000102                          ', 'BGT_000102', '资本运算', 'BGT_0001                            ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_00010201                        ', 'BGT_00010201', '基建及修缮资本预算', 'BGT_000102                          ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_00010202                        ', 'BGT_00010202', '资产购置预算', 'BGT_000102                          ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_0002                            ', 'BGT_0002', '人事类型', '0000                                ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_000201                          ', 'BGT_000201', '在职人员', 'BGT_0002                            ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_000202                          ', 'BGT_000202', '离休人员', 'BGT_0002                            ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_000203                          ', 'BGT_000203', '退休人员', 'BGT_0002                            ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_000204                          ', 'BGT_000204', '其他人员', 'BGT_0002                            ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_0003                            ', 'BGT_0003', '收入类型', '0000                                ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_00030001                        ', 'BGT_00030001', '门诊医疗收入', 'BGT_0003                            ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_00030002                        ', 'BGT_00030002', '住院医疗收入', 'BGT_0003                            ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_00030003                        ', 'BGT_00030003', '其他收入', 'BGT_0003                            ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_00030004                        ', 'BGT_00030004', '科研项目收入', 'BGT_0003                            ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);

insert into com_type (ID, CODE, NAME, PARENT_ID, CREATE_USER_ID, CREATE_TIME, CREATE_DEPART_ID, MODIFY_USER_ID, MODIFY_TIME, MODIFY_DEPART_ID, DATA_TIMESTAMP, DATA_ORGANISE_ID, DISPLAY_INDEX, SHORT_NAME, COMMENTS, STATE, SPELL_CODE, FIVE_STROKE_CODE)
values ('BGT_00030005                        ', 'BGT_00030005', '教学项目收入', 'BGT_0003                            ', null, null, null, null, null, null, null, null, null, null, null, null, null, null);


--角色和菜单设置
insert into com_module(id,code,name,system_id,display_index,state)values('HRP_BGT_MODULE_ZC001','KJH','经费支出预算','17b26e29-7a6f-4bc4-b155-0466e9da8350',1,1);
insert into com_module(id,code,name,system_id,display_index,state)values('HRP-BGT-MODU-I4','KJH','收入预算','17b26e29-7a6f-4bc4-b155-0466e9da8350',3,1);
insert into com_module(id,code,name,system_id,display_index,state)values('HRP-BGT-MODU-I5  ','KJH','收入结余','17b26e29-7a6f-4bc4-b155-0466e9da8350',4,1);
insert into com_module(id,code,name,system_id,display_index,state)values('HRP_BGT_MODULE_I6','KJH','人员基础信息','17b26e29-7a6f-4bc4-b155-0466e9da8350',5,1);
insert into com_module(id,code,name,system_id,display_index,state)values('HRP-BGT-MODU-I7','KJH','预算控制','17b26e29-7a6f-4bc4-b155-0466e9da8350',2,1);
insert into com_module(id,code,name,system_id,display_index,state)values('HRP-BGT-MODU-I8','KJH','预算调整_NEW','17b26e29-7a6f-4bc4-b155-0466e9da8350',2,1);

insert into com_function(id,name,display_index,state,module_id)values('HRP_BGT_MODULE_FUN_ZC001','经费支出预算',1,1,'HRP_BGT_MODULE_ZC001');
insert into com_function(id,name,display_index,state,module_id)values('HRP_BGT_MODULE_I6_1','人员基础信息',1,1,'HRP_BGT_MODULE_I6');

insert into com_function(id,name,display_index,state,module_id)values('HRP-BGT-MODU-I4-F-1','医疗收入预算',1,1,'HRP-BGT-MODU-I4');
insert into com_function(id,name,display_index,state,module_id)values('HRP-BGT-MODU-I4-F-2','其他收入预算',2,1,'HRP-BGT-MODU-I4');
insert into com_function(id,name,display_index,state,module_id)values('HRP-BGT-MODU-I4-F-3','科教项目收入预算',3,1,'HRP-BGT-MODU-I4');
insert into com_function(id,name,display_index,state,module_id)values('HRP-BGT-MODU-I4-F-4','财政补助收入预算',4,1,'HRP-BGT-MODU-I4');

insert into com_function(id,name,display_index,state,module_id)values('HRP-BGT-MODU-I5-F-1','收入结余',1,1,'HRP-BGT-MODU-I5');
insert into com_function(id,name,display_index,state,module_id)values('HRP-BGT-MODU-I7-F-1','预算控制',1,1,'HRP-BGT-MODU-I7');
insert into com_function(id,name,display_index,state,module_id)values('HRP-BGT-MODU-I8-F-1','预算调整_new',1,1,'HRP-BGT-MODU-I8');

insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP_BGT_MODULE_FUN_FORM_001','一般经费预算','modules/BGT_PAY/PageObject_BGT_B_DEPT_PAY_YEAR_FUND_1.aspx',1,1,'HRP_BGT_MODULE_FUN_ZC001');

insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP_BGT_MODULE_FUN_FORM_002','基建及修缮预算','modules/BGT_PAY/PageObject_BGT_B_DEPT_PAY_YEAR_FUND_2.aspx',1,1,'HRP_BGT_MODULE_FUN_ZC001');

insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP_BGT_MODULE_FUN_FORM_003','资产购置预算','modules/BGT_PAY/PageObject_BGT_B_DEPT_PAY_YEAR_FUND_3.aspx',1,1,'HRP_BGT_MODULE_FUN_ZC001');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP_BGT_MODULE_FUN_FORM_004','一般经费预算','modules/BGT_PAY/PageObject_BGT_B_DEPT_PAY_YEAR_FUND_f1.aspx',1,1,'HRP_BGT_MODULE_FUN_ZC001');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP_BGT_MODULE_FUN_FORM_005','基建及修缮预算','modules/BGT_PAY/PageObject_BGT_B_DEPT_PAY_YEAR_FUND_f2.aspx',1,1,'HRP_BGT_MODULE_FUN_ZC001');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP_BGT_MODULE_FUN_FORM_006','资产购置预算','modules/BGT_PAY/PageObject_BGT_B_DEPT_PAY_YEAR_FUND_f3.aspx',1,1,'HRP_BGT_MODULE_FUN_ZC001');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP_BGT_MODULE_FUN_FORM_007','人员经费预算','modules/BGT_PAY_NEW/PageObject_BGT_B_CPN_INC_PERSONFUND.aspx',1,1,'HRP_BGT_MODULE_FUN_ZC001');


insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP_BGT_MODULE_I6_1_1','科室人员信息','modules/bgt_pay/PageObject_BGT_B_PAY_PERSON.aspx',1,1,'HRP_BGT_MODULE_I6_1');

insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I4-F-1-P-1','门诊收入预算','modules/BGT_INC/PageObject_BGT_B_CPN_INC_MEDICAL.aspx',1,1,'HRP-BGT-MODU-I4-F-1');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I4-F-1-P-2','住院收入预算','modules/BGT_INC/PageObject_BGT_B_CPN_INC_MEDICAL2.aspx',2,1,'HRP-BGT-MODU-I4-F-1');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I4-F-2-P-1','其他收入预算','modules/BGT_INC/PageObject_BGT_B_CPN_INC_MEDICAL3.aspx',1,1,'HRP-BGT-MODU-I4-F-2');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I4-F-3-P-1','科研项目收入预算','modules/BGT_INC/PageObject_BGT_B_CPN_INC_MEDICAL_SCI.aspx',1,1,'HRP-BGT-MODU-I4-F-3');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I4-F-3-P-2','教学项目收入预算','modules/BGT_INC/PageObject_BGT_B_CPN_INC_MEDICAL_EDU.aspx',2,1,'HRP-BGT-MODU-I4-F-3');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I4-F-4-P-1','基本支出','modules/BGT_INC/PageObject_BGT_B_CPN_INC_BASIC.aspx',1,1,'HRP-BGT-MODU-I4-F-4');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I4-F-4-P-2','项目支出','modules/BGT_INC/PageObject_BGT_B_CPN_INC_PROJECT.aspx',2,1,'HRP-BGT-MODU-I4-F-4');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I5-F-1-P-1   ','收入结余','modules/BGT_INC/PageObject_BGT_B_INC_LEFT.aspx',1,1,'HRP-BGT-MODU-I5-F-1');


insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I7-F-1-P-1','一般经费预算','modules/BGT_PAY_NEW/PageObject_BGT_B_DEPT_PAY_YEAR_FUND_S1.aspx',1,1,'HRP-BGT-MODU-I7-F-1');

insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I7-F-1-P-2','基建及修缮预算','modules/BGT_PAY_NEW/PageObject_BGT_B_DEPT_PAY_YEAR_FUND_S2.aspx',2,1,'HRP-BGT-MODU-I7-F-1');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I7-F-1-P-3','资产购置预算','modules/BGT_PAY_NEW/PageObject_BGT_B_DEPT_PAY_YEAR_FUND_S3.aspx',3,1,'HRP-BGT-MODU-I7-F-1');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I7-F-1-P-4','一般经费预算','modules/BGT_PAY_NEW/PageObject_BGT_B_DEPT_PAY_YEAR_FUND_SF1.aspx',4,1,'HRP-BGT-MODU-I7-F-1');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I7-F-1-P-5','基建及修缮预算','modules/BGT_PAY_NEW/PageObject_BGT_B_DEPT_PAY_YEAR_FUND_SF2.aspx',5,1,'HRP-BGT-MODU-I7-F-1');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I7-F-1-P-6','资产购置预算','modules/BGT_PAY_NEW/PageObject_BGT_B_DEPT_PAY_YEAR_FUND_SF3.aspx',6,1,'HRP-BGT-MODU-I7-F-1');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I8-F-1-P-1','经费金额变更','modules/BGT_ADJUST_NEW/PageObject_BGT_B_ADJUST_EXE.aspx',1,1,'HRP-BGT-MODU-I8-F-1');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I8-F-1-P-2','一般经费预算变更','modules/BGT_ADJUST_NEW/PageObject_BGT_B_DEPT_FUND_EXE_ADD_UPDATE_1.aspx',2,1,'HRP-BGT-MODU-I8-F-1');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I8-F-1-P-3','基建及修缮变更','modules/BGT_ADJUST_NEW/PageObject_BGT_B_DEPT_FUND_EXE_ADD_UPDATE_2.aspx',3,1,'HRP-BGT-MODU-I8-F-1');
insert into com_form(id,name,default_page_url,display_index,state,function_id)values('HRP-BGT-MODU-I8-F-1-P-4','资产购置预算变更','modules/BGT_ADJUST_NEW/PageObject_BGT_B_DEPT_FUND_EXE_ADD_UPDATE_3.aspx',4,1,'HRP-BGT-MODU-I8-F-1');


insert into com_role(id,name,type)values('HRP_BGT_ROLE_1','财务预算',1);
insert into com_role(id,name,type)values('HRP_BGT_ROLE_2','科室一般预算',1);--一般经费预算 都可以
insert into com_role(id,name,type)values('HRP_BGT_ROLE_3','科室基建预算',1);--基建经费
insert into com_role(id,name,type)values('HRP_BGT_ROLE_4','科室购置预算',1);--购置预算经费

insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_1','HRP_BGT_ROLE_2','HRP_BGT_MODULE_FUN_FORM_001','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_2','HRP_BGT_ROLE_2','HRP-BGT-MODU-I7-F-1-P-1','01110000000000000000');

insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_3','HRP_BGT_ROLE_3','HRP-BGT-MODU-I7-F-1-P-2','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_4','HRP_BGT_ROLE_3','HRP_BGT_MODULE_FUN_FORM_002','01110000000000000000');

insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_5','HRP_BGT_ROLE_4','HRP-BGT-MODU-I7-F-1-P-3','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_6','HRP_BGT_ROLE_4','HRP_BGT_MODULE_FUN_FORM_003','01110000000000000000');

insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_7','HRP_BGT_ROLE_1','HRP_BGT_MODULE_FUN_FORM_004','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_8','HRP_BGT_ROLE_1','HRP_BGT_MODULE_FUN_FORM_005','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_9','HRP_BGT_ROLE_1','HRP_BGT_MODULE_FUN_FORM_006','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_10','HRP_BGT_ROLE_1','HRP_BGT_MODULE_FUN_FORM_007','01110000000000000000');


insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_11','HRP_BGT_ROLE_1','HRP_BGT_MODULE_I6_1_1','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_12','HRP_BGT_ROLE_1','HRP-BGT-MODU-I4-F-1-P-1','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_13','HRP_BGT_ROLE_1','HRP-BGT-MODU-I4-F-1-P-2','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_14','HRP_BGT_ROLE_1','HRP-BGT-MODU-I4-F-2-P-1','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_15','HRP_BGT_ROLE_1','HRP-BGT-MODU-I4-F-3-P-1','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_16','HRP_BGT_ROLE_1','HRP-BGT-MODU-I4-F-3-P-2','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_17','HRP_BGT_ROLE_1','HRP-BGT-MODU-I4-F-4-P-1','01110000000000000000');

insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_18','HRP_BGT_ROLE_1','HRP-BGT-MODU-I4-F-4-P-2','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_19','HRP_BGT_ROLE_1','HRP-BGT-MODU-I5-F-1-P-1','01110000000000000000');

insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_20','HRP_BGT_ROLE_1','HRP-BGT-MODU-I7-F-1-P-4','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_21','HRP_BGT_ROLE_1','HRP-BGT-MODU-I7-F-1-P-5','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_22','HRP_BGT_ROLE_1','HRP-BGT-MODU-I7-F-1-P-6','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_23','HRP_BGT_ROLE_1','HRP-BGT-MODU-I8-F-1-P-1','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_24','HRP_BGT_ROLE_1','HRP-BGT-MODU-I8-F-1-P-2','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_25','HRP_BGT_ROLE_1','HRP-BGT-MODU-I8-F-1-P-3','01110000000000000000');
insert into com_role_m_form(id,role_id,form_id,control_code)values('HRP_BGT_R_F_26','HRP_BGT_ROLE_1','HRP-BGT-MODU-I8-F-1-P-4','01110000000000000000');


